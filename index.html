<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>××¢×¨×›×ª × ×™×”×•×œ - ××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap');
    body{font-family:'Assistant',sans-serif;background:#f8fafc;color:#0f172a}
    .sidebar-link{transition:.15s;border-radius:.75rem;margin-bottom:.25rem;display:flex;align-items:center;padding:.75rem 1rem;cursor:pointer}
    .sidebar-link:hover{background:#334155;color:#fff}
    .sidebar-link.active{background:#2563eb;color:#fff}
    .card{background:#fff;border-radius:1rem;box-shadow:0 4px 10px -6px rgb(0 0 0 / .18);padding:1.25rem}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .55rem;border-radius:999px;font-size:.75rem;font-weight:800}
    .fade-in{animation:fadeIn .25s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .progress-bar{transition:width .6s ease-out}
  </style>
</head>

<body class="flex h-screen overflow-hidden">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-slate-800 text-slate-300 flex flex-col shadow-2xl z-20 overflow-y-auto shrink-0">
    <div class="p-6 border-b border-slate-700">
      <h1 class="text-white text-xl font-bold tracking-tight">××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ</h1>
      <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest">× ×™×”×•×œ ×•×”×•×¦××” ×œ××•×¨</p>
    </div>

    <nav class="flex-1 p-4 space-y-1 text-sm">
      <div class="text-[10px] font-bold text-slate-500 px-4 mb-2 uppercase">× ×™×”×•×œ ×©×•×˜×£</div>
      <div class="nav-item sidebar-link active" data-tab="tasks" id="btn-tasks"><i class="fas fa-list-ul ml-3"></i> ××©×™××•×ª ×•×œ×•"×–</div>
      <div class="nav-item sidebar-link" data-tab="ideas" id="btn-ideas"><i class="fas fa-lightbulb ml-3"></i> ×¨×¢×™×•× ×•×ª ×¢×•×‘×“×™×</div>
      <div class="nav-item sidebar-link" data-tab="staff" id="btn-staff"><i class="fas fa-users-cog ml-3"></i> ×¢×•×‘×“×™ ×”××›×•×Ÿ</div>

      <div class="text-[10px] font-bold text-slate-500 px-4 mt-6 mb-2 uppercase">××¢×¨×š ×”×¡×¤×¨×™×</div>
      <div class="nav-item sidebar-link" data-tab="books-he" id="btn-books-he"><i class="fas fa-book ml-3"></i> ×¡×¤×¨×™× - ×¢×‘×¨×™×ª</div>
      <div class="nav-item sidebar-link" data-tab="books-en" id="btn-books-en"><i class="fas fa-language ml-3"></i> ××“×•×¨ ×× ×’×œ×™×ª</div>

      <div class="text-[10px] font-bold text-slate-500 px-4 mt-6 mb-2 uppercase">×›×¡×¤×™× ×•×œ×•×’×™×¡×˜×™×§×”</div>
      <div class="nav-item sidebar-link" data-tab="donors" id="btn-donors"><i class="fas fa-hand-holding-heart ml-3"></i> ×’×™×•×¡ ×›×¡×¤×™×</div>
      <div class="nav-item sidebar-link" data-tab="logistics" id="btn-logistics"><i class="fas fa-shipping-fast ml-3"></i> ×”×¤×¦×” ×•×—×•"×œ</div>
      <div class="nav-item sidebar-link" data-tab="expenses" id="btn-expenses"><i class="fas fa-file-invoice-dollar ml-3"></i> ×—×•×‘×•×ª ×œ×¡×¤×§×™×</div>
    </nav>

    <div class="p-4 bg-slate-900 border-t border-slate-700 space-y-3">
      <div>
        <p class="text-[10px] text-slate-500 mb-1 font-bold">×‘×¢×œ×•×ª ×”×¢××•×ª×”:</p>
        <p class="text-xs font-bold text-white">×××™×¨ ×©××—×” ×©×˜×™×™×Ÿ</p>
      </div>

      <button id="btn-reset" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-200 px-3 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center">
        <i class="fas fa-eraser ml-2"></i> × ×™×§×•×™ × ×ª×•× ×™× ×©××•×¨×™×
      </button>
      <p class="text-[10px] text-slate-500 leading-snug">* ××•×—×§ × ×ª×•× ×™× ××”×“×¤×“×¤×Ÿ (LocalStorage) ×•××—×–×™×¨ ×‘×¨×™×¨×ª ××—×“×œ.</p>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 flex flex-col min-w-0">
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm">
      <div class="flex items-center gap-3">
        <button id="btn-back" class="hidden bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-sm font-bold transition">
          <i class="fas fa-arrow-right ml-2"></i> ×—×–×¨×”
        </button>
        <h2 id="current-tab-title" class="text-lg font-bold text-slate-800">××©×™××•×ª ×•×œ×•"×– ×‘×™×¦×•×¢</h2>
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="btn-add" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transform active:scale-95 transition flex items-center">
          <i class="fas fa-plus ml-2"></i>
          <span id="add-btn-text">×”×•×¡×£ ××©×™××”</span>
        </button>

        <button id="btn-edit-data" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transform active:scale-95 transition">
          <i class="fas fa-edit ml-2"></i> ×¢×¨×•×š × ×ª×•× ×™×
        </button>

        <button id="btn-refresh" class="bg-slate-100 p-2 rounded-lg text-slate-500 hover:bg-slate-200 transition">
          <i class="fas fa-sync-alt" id="refresh-icon"></i>
        </button>
      </div>
    </header>

    <div id="main-area" class="p-8 overflow-y-auto h-full bg-slate-50">
      <div id="tab-content" class="space-y-6"></div>
    </div>
  </main>

  <!-- MODAL -->
  <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
      <div class="p-6 border-b bg-slate-50 flex items-center justify-between">
        <h3 id="modal-title" class="text-xl font-bold text-slate-800">×—×œ×•×Ÿ</h3>
        <button id="btn-close-modal" class="text-slate-400 hover:text-slate-700 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6 space-y-4 overflow-y-auto flex-1" id="modal-body"></div>
      <div class="p-6 bg-white border-t flex justify-end space-x-3 space-x-reverse">
        <button id="btn-cancel" class="px-6 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg transition">×‘×™×˜×•×œ</button>
        <button id="btn-submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-lg hover:bg-blue-700 transition">
          <i class="fas fa-check ml-2"></i> ×©××•×¨
        </button>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // STORAGE + UTILS
  // =========================
  const STORAGE_KEY = 'hoffman_admin_store_v2';
  const $ = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>[...root.querySelectorAll(q)];
  const uid = () => Math.random().toString(36).slice(2,10);
  const todayISO = () => new Date().toISOString().split('T')[0];
  const money = n => `â‚ª${Number(n||0).toLocaleString()}`;
  const escapeHtml = (str) => String(str ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#039;");
  const notify = (msg) => {
    const n = document.createElement('div');
    n.className = 'fixed top-10 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-8 py-3 rounded-lg shadow-2xl z-50 font-bold';
    n.innerHTML = `<i class="fas fa-check-circle ml-2"></i> ${escapeHtml(msg)}`;
    document.body.appendChild(n);
    setTimeout(()=>{ n.style.opacity='0'; n.style.transition='opacity .25s'; setTimeout(()=>n.remove(),260); }, 2200);
  };

  const saveStore = () => { try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }catch(e){} };
  const loadStore = () => { try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } };

  // =========================
  // DEFAULT STORE (×œ× ××—×§× ×• ××œ×× ×˜×™×)
  // =========================
  const defaultStore = {
    tasks: [
      { id: uid(), ××©×™××”:"×”×›× ×ª ×—×©×‘×•× ×•×ª ×œ×ª×•×¨××™× ×—×•×“×© ×–×”", ×× ×”×œ:"××©×” ×›×”×Ÿ", ×“×—×™×¤×•×ª:"×’×‘×•×”×”", ×˜×•×•×—:"×—×•×“×©×™" },
      { id: uid(), ××©×™××”:"×©×œ×™×—×ª ×¢×“×›×•×Ÿ ×œ×× ×•×™×™ ×”× ×™×•×–×œ×˜×¨", ×× ×”×œ:"×™×•×¡×™ ×œ×•×™", ×“×—×™×¤×•×ª:"×’×‘×•×”×”", ×˜×•×•×—:"×—×•×“×©×™" },
      { id: uid(), ××©×™××”:"×‘×™×§×•×¨ ××¦×œ ××•×´×œ ×‘× ×™ ×‘×¨×§", ×× ×”×œ:"×“×•×“ ×’×•×œ×“", ×“×—×™×¤×•×ª:"×’×‘×•×”×”", ×˜×•×•×—:"×—×•×“×©×™" },
      { id: uid(), ××©×™××”:"×ª×™××•× ×¤×’×™×©×ª ×ª×›× ×•×Ÿ ×©× ×” ×”×‘××”", ×× ×”×œ:"××©×” ×›×”×Ÿ", ×“×—×™×¤×•×ª:"×¨×’×™×œ×”", ×˜×•×•×—:"××¨×•×š" },
      { id: uid(), ××©×™××”:"×¢×“×›×•×Ÿ ××ª×¨ ×”××™× ×˜×¨× ×˜", ×× ×”×œ:"×™×•×¡×™ ×œ×•×™", ×“×—×™×¤×•×ª:"×¨×’×™×œ×”", ×˜×•×•×—:"××¨×•×š" }
    ],
    ideas: [
      { id: uid(), ×›×•×ª×¨×ª:"×œ×”×•×¡×™×£ ×“×£ × ×—×™×ª×” ×œ×ª×•×¨××™×", ×ª×™××•×¨:"×“×£ ×§×¦×¨ ×¢× QR ×œ×ª×¨×•××” ××”×™×¨×”", ××’×™×©:"×™×•×¡×™ ×œ×•×™", ×¡×˜×˜×•×¡:"×—×“×©", ×ª××¨×™×š: todayISO() },
      { id: uid(), ×›×•×ª×¨×ª:"×©×™×˜×ª ××¢×§×‘ ×”×“×¤×¡×•×ª", ×ª×™××•×¨:"×œ×¨×›×– ×”×“×¤×¡×•×ª ×œ×¤×™ ×©× ×”/×“×¤×•×¡/×”×¢×¨×•×ª", ××’×™×©:"×©×¨×” ×’×¨×™×Ÿ", ×¡×˜×˜×•×¡:"×‘×‘×“×™×§×”", ×ª××¨×™×š: todayISO() }
    ],
    staff: [
      { id: uid(), ×©×:"××©×” ×›×”×Ÿ", ×ª×¤×§×™×“:"×× ×”×œ ×›×œ×œ×™", ×˜×œ×¤×•×Ÿ:"050-1234567", ××™××™×™×œ:"moshe@hoffman.org" },
      { id: uid(), ×©×:"×™×•×¡×™ ×œ×•×™", ×ª×¤×§×™×“:"×× ×”×œ ×©×™×•×•×§", ×˜×œ×¤×•×Ÿ:"052-7654321", ××™××™×™×œ:"yossi@hoffman.org" },
      { id: uid(), ×©×:"×“×•×“ ×’×•×œ×“", ×ª×¤×§×™×“:"×œ×•×’×™×¡×˜×™×§×”", ×˜×œ×¤×•×Ÿ:"054-9876543", ××™××™×™×œ:"david@hoffman.org" },
      { id: uid(), ×©×:"×©×¨×” ×’×¨×™×Ÿ", ×ª×¤×§×™×“:"×¢×•×¨×›×ª ×¨××©×™×ª", ×˜×œ×¤×•×Ÿ:"050-5555555", ××™××™×™×œ:"sara@hoffman.org" }
    ],
    books: {
      he: [
        {
          id:"he-mechunach", name:"×”××—×•× ×š",
          progress:90, target:25000, raised:22500, donorsCount:15,
          identity:{ subtitle:"××”×“×•×¨×” ××ª×•×§× ×ª ×•××•×¨×—×‘×ª", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×›×¨×™×›×” ×§×©×”", notes:"" },
          printRuns:[ {year:2018, qty:4000, printer:"", notes:"×”×“×¤×¡×” ×¨××©×•× ×”"}, {year:2020, qty:7000, printer:"", notes:""} ],
          donors:[ { id: uid(), name:"××‘×¨×”× ×›×”×Ÿ", amount:5000, date:"2025-02-01", note:"×ª××™×›×” ×›×œ×œ×™×ª" } ]
        },
        { id:"he-yesodot", name:"×™×¡×•×“×•×ª ×”×—×™× ×•×š", progress:65, target:50000, raised:32500, donorsCount:12,
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
          printRuns:[{year:2021, qty:4000, printer:"", notes:""}], donors:[]
        },
        { id:"he-modaot", name:"××•×“×¢×•×ª", progress:82, target:40000, raised:32800, donorsCount:18,
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
          printRuns:[{year:2022, qty:5000, printer:"", notes:""}], donors:[]
        },
        { id:"he-shidduchim", name:"×©×™×“×•×›×™×", progress:45, target:35000, raised:15750, donorsCount:8,
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
          printRuns:[], donors:[]
        },
        { id:"he-al-hapachad", name:"×¢×œ ×”×¤×—×“", progress:28, target:30000, raised:8400, donorsCount:5,
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
          printRuns:[], donors:[]
        },
        { id:"he-kmayim", name:"×›××™×", progress:55, target:45000, raised:24750, donorsCount:11,
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
          printRuns:[], donors:[]
        },
      ],
      en: [
        { id:"en-awareness", name:"Awareness (××•×“×¢×•×ª)", progress:70, target:60000, raised:42000, donorsCount:22,
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Hardcover", notes:"" },
          printRuns:[], donors:[]
        },
        { id:"en-shidduchim", name:"Shidduchim (×©×™×“×•×›×™×)", progress:40, target:50000, raised:20000, donorsCount:10,
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Paperback", notes:"" },
          printRuns:[], donors:[]
        },
        { id:"en-foundations", name:"Foundations of Education", progress:55, target:55000, raised:30250, donorsCount:14,
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Paperback", notes:"" },
          printRuns:[], donors:[]
        },
        { id:"en-like-water", name:"Like Water (×›××™×)", progress:35, target:40000, raised:14000, donorsCount:7,
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Paperback", notes:"" },
          printRuns:[], donors:[]
        },
      ]
    },
    donors: [
      { id: uid(), ×©×:"××‘×¨×”× ×›×”×Ÿ", ×¤×¨×•×™×§×˜:"×™×¡×•×“×•×ª ×”×—×™× ×•×š", ××ª× ×”:"5000", ×ª××¨×™×š:"2025-02-01" },
      { id: uid(), ×©×:"×©×¨×” ×œ×•×™", ×¤×¨×•×™×§×˜:"×©×™×“×•×›×™×", ××ª× ×”:"3500", ×ª××¨×™×š:"2025-02-05" },
      { id: uid(), ×©×:"×™×¢×§×‘ ×’×¨×™× ×‘×¨×’", ×¤×¨×•×™×§×˜:"××•×“×¢×•×ª", ××ª× ×”:"7200", ×ª××¨×™×š:"2025-01-10" },
      { id: uid(), ×©×:"×¨×—×œ ×©×•×•×¨×¥", ×¤×¨×•×™×§×˜:"×›××™×", ××ª× ×”:"2800", ×ª××¨×™×š:"2025-02-05" }
    ],
    expenses: [
      { id: uid(), ×¡×¤×§:"×“×¤×•×¡ ××¨×›×–", ×¡×›×•×:"12500", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ" },
      { id: uid(), ×¡×¤×§:"××©×¨×“ - ×©×›×™×¨×•×ª ×—×•×“×©×™×ª", ×¡×›×•×:"1000", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ" },
      { id: uid(), ×¡×¤×§:"×’××´×— ×”×¡×¤×¨×™×", ×¡×›×•×:"8300", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ" },
      { id: uid(), ×¡×¤×§:"×©×œ×™×—×•×™×•×ª ×‘×™× ×´×œ", ×¡×›×•×:"4200", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ" }
    ],
    logistics: {
      israel: [
        { id: uid(), city:"×™×¨×•×©×œ×™×", books:350, status:"×¤×¢×™×œ" },
        { id: uid(), city:"×‘× ×™ ×‘×¨×§", books:280, status:"×¤×¢×™×œ" },
        { id: uid(), city:"×¦×¤×ª", books:120, status:"×¤×¢×™×œ" },
        { id: uid(), city:"×‘××¨ ×©×‘×¢", books:95, status:"×‘×”××ª× ×”" }
      ],
      international: [
        { id: uid(), country:"××¨×”×´×‘", books:500, status:"×‘×©×œ×™×—×”" },
        { id: uid(), country:"×× ×’×œ×™×”", books:180, status:"×¤×¢×™×œ" },
        { id: uid(), country:"×¦×¨×¤×ª", books:95, status:"×¤×¢×™×œ" },
        { id: uid(), country:"××•×¡×˜×¨×œ×™×”", books:65, status:"×‘×ª×›× ×•×Ÿ" }
      ]
    }
  };

  let store = loadStore() && typeof loadStore()==='object' ? loadStore() : structuredClone(defaultStore);
  saveStore();

  // =========================
  // THEME BY STAFF (×›××• ×©×”×™×”)
  // =========================
  const PALETTE = [
    { base:'#2563eb', soft:'#eff6ff', text:'#1d4ed8' },
    { base:'#16a34a', soft:'#ecfdf5', text:'#15803d' },
    { base:'#7c3aed', soft:'#f5f3ff', text:'#6d28d9' },
    { base:'#f59e0b', soft:'#fffbeb', text:'#b45309' },
    { base:'#ef4444', soft:'#fef2f2', text:'#b91c1c' },
    { base:'#0ea5e9', soft:'#f0f9ff', text:'#0284c7' },
    { base:'#14b8a6', soft:'#f0fdfa', text:'#0f766e' },
    { base:'#64748b', soft:'#f1f5f9', text:'#334155' },
  ];
  const managerIndex = (name) => {
    const idx = store.staff.findIndex(s => s.×©× === name);
    if(idx >= 0) return idx % PALETTE.length;
    let hash=0; for(const ch of String(name||'')) hash = (hash*31 + ch.charCodeAt(0)) >>> 0;
    return hash % PALETTE.length;
  };
  const managerTheme = (name) => PALETTE[managerIndex(name)];
  const taskCountFor = (name) => store.tasks.filter(t=>t.×× ×”×œ===name).length;

  // =========================
  // APP STATE
  // =========================
  let currentTab = 'tasks';
  let historyStack = [];
  let currentBookContext = null; // {lang,id}
  let selectedTaskOwner = 'ALL';

  // =========================
  // MODAL CORE
  // =========================
  const modal = {
    show(title, bodyHtml, onSubmit=null, submitText='×©××•×¨', showSubmit=true){
      $('#modal-title').innerText = title;
      $('#modal-body').innerHTML = bodyHtml;
      $('#modal').classList.remove('hidden');
      $('#btn-submit').style.display = showSubmit ? 'inline-block' : 'none';
      $('#btn-submit').innerHTML = `<i class="fas fa-check ml-2"></i> ${escapeHtml(submitText)}`;
      $('#btn-submit').onclick = onSubmit || (()=>modal.hide());
    },
    hide(){
      $('#modal').classList.add('hidden');
      $('#btn-submit').onclick = ()=>modal.hide();
      $('#btn-submit').style.display = 'inline-block';
    }
  };
  $('#btn-close-modal').onclick = modal.hide;
  $('#btn-cancel').onclick = modal.hide;

  // =========================
  // GENERIC EDIT FOR LIST ITEMS (×”×›×•×œ ×œ×—×™×¥)
  // =========================
  const SCHEMAS = {
    task: {
      title: (x)=>`××©×™××”: ${x.××©×™××”}`,
      list: ()=>store.tasks,
      remove: (id)=> store.tasks = store.tasks.filter(x=>x.id!==id),
      fields: [
        {k:'××©×™××”', label:'×ª×™××•×¨ ××©×™××”', type:'text', req:true},
        {k:'×× ×”×œ', label:'××—×¨××™', type:'select', req:true, options: ()=>store.staff.map(s=>s.×©×)},
        {k:'×“×—×™×¤×•×ª', label:'×“×—×™×¤×•×ª', type:'select', options: ()=>['×¨×’×™×œ×”','×’×‘×•×”×”']},
        {k:'×˜×•×•×—', label:'×˜×•×•×—', type:'select', options: ()=>['×—×•×“×©×™','××¨×•×š']},
      ]
    },
    idea: {
      title: (x)=>`×¨×¢×™×•×Ÿ: ${x.×›×•×ª×¨×ª}`,
      list: ()=>store.ideas,
      remove: (id)=> store.ideas = store.ideas.filter(x=>x.id!==id),
      fields: [
        {k:'×›×•×ª×¨×ª', label:'×›×•×ª×¨×ª', type:'text', req:true},
        {k:'×ª×™××•×¨', label:'×ª×™××•×¨', type:'textarea'},
        {k:'××’×™×©', label:'××™ ×”×¦×™×¢', type:'select', options: ()=>store.staff.map(s=>s.×©×)},
        {k:'×¡×˜×˜×•×¡', label:'×¡×˜×˜×•×¡', type:'select', options: ()=>['×—×“×©','×‘×‘×“×™×§×”','××•×©×¨','× ×“×—×”']},
        {k:'×ª××¨×™×š', label:'×ª××¨×™×š', type:'date'},
      ]
    },
    staff: {
      title: (x)=>`×¢×•×‘×“: ${x.×©×}`,
      list: ()=>store.staff,
      remove: (id)=> store.staff = store.staff.filter(x=>x.id!==id),
      fields: [
        {k:'×©×', label:'×©×', type:'text', req:true},
        {k:'×ª×¤×§×™×“', label:'×ª×¤×§×™×“', type:'text', req:true},
        {k:'×˜×œ×¤×•×Ÿ', label:'×˜×œ×¤×•×Ÿ', type:'text'},
        {k:'××™××™×™×œ', label:'××™××™×™×œ', type:'email'},
      ]
    },
    donor: {
      title: (x)=>`×ª×•×¨×: ${x.×©×}`,
      list: ()=>store.donors,
      remove: (id)=> store.donors = store.donors.filter(x=>x.id!==id),
      fields: [
        {k:'×©×', label:'×©× ×ª×•×¨×', type:'text', req:true},
        {k:'×¤×¨×•×™×§×˜', label:'×¤×¨×•×™×§×˜/×¡×¤×¨', type:'text', req:true},
        {k:'××ª× ×”', label:'×¡×›×•×', type:'number', req:true},
        {k:'×ª××¨×™×š', label:'×ª××¨×™×š', type:'date', req:true},
      ]
    },
    expense: {
      title: (x)=>`×—×•×‘: ${x.×¡×¤×§}`,
      list: ()=>store.expenses,
      remove: (id)=> store.expenses = store.expenses.filter(x=>x.id!==id),
      fields: [
        {k:'×¡×¤×§', label:'×¡×¤×§', type:'text', req:true},
        {k:'×¡×›×•×', label:'×¡×›×•×', type:'number', req:true},
        {k:'×¡×˜×˜×•×¡', label:'×¡×˜×˜×•×¡', type:'select', options: ()=>['×××ª×™×Ÿ','×©×•×œ×']},
      ]
    },
    logistics_israel: {
      title: (x)=>`×”×¤×¦×” ×‘××¨×¥: ${x.city}`,
      list: ()=>store.logistics.israel,
      remove: (id)=> store.logistics.israel = store.logistics.israel.filter(x=>x.id!==id),
      fields: [
        {k:'city', label:'×¢×™×¨', type:'text', req:true},
        {k:'books', label:'×›××•×ª ×¡×¤×¨×™×', type:'number', req:true},
        {k:'status', label:'×¡×˜×˜×•×¡', type:'select', options: ()=>['×¤×¢×™×œ','×‘×”××ª× ×”']},
      ]
    },
    logistics_intl: {
      title: (x)=>`×”×¤×¦×” ×‘×—×•×´×œ: ${x.country}`,
      list: ()=>store.logistics.international,
      remove: (id)=> store.logistics.international = store.logistics.international.filter(x=>x.id!==id),
      fields: [
        {k:'country', label:'××“×™× ×”', type:'text', req:true},
        {k:'books', label:'×›××•×ª ×¡×¤×¨×™×', type:'number', req:true},
        {k:'status', label:'×¡×˜×˜×•×¡', type:'select', options: ()=>['×¤×¢×™×œ','×‘×©×œ×™×—×”','×‘×ª×›× ×•×Ÿ']},
      ]
    }
  };

  function formField(field, value){
    const id = `f_${field.k}`;
    const base = `class="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 outline-none" id="${id}"`;
    if(field.type === 'textarea'){
      return `
        <div>
          <label class="block text-xs font-bold text-slate-600 mb-1">${escapeHtml(field.label)}</label>
          <textarea ${base} rows="4" placeholder="${escapeHtml(field.label)}">${escapeHtml(value)}</textarea>
        </div>`;
    }
    if(field.type === 'select'){
      const opts = (field.options?.() || []).map(o => `
        <option value="${escapeHtml(o)}" ${String(value)===String(o)?'selected':''}>${escapeHtml(o)}</option>
      `).join('');
      return `
        <div>
          <label class="block text-xs font-bold text-slate-600 mb-1">${escapeHtml(field.label)}</label>
          <select ${base}>${opts}</select>
        </div>`;
    }
    return `
      <div>
        <label class="block text-xs font-bold text-slate-600 mb-1">${escapeHtml(field.label)}</label>
        <input ${base} type="${field.type||'text'}" value="${escapeHtml(value)}" placeholder="${escapeHtml(field.label)}"/>
      </div>`;
  }

  function openEditEntity(schemaKey, entityId){
    const schema = SCHEMAS[schemaKey];
    const list = schema.list();
    const entity = list.find(x=>x.id===entityId);
    if(!entity) return;

    const th = (schemaKey==='task') ? managerTheme(entity.×× ×”×œ) : null;

    const topBar = th ? `
      <div class="p-4 rounded-xl border mb-4" style="background:${th.soft}; border-color:${th.base}">
        <div class="text-xs font-bold" style="color:${th.text}">××—×¨××™: ${escapeHtml(entity.×× ×”×œ)}</div>
        <div class="text-[10px]" style="color:${th.text}99">×“×—×™×¤×•×ª: ${escapeHtml(entity.×“×—×™×¤×•×ª)} â€¢ ×˜×•×•×—: ${escapeHtml(entity.×˜×•×•×—)}</div>
      </div>` : '';

    const body = `
      ${topBar}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${schema.fields.map(f => formField(f, entity[f.k] ?? '')).join('')}
      </div>

      <div class="pt-4 mt-4 border-t flex items-center justify-between">
        <button class="text-red-600 font-extrabold text-sm hover:underline" id="btn-del">
          <i class="fas fa-trash ml-2"></i> ××—×§
        </button>

        ${schemaKey==='idea' ? `
          <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-extrabold text-sm" id="btn-idea-to-task">
            <i class="fas fa-list-check ml-2"></i> ×”×¤×•×š ×œ××©×™××”
          </button>
        ` : ''}
      </div>
    `;

    modal.show(schema.title(entity), body, () => {
      // validate + save
      for(const f of schema.fields){
        const v = $(`#f_${f.k}`).value;
        if(f.req && !String(v).trim()) return alert('× × ×œ××œ× ×©×“×•×ª ×—×•×‘×”');
      }
      for(const f of schema.fields){
        let v = $(`#f_${f.k}`).value;
        if(f.type==='number') v = parseInt(v||0);
        entity[f.k] = v;
      }
      saveStore();
      modal.hide();
      render();
      notify('×¢×•×“×›×Ÿ âœ…');
    }, '×©××•×¨');

    $('#btn-del').onclick = () => {
      if(!confirm('×œ××—×•×§ ×¤×¨×™×˜ ×–×”?')) return;
      schema.remove(entityId);
      saveStore();
      modal.hide();
      render();
      notify('× ××—×§ ğŸ—‘ï¸');
    };

    const btnIdeaToTask = $('#btn-idea-to-task');
    if(btnIdeaToTask){
      btnIdeaToTask.onclick = () => {
        if(!confirm('×œ×”×¤×•×š ××ª ×”×¨×¢×™×•×Ÿ ×”×–×” ×œ××©×™××”?')) return;
        store.tasks.unshift({
          id: uid(),
          ××©×™××”: entity.×›×•×ª×¨×ª,
          ×× ×”×œ: entity.××’×™×© || (store.staff[0]?.×©× || ''),
          ×“×—×™×¤×•×ª: '×¨×’×™×œ×”',
          ×˜×•×•×—: '××¨×•×š'
        });
        entity.×¡×˜×˜×•×¡ = '××•×©×¨';
        saveStore();
        modal.hide();
        switchTab('tasks');
        notify('×”×•××¨ ×œ××©×™××” ğŸ¯');
      };
    }
  }

  // =========================
  // BOOK DETAIL (× ×©××¨ ××œ×)
  // =========================
  const findBook = (lang,id) => store.books[lang].find(b=>b.id===id);

  function setBookField(lang, id, path, value){
    const b = findBook(lang, id); if(!b) return;
    const [root,key] = path.split('.');
    b[root] = b[root] || {};
    b[root][key] = (key==='pages') ? parseInt(value||0) : value;
    saveStore();
  }

  function recalcBookProgress(b){
    b.progress = Math.max(0, Math.min(100, Math.round((Number(b.raised||0) / Math.max(1, Number(b.target||0))) * 100)));
  }

  function renderBookDetail(container, lang, bookId){
    const b = findBook(lang, bookId);
    if(!b){ container.innerHTML = `<div class="card">×œ× × ××¦× ×¡×¤×¨</div>`; return; }
    currentBookContext = {lang, id: bookId};
    $('#current-tab-title').innerText = `×¡×¤×¨: ${b.name}`;
    $('#btn-back').classList.remove('hidden');

    const identity = b.identity || (b.identity = {});
    const pr = b.printRuns || (b.printRuns = []);
    const bd = b.donors || (b.donors = []);
    const sumPrint = pr.reduce((s,r)=>s+(Number(r.qty)||0),0);
    const sumDon = bd.reduce((s,d)=>s+(Number(d.amount)||0),0);

    const fieldInput = (label, val, oninput, type='text') => `
      <div>
        <label class="block text-xs font-bold text-slate-600 mb-1">${escapeHtml(label)}</label>
        <input type="${type}" value="${escapeHtml(String(val??''))}"
          oninput="${oninput}"
          class="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 outline-none" />
      </div>
    `;

    container.innerHTML = `
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card lg:col-span-1 border-r-4 border-blue-600">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-400 font-bold uppercase">×ª×¢×•×“×ª ×–×”×•×ª â€¢ ${lang==='he'?'×¢×‘×¨×™×ª':'English'}</div>
              <div class="text-2xl font-bold mt-1">${escapeHtml(b.name)}</div>
              <div class="text-sm text-slate-500 mt-1">${escapeHtml(identity.subtitle || 'â€”')}</div>
            </div>
            <div class="text-blue-600 text-2xl"><i class="fas fa-book-open"></i></div>
          </div>

          <div class="mt-6 space-y-3 text-sm">
            <div class="flex justify-between"><span class="text-slate-500">×™×¢×“ ×’×™×•×¡</span><span class="font-bold">${money(b.target)}</span></div>
            <div class="flex justify-between"><span class="text-slate-500">× ×’×‘×”</span><span class="font-bold text-emerald-600">${money(b.raised)}</span></div>
            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
              <div class="bg-gradient-to-l from-emerald-400 to-emerald-600 h-full progress-bar" style="width:${b.progress}%"></div>
            </div>

            <div class="pt-3 border-t grid grid-cols-2 gap-3">
              <div class="p-3 rounded-xl bg-slate-50">
                <div class="text-[10px] text-slate-400 font-bold uppercase">×¡×”×´×› ×”×“×¤×¡×•×ª</div>
                <div class="text-xl font-bold mt-1">${pr.length}</div>
              </div>
              <div class="p-3 rounded-xl bg-slate-50">
                <div class="text-[10px] text-slate-400 font-bold uppercase">×¡×”×´×› ×¢×•×ª×§×™×</div>
                <div class="text-xl font-bold mt-1">${Number(sumPrint).toLocaleString()}</div>
              </div>
              <div class="p-3 rounded-xl bg-emerald-50 col-span-2">
                <div class="text-[10px] text-emerald-600 font-bold uppercase">×ª×•×¨××™× ×‘×¨××ª ×”×¡×¤×¨</div>
                <div class="text-xl font-bold mt-1">${money(sumDon)}</div>
              </div>
            </div>

            <button class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold transition" id="btn-save-book">
              <i class="fas fa-save ml-2"></i> ×©××•×¨ (××§×•××™)
            </button>

            <div class="text-xs text-slate-400">* × ×©××¨ ×‘×“×¤×“×¤×Ÿ (LocalStorage) ××•×˜×•××˜×™×ª.</div>
          </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
          <div class="card border-r-4 border-slate-300">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-id-card ml-2 text-slate-500"></i> ×¤×¨×˜×™ ×”×¡×¤×¨ (×©×“×•×ª ×œ×”×–× ×”)</h3>
              <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-pen"></i> × ×™×ª×Ÿ ×œ×¢×¨×™×›×”</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              ${fieldInput('×›×•×ª×¨×ª ××©× ×”', identity.subtitle, `setBookField('${lang}','${b.id}','identity.subtitle', this.value)`)}
              ${fieldInput('××—×‘×¨', identity.author, `setBookField('${lang}','${b.id}','identity.author', this.value)`)}
              ${fieldInput('×¢×•×¨×š', identity.editor, `setBookField('${lang}','${b.id}','identity.editor', this.value)`)}
              ${fieldInput('×¡×“×¨×”', identity.series, `setBookField('${lang}','${b.id}','identity.series', this.value)`)}
              ${fieldInput('ISBN', identity.isbn, `setBookField('${lang}','${b.id}','identity.isbn', this.value)`)}
              ${fieldInput('××¡×³ ×¢××•×“×™×', identity.pages, `setBookField('${lang}','${b.id}','identity.pages', this.value)`, 'number')}
              ${fieldInput('×’×•×“×œ (Trim)', identity.trim, `setBookField('${lang}','${b.id}','identity.trim', this.value)`)}
              ${fieldInput('×›×¨×™×›×”', identity.binding, `setBookField('${lang}','${b.id}','identity.binding', this.value)`)}
            </div>

            <div class="mt-4">
              <label class="block text-xs font-bold text-slate-600 mb-1">×”×¢×¨×•×ª</label>
              <textarea class="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 outline-none" rows="3"
                oninput="setBookField('${lang}','${b.id}','identity.notes', this.value)"
                placeholder="×”×¢×¨×•×ª ×¤× ×™××™×•×ª...">${escapeHtml(identity.notes||'')}</textarea>
            </div>
          </div>

          <div class="card border-r-4 border-purple-500">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-print ml-2 text-purple-600"></i> ×”×™×¡×˜×•×¨×™×™×ª ×”×“×¤×¡×•×ª</h3>
              <button class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-sm font-bold transition" id="btn-add-pr">
                <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×”×“×¤×¡×”
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-right text-sm">
                <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
                  <tr>
                    <th class="p-3">×©× ×”</th><th class="p-3">×›××•×ª</th><th class="p-3">×“×¤×•×¡</th><th class="p-3">×”×¢×¨×•×ª</th><th class="p-3 text-left">×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody>
                  ${
                    pr.length ? pr.map((r, idx)=>`
                      <tr class="border-b hover:bg-slate-50">
                        <td class="p-3"><input type="number" class="w-24 p-2 border rounded" value="${r.year??''}" data-pr="${idx}" data-f="year"></td>
                        <td class="p-3"><input type="number" class="w-28 p-2 border rounded" value="${r.qty??''}" data-pr="${idx}" data-f="qty"></td>
                        <td class="p-3"><input class="w-full p-2 border rounded" value="${escapeHtml(r.printer||'')}" data-pr="${idx}" data-f="printer"></td>
                        <td class="p-3"><input class="w-full p-2 border rounded" value="${escapeHtml(r.notes||'')}" data-pr="${idx}" data-f="notes"></td>
                        <td class="p-3 text-left">
                          <button class="text-red-600 hover:underline text-xs font-bold" data-delpr="${idx}">
                            <i class="fas fa-trash ml-1"></i> ××—×§
                          </button>
                        </td>
                      </tr>
                    `).join('') : `
                      <tr><td class="p-6 text-center text-slate-400" colspan="5">××™×Ÿ ×¢×“×™×™×Ÿ ×”×“×¤×¡×•×ª. ×œ×—×¥ "×”×•×¡×£ ×”×“×¤×¡×”".</td></tr>
                    `
                  }
                </tbody>
              </table>
            </div>
            <div class="mt-3 text-xs text-slate-400">×¡×”×´×› ×¢×•×ª×§×™×: <span class="font-bold text-slate-700">${Number(sumPrint).toLocaleString()}</span></div>
          </div>

          <div class="card border-r-4 border-emerald-500">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-hand-holding-heart ml-2 text-emerald-600"></i> ×ª×•×¨××™× ×©×œ ×”×¡×¤×¨</h3>
              <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg text-sm font-bold transition" id="btn-add-bd">
                <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×ª×•×¨×
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-right text-sm">
                <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
                  <tr><th class="p-3">×©×</th><th class="p-3">×ª××¨×™×š</th><th class="p-3">×¡×›×•×</th><th class="p-3">×”×¢×¨×”</th><th class="p-3 text-left">×¤×¢×•×œ×•×ª</th></tr>
                </thead>
                <tbody>
                  ${
                    bd.length ? bd.map((d, idx)=>`
                      <tr class="border-b hover:bg-slate-50">
                        <td class="p-3"><input class="w-full p-2 border rounded" value="${escapeHtml(d.name||'')}" data-bd="${idx}" data-f="name"></td>
                        <td class="p-3"><input type="date" class="p-2 border rounded" value="${d.date||todayISO()}" data-bd="${idx}" data-f="date"></td>
                        <td class="p-3"><input type="number" class="w-32 p-2 border rounded" value="${d.amount??''}" data-bd="${idx}" data-f="amount"></td>
                        <td class="p-3"><input class="w-full p-2 border rounded" value="${escapeHtml(d.note||'')}" data-bd="${idx}" data-f="note"></td>
                        <td class="p-3 text-left">
                          <button class="text-red-600 hover:underline text-xs font-bold" data-delbd="${idx}">
                            <i class="fas fa-trash ml-1"></i> ××—×§
                          </button>
                        </td>
                      </tr>
                    `).join('') : `
                      <tr><td class="p-6 text-center text-slate-400" colspan="5">××™×Ÿ ×ª×•×¨××™× ×¢×“×™×™×Ÿ. ×œ×—×¥ "×”×•×¡×£ ×ª×•×¨×".</td></tr>
                    `
                  }
                </tbody>
              </table>
            </div>
            <div class="mt-3 text-xs text-slate-400">×¡×”×´×› ×ª×¨×•××•×ª ×œ×¡×¤×¨: <span class="font-bold text-emerald-700">${money(sumDon)}</span></div>
          </div>

        </div>
      </div>
    `;

    // handlers
    $('#btn-save-book').onclick = () => { saveStore(); notify('× ×©××¨ âœ…'); };

    $('#btn-add-pr').onclick = () => {
      pr.unshift({ year: new Date().getFullYear(), qty: 0, printer:"", notes:"" });
      saveStore();
      renderBookDetail(container, lang, bookId);
      notify('× ×•×¡×¤×” ×”×“×¤×¡×”');
    };
    $('#btn-add-bd').onclick = () => {
      bd.unshift({ id: uid(), name:'×ª×•×¨× ×—×“×©', amount:0, date: todayISO(), note:'' });
      saveStore();
      renderBookDetail(container, lang, bookId);
      notify('× ×•×¡×£ ×ª×•×¨×');
    };

    // delegate input changes
    container.oninput = (e) => {
      const t = e.target;
      if(t?.dataset?.pr){
        const idx = Number(t.dataset.pr), f=t.dataset.f;
        if(!pr[idx]) return;
        pr[idx][f] = (f==='year'||f==='qty') ? parseInt(t.value||0) : t.value;
        saveStore();
      }
      if(t?.dataset?.bd){
        const idx = Number(t.dataset.bd), f=t.dataset.f;
        if(!bd[idx]) return;
        bd[idx][f] = (f==='amount') ? parseInt(t.value||0) : t.value;
        saveStore();
      }
    };

    container.onclick = (e) => {
      const delpr = e.target.closest('[data-delpr]')?.dataset?.delpr;
      if(delpr !== undefined){
        if(confirm('×œ××—×•×§ ×©×•×¨×ª ×”×“×¤×¡×”?')){
          pr.splice(Number(delpr),1);
          saveStore();
          renderBookDetail(container, lang, bookId);
          notify('×©×•×¨×ª ×”×“×¤×¡×” × ××—×§×”');
        }
      }
      const delbd = e.target.closest('[data-delbd]')?.dataset?.delbd;
      if(delbd !== undefined){
        if(confirm('×œ××—×•×§ ×ª×•×¨×?')){
          bd.splice(Number(delbd),1);
          saveStore();
          renderBookDetail(container, lang, bookId);
          notify('×ª×•×¨× × ××—×§');
        }
      }
    };
  }

  // =========================
  // RENDER: TABS
  // =========================
  function setAddButtonText(){
    const map = {
      tasks:'×”×•×¡×£ ××©×™××”',
      ideas:'×”×•×¡×£ ×¨×¢×™×•×Ÿ',
      staff:'×”×•×¡×£ ×¢×•×‘×“',
      donors:'×”×•×¡×£ ×ª×¨×•××”',
      expenses:'×”×•×¡×£ ×—×•×‘',
      logistics:'×”×•×¡×£ ×™×¢×“',
      'books-he':'×”×•×¡×£ ×¡×¤×¨',
      'books-en':'×”×•×¡×£ ×¡×¤×¨',
      'book-detail':'×”×•×¡×£ × ×ª×•×Ÿ'
    };
    $('#add-btn-text').innerText = map[currentTab] || '×”×•×¡×£ ×—×“×©';
  }

  function setActiveNav(tab){
    $$('.nav-item').forEach(el=>el.classList.remove('active'));
    const btn = $('#btn-'+tab);
    if(btn) btn.classList.add('active');
  }

  function setBackButton(visible){
    $('#btn-back').classList.toggle('hidden', !visible);
  }

  function switchTab(tab, opts={pushHistory:true}){
    if(opts.pushHistory) historyStack.push(currentTab);
    currentTab = tab;
    if(tab !== 'book-detail') currentBookContext = null;

    setActiveNav(tab);
    setAddButtonText();

    const content = $('#tab-content');
    content.classList.remove('fade-in'); void content.offsetWidth; content.classList.add('fade-in');

    const titles = {
      tasks:'××©×™××•×ª ×•×œ×•"×– ×‘×™×¦×•×¢',
      ideas:'×¨×¢×™×•× ×•×ª ×¢×•×‘×“×™× (×œ×—×™×¥ + ×”×¤×™×›×” ×œ××©×™××”)',
      staff:'×¢×•×‘×“×™ ×”××›×•×Ÿ ×•×¦×•×•×ª ×”× ×™×”×•×œ',
      donors:'×’×™×•×¡ ×›×¡×¤×™× ×•×ª×•×¨××™× ××§×˜×•××œ×™×™×',
      logistics:'×”×¤×¦×” ×‘××¨×¥ ×•×‘×—×•×´×œ',
      expenses:'×—×•×‘×•×ª ×œ×¡×¤×§×™× ×•×¢×œ×•×™×•×ª ×©×•×˜×¤×•×ª',
      'books-he':'××¢×¨×š ×”×¡×¤×¨×™× - ×¢×‘×¨×™×ª (×œ×—×™×¦×” ×¢×œ ×¡×¤×¨ = ×¢××•×“ ××œ×)',
      'books-en':'International Division - English (Click a book)',
      'book-detail':'×ª×¢×•×“×ª ×–×”×•×ª ×©×œ ×¡×¤×¨'
    };
    $('#current-tab-title').innerText = titles[tab] || '××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ';
    setBackButton(tab==='book-detail');

    render();
  }

  function goBack(){
    const prev = historyStack.pop();
    if(!prev) return switchTab('tasks', {pushHistory:false});
    switchTab(prev, {pushHistory:false});
  }

  function renderTasks(container){
    const highAll = store.tasks.filter(t=>t.×“×—×™×¤×•×ª==='×’×‘×•×”×”');
    const filtered = selectedTaskOwner==='ALL' ? store.tasks : store.tasks.filter(t=>t.×× ×”×œ===selectedTaskOwner);
    const high = selectedTaskOwner==='ALL' ? highAll : filtered.filter(t=>t.×“×—×™×¤×•×ª==='×’×‘×•×”×”');

    const legend = store.staff.map(s=>{
      const th = managerTheme(s.×©×);
      const c = taskCountFor(s.×©×);
      return `
        <button class="px-3 py-2 rounded-xl text-xs font-bold border hover:shadow-sm transition flex items-center gap-2"
          data-set-owner="${escapeHtml(s.×©×)}"
          style="border-color:${th.base}; background:${th.soft}; color:${th.text}">
          <span class="w-3 h-3 rounded-full" style="background:${th.base}"></span>
          <span>${escapeHtml(s.×©×)}</span>
          <span class="mr-1 px-2 py-0.5 rounded-full text-[10px]" style="background:#ffffffa6;border:1px solid ${th.base};color:${th.text}">
            ${c} ××©×™××•×ª
          </span>
        </button>
      `;
    }).join('');

    container.innerHTML = `
      <div class="card border-r-4 border-slate-300">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="text-slate-800 font-bold text-lg"><i class="fas fa-filter ml-2 text-slate-400"></i> ×¡×™× ×•×Ÿ â€œ×”××©×™××•×ª ×©×œ×™â€</div>
            <span class="text-xs text-slate-400">×‘×—×¨ ×¢×•×‘×“ ×›×“×™ ×œ×¨××•×ª ×¨×§ ××ª ×”××©×™××•×ª ×©×œ×•</span>
          </div>
          <div class="flex items-center gap-2">
            <button data-set-owner="ALL" class="px-4 py-2 rounded-xl text-sm font-bold border bg-white hover:bg-slate-50 transition">
              <i class="fas fa-layer-group ml-2"></i> ×›×œ ×”××©×™××•×ª
            </button>
            <select data-owner-select class="px-4 py-2 rounded-xl text-sm font-bold border bg-white">
              <option value="ALL">×‘×—×¨ ×¢×•×‘×“â€¦</option>
              ${store.staff.map(s => `<option value="${escapeHtml(s.×©×)}" ${selectedTaskOwner===s.×©×?'selected':''}>${escapeHtml(s.×©×)}</option>`).join('')}
            </select>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">${legend}</div>
        <div class="mt-3 text-xs text-slate-500">
          ××¦×‘ × ×•×›×—×™: <span class="font-bold">${selectedTaskOwner==='ALL'?'×›×œ ×”×¢×•×‘×“×™×':escapeHtml(selectedTaskOwner)}</span>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card border-r-8 border-red-500">
          <h4 class="font-bold text-red-600 mb-4 text-lg flex items-center">
            <i class="fas fa-fire ml-2"></i> ×“×—×•×£ ×œ×‘×™×¦×•×¢ ××™×“×™
            <span class="mr-auto bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs">${high.length}</span>
          </h4>

          ${
            high.length ? high.map(t=>{
              const th = managerTheme(t.×× ×”×œ);
              return `
                <button class="w-full text-right p-4 rounded-xl mb-3 border transition hover:shadow"
                  data-open="task" data-id="${t.id}"
                  style="background:${th.soft}; border-color:${th.base}">
                  <div class="font-bold" style="color:${th.text}">${escapeHtml(t.××©×™××”)}</div>
                  <div class="text-[10px] mt-1" style="color:${th.text}99">××—×¨××™: ${escapeHtml(t.×× ×”×œ)} â€¢ ×˜×•×•×—: ${escapeHtml(t.×˜×•×•×—)}</div>
                  <div class="mt-2 text-xs font-bold" style="color:${th.text}">
                    <i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥ ×œ×¢×¨×™×›×”
                  </div>
                </button>
              `;
            }).join('') : `<p class="text-slate-400 text-center py-8">××™×Ÿ ××©×™××•×ª ×“×—×•×¤×•×ª ğŸ‰</p>`
          }
        </div>

        <div class="card border-r-8 border-slate-300">
          <h4 class="font-bold text-slate-600 mb-4 text-lg">×›×œ×œ ×”××©×™××•×ª</h4>
          <div class="divide-y">
            ${filtered.map(t=>{
              const th = managerTheme(t.×× ×”×œ);
              return `
                <button class="w-full text-right p-3 text-sm flex justify-between items-center hover:bg-slate-50"
                  data-open="task" data-id="${t.id}">
                  <span class="font-bold text-slate-800 flex items-center gap-2">
                    <span class="w-2.5 h-2.5 rounded-full" style="background:${th.base}"></span>
                    ${escapeHtml(t.××©×™××”)}
                  </span>
                  <span class="text-xs font-bold px-2 py-1 rounded-full" style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                    ${escapeHtml(t.×× ×”×œ)}
                  </span>
                </button>
              `;
            }).join('')}
          </div>
          <div class="pt-4 text-xs text-slate-400">* ×›×œ ××©×™××” ×œ×—×™×¦×” = ×¢×¨×™×›×” ××”×™×¨×”</div>
        </div>
      </div>
    `;
  }

  function renderIdeas(container){
    const total = store.ideas.length;
    const byStatus = (s)=>store.ideas.filter(x=>x.×¡×˜×˜×•×¡===s).length;

    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card border-b-4 border-amber-500 text-right">
          <div class="text-[10px] text-slate-400 font-bold uppercase">×¡×”×´×› ×¨×¢×™×•× ×•×ª</div>
          <div class="text-3xl font-extrabold mt-1">${total}</div>
        </div>
        <div class="card border-b-4 border-slate-400 text-right">
          <div class="text-[10px] text-slate-400 font-bold uppercase">×—×“×©×™×</div>
          <div class="text-3xl font-extrabold mt-1">${byStatus('×—×“×©')}</div>
        </div>
        <div class="card border-b-4 border-blue-500 text-right">
          <div class="text-[10px] text-slate-400 font-bold uppercase">×‘×‘×“×™×§×”</div>
          <div class="text-3xl font-extrabold mt-1">${byStatus('×‘×‘×“×™×§×”')}</div>
        </div>
        <div class="card border-b-4 border-emerald-500 text-right">
          <div class="text-[10px] text-slate-400 font-bold uppercase">××•×©×¨</div>
          <div class="text-3xl font-extrabold mt-1">${byStatus('××•×©×¨')}</div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <h4 class="font-bold text-lg"><i class="fas fa-lightbulb ml-2 text-amber-500"></i> ×¨×¢×™×•× ×•×ª ×¢×•×‘×“×™×</h4>
          <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-mouse-pointer"></i> ×”×›×œ ×œ×—×™×¥</span>
        </div>

        <div class="space-y-3">
          ${
            store.ideas.map(idea=>{
              const th = managerTheme(idea.××’×™×©);
              const badge =
                idea.×¡×˜×˜×•×¡==='×—×“×©' ? 'bg-slate-100 text-slate-700' :
                idea.×¡×˜×˜×•×¡==='×‘×‘×“×™×§×”' ? 'bg-blue-100 text-blue-700' :
                idea.×¡×˜×˜×•×¡==='××•×©×¨' ? 'bg-emerald-100 text-emerald-700' :
                'bg-red-100 text-red-700';
              return `
                <div class="p-4 rounded-xl border hover:shadow transition" style="border-color:${th.base}; background:${th.soft}">
                  <div class="flex items-start justify-between gap-3">
                    <button class="text-right" data-open="idea" data-id="${idea.id}">
                      <div class="text-lg font-extrabold" style="color:${th.text}">${escapeHtml(idea.×›×•×ª×¨×ª)}</div>
                      <div class="text-xs mt-1 text-slate-600">${escapeHtml(idea.×ª×™××•×¨||'')}</div>
                      <div class="text-[10px] mt-2 text-slate-500">××’×™×©: <b>${escapeHtml(idea.××’×™×©||'â€”')}</b> â€¢ ×ª××¨×™×š: ${escapeHtml(idea.×ª××¨×™×š||'')}</div>
                    </button>

                    <div class="flex flex-col items-end gap-2">
                      <span class="chip ${badge}">${escapeHtml(idea.×¡×˜×˜×•×¡||'')}</span>
                      <button class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg text-xs font-extrabold"
                        data-idea-to-task="${idea.id}">
                        <i class="fas fa-list-check ml-2"></i> ×”×¤×•×š ×œ××©×™××”
                      </button>
                    </div>
                  </div>
                </div>
              `;
            }).join('')
          }
        </div>

        <div class="pt-4 text-xs text-slate-400">* â€œ×”×¤×•×š ×œ××©×™××”â€ ×™×™×¦×•×¨ ××©×™××” ×—×“×©×” ×¢× ××•×ª×• ××’×™×© ×›××—×¨××™.</div>
      </div>
    `;
  }

  function renderStaff(container){
    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        ${store.staff.map(s=>{
          const th = managerTheme(s.×©×);
          const c = taskCountFor(s.×©×);
          return `
            <button class="card border-b-4 hover:shadow-lg transition text-right"
              data-open="staff" data-id="${s.id}"
              style="border-bottom-color:${th.base}">
              <div class="flex items-center space-x-3 space-x-reverse mb-4">
                <div class="p-3 rounded-full" style="background:${th.soft}; color:${th.text}">
                  <i class="fas fa-user-tie"></i>
                </div>
                <div>
                  <div class="font-bold text-lg">${escapeHtml(s.×©×)}</div>
                  <div class="text-xs text-slate-400 font-bold uppercase">${escapeHtml(s.×ª×¤×§×™×“)}</div>
                </div>
                <div class="mr-auto flex items-center gap-2">
                  <span class="chip" style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                    <i class="fas fa-list-check"></i> ${c} ××©×™××•×ª
                  </span>
                  <span class="chip bg-slate-100 text-slate-600"><i class="fas fa-mouse-pointer"></i> ×œ×—×¥</span>
                </div>
              </div>

              <div class="text-xs space-y-1 text-slate-600">
                <div><i class="fas fa-phone ml-2" style="color:${th.text}"></i> ${escapeHtml(s.×˜×œ×¤×•×Ÿ||'')}</div>
                <div><i class="fas fa-envelope ml-2" style="color:${th.text}"></i> ${escapeHtml(s.××™××™×™×œ||'')}</div>
              </div>

              <div class="mt-4">
                <button type="button"
                  class="w-full px-4 py-2 rounded-xl text-sm font-bold transition"
                  style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}"
                  data-filter-tasks="${escapeHtml(s.×©×)}">
                  <i class="fas fa-eye ml-2"></i> ×”×¦×’ â€œ×”××©×™××•×ª ×©×œ×™â€
                </button>
              </div>
            </button>
          `;
        }).join('')}
      </div>
    `;
  }

  function renderBooks(container, lang){
    const list = store.books[lang];
    container.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-sm text-slate-500">
          <span class="chip bg-blue-50 text-blue-700"><i class="fas fa-info-circle"></i> ×œ×—×¥ ×¢×œ ×¡×¤×¨ ×œ×¤×ª×™×—×ª ×¢××•×“ ××œ×</span>
        </div>
        <div class="text-xs text-slate-400">×¡×”×´×›: ${list.length} ×¡×¤×¨×™×</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        ${list.map(b=>`
          <button class="card border-t-4 border-blue-600 hover:shadow-xl transition text-right"
            data-open-book="${lang}|${b.id}">
            <div class="flex items-start justify-between gap-3">
              <h4 class="font-bold text-lg mb-1">${escapeHtml(b.name)}</h4>
              <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-arrow-left"></i> ×¢××•×“</span>
            </div>
            <div class="text-[10px] text-slate-400 mb-4 font-bold uppercase">××¦×‘ ×’×™×•×¡ ×›×¡×¤×™×</div>

            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden mb-3">
              <div class="bg-gradient-to-l from-emerald-400 to-emerald-600 h-full progress-bar" style="width:${b.progress}%"></div>
            </div>

            <div class="flex justify-between items-center mb-4">
              <span class="text-sm font-bold text-emerald-600">${money(b.raised)}</span>
              <span class="text-xs text-slate-400">×™×¢×“: ${money(b.target)}</span>
            </div>

            <div class="flex items-center justify-between text-xs text-slate-500">
              <span><i class="fas fa-users ml-1"></i> ${b.donorsCount ?? (b.donors?.length || 0)} ×ª×•×¨××™×</span>
              <span class="chip bg-purple-50 text-purple-700"><i class="fas fa-print"></i> ×”×“×¤×¡×•×ª: ${(b.printRuns||[]).length}</span>
            </div>
          </button>
        `).join('')}
      </div>
    `;
  }

  function renderDonors(container){
    const total = store.donors.reduce((sum,d)=>sum + parseInt(d.××ª× ×”||0),0);
    const avg = Math.round(total / Math.max(1, store.donors.length));
    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <button class="card bg-emerald-500 text-white border-none shadow-emerald-200 shadow-xl text-right" data-open-summary="total">
          <div class="text-xs font-bold opacity-80 uppercase mb-1">×¡×”×´×› ×’×™×•×¡ ×”×—×•×“×©</div>
          <div class="text-4xl font-bold">${money(total)}</div>
          <div class="mt-2 text-xs opacity-90"><i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥</div>
        </button>
        <button class="card bg-blue-500 text-white border-none text-right" data-open-summary="count">
          <div class="text-xs font-bold opacity-80 uppercase mb-1">×ª×•×¨××™× ×¤×¢×™×œ×™×</div>
          <div class="text-4xl font-bold">${store.donors.length}</div>
          <div class="mt-2 text-xs opacity-90"><i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥</div>
        </button>
        <button class="card bg-purple-500 text-white border-none text-right" data-open-summary="avg">
          <div class="text-xs font-bold opacity-80 uppercase mb-1">×××•×¦×¢ ×ª×¨×•××”</div>
          <div class="text-4xl font-bold">${money(avg)}</div>
          <div class="mt-2 text-xs opacity-90"><i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥</div>
        </button>
      </div>

      <div class="card">
        <h4 class="font-bold mb-4 text-lg">×¨×©×™××ª ×ª×•×¨××™× (×œ×—×™×¥ ×œ×¢×¨×™×›×”)</h4>
        <table class="w-full text-right text-sm">
          <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
            <tr><th class="p-3">×©× ×ª×•×¨×</th><th class="p-3">×¤×¨×•×™×§×˜</th><th class="p-3">×ª××¨×™×š</th><th class="p-3">×¡×›×•×</th></tr>
          </thead>
          <tbody>
            ${store.donors.map(d=>`
              <tr class="border-b hover:bg-slate-50 cursor-pointer" data-open="donor" data-id="${d.id}">
                <td class="p-3 font-bold text-slate-800">${escapeHtml(d.×©×)}</td>
                <td class="p-3 text-slate-500 text-xs">${escapeHtml(d.×¤×¨×•×™×§×˜)}</td>
                <td class="p-3 text-slate-400 text-xs">${escapeHtml(d.×ª××¨×™×š)}</td>
                <td class="p-3 font-bold text-emerald-600">${money(parseInt(d.××ª× ×”||0))}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div class="pt-3 text-xs text-slate-400">* ×›×œ ×©×•×¨×” ×œ×—×™×¦×” = ×¢×¨×™×›×” ××”×™×¨×”</div>
      </div>
    `;
  }

  function renderExpenses(container){
    const total = store.expenses.reduce((sum,e)=>sum + parseInt(e.×¡×›×•×||0),0);
    container.innerHTML = `
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 text-center">
        <div class="card border-b-4 border-blue-500"><p class="text-[10px] text-slate-400 font-bold uppercase">××©×¨×“</p><h2 class="text-2xl font-bold mt-1">â‚ª1,000</h2></div>
        <div class="card border-b-4 border-slate-800"><p class="text-[10px] text-slate-400 font-bold uppercase">×—× ×™×”</p><h2 class="text-2xl font-bold mt-1">â‚ª450</h2></div>
        <div class="card border-b-4 border-slate-800"><p class="text-[10px] text-slate-400 font-bold uppercase">×¨×›×‘</p><h2 class="text-2xl font-bold mt-1">â‚ª1,500</h2></div>
        <div class="card border-b-4 border-emerald-500"><p class="text-[10px] text-slate-400 font-bold uppercase">×“×™×’×™×˜×œ</p><h2 class="text-2xl font-bold mt-1">$100</h2></div>
        <div class="card border-b-4 border-red-500"><p class="text-[10px] text-red-400 font-bold uppercase">×—×•×‘×•×ª</p><h2 class="text-2xl font-bold mt-1 text-red-600">${money(total)}</h2></div>
      </div>

      <div class="card">
        <h4 class="font-bold mb-4 text-lg">×—×•×‘×•×ª ×œ×¡×¤×§×™× ×•×’××´×—×™× (×œ×—×™×¥ ×œ×¢×¨×™×›×”)</h4>
        <table class="w-full text-right text-sm">
          <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
            <tr><th class="p-3">×¡×¤×§</th><th class="p-3 text-left">×¡×›×•×</th><th class="p-3 text-left">×¤×¢×•×œ×•×ª</th></tr>
          </thead>
          <tbody>
            ${store.expenses.map(e=>`
              <tr class="border-b hover:bg-slate-50">
                <td class="p-3 font-bold text-slate-800">
                  <button class="text-right hover:underline" data-open="expense" data-id="${e.id}">${escapeHtml(e.×¡×¤×§)}</button>
                </td>
                <td class="p-3 text-left"><span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold">${money(parseInt(e.×¡×›×•×||0))}</span></td>
                <td class="p-3 text-left">
                  <button class="text-emerald-700 hover:underline text-xs font-bold" data-mark-paid="${e.id}">
                    <i class="fas fa-check ml-1"></i> ×©×•×œ×
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  function renderLogistics(container){
    const israel = store.logistics.israel;
    const international = store.logistics.international;

    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card border-r-4 border-blue-500">
          <h4 class="font-bold text-blue-600 mb-4 text-lg"><i class="fas fa-map-marker-alt ml-2"></i> ×”×¤×¦×” ×‘××¨×¥</h4>
          <div class="space-y-3">
            ${israel.map(loc=>`
              <button class="w-full text-right p-3 bg-blue-50 rounded-lg flex justify-between items-center hover:bg-blue-100 transition"
                data-open="logistics_israel" data-id="${loc.id}">
                <div>
                  <div class="font-bold">${escapeHtml(loc.city)}</div>
                  <div class="text-xs text-slate-500 mt-1">
                    <span class="px-2 py-0.5 rounded ${loc.status==='×¤×¢×™×œ'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}">
                      ${escapeHtml(loc.status)}
                    </span>
                  </div>
                </div>
                <span class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full font-bold">${loc.books} ×¡×¤×¨×™×</span>
              </button>
            `).join('')}
          </div>
        </div>

        <div class="card border-r-4 border-purple-500">
          <h4 class="font-bold text-purple-600 mb-4 text-lg"><i class="fas fa-globe ml-2"></i> ×”×¤×¦×” ×‘×—×•×´×œ</h4>
          <div class="space-y-3">
            ${international.map(loc=>`
              <button class="w-full text-right p-3 bg-purple-50 rounded-lg flex justify-between items-center hover:bg-purple-100 transition"
                data-open="logistics_intl" data-id="${loc.id}">
                <div>
                  <div class="font-bold">${escapeHtml(loc.country)}</div>
                  <div class="text-xs text-slate-500 mt-1">
                    <span class="px-2 py-0.5 rounded ${
                      loc.status==='×¤×¢×™×œ'?'bg-green-100 text-green-700':
                      loc.status==='×‘×©×œ×™×—×”'?'bg-blue-100 text-blue-700':'bg-gray-100 text-gray-700'
                    }">${escapeHtml(loc.status)}</span>
                  </div>
                </div>
                <span class="text-xs bg-purple-600 text-white px-3 py-1 rounded-full font-bold">${loc.books} ×¡×¤×¨×™×</span>
              </button>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function render(){
    const content = $('#tab-content');

    if(currentTab==='book-detail' && currentBookContext){
      return renderBookDetail(content, currentBookContext.lang, currentBookContext.id);
    }
    if(currentTab==='tasks') return renderTasks(content);
    if(currentTab==='ideas') return renderIdeas(content);
    if(currentTab==='staff') return renderStaff(content);
    if(currentTab==='donors') return renderDonors(content);
    if(currentTab==='expenses') return renderExpenses(content);
    if(currentTab==='logistics') return renderLogistics(content);
    if(currentTab==='books-he') return renderBooks(content,'he');
    if(currentTab==='books-en') return renderBooks(content,'en');
  }

  // =========================
  // ADD MODAL (×§×¦×¨ + × ×©××¨ ××œ×)
  // =========================
  function showAddModal(){
    // ×× ×‘×ª×•×š ×¡×¤×¨
    if(currentTab==='book-detail' && currentBookContext){
      const {lang,id} = currentBookContext;
      modal.show('×”×•×¡×¤×” ×œ×¡×¤×¨', `
        <button class="w-full p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-right font-extrabold text-purple-700 transition flex items-center justify-between" id="add-pr">
          <span><i class="fas fa-print ml-2"></i> ×”×•×¡×£ ×©×•×¨×ª ×”×“×¤×¡×”</span><i class="fas fa-chevron-left"></i>
        </button>
        <button class="w-full p-4 bg-emerald-50 hover:bg-emerald-100 rounded-lg text-right font-extrabold text-emerald-700 transition flex items-center justify-between" id="add-bd">
          <span><i class="fas fa-hand-holding-heart ml-2"></i> ×”×•×¡×£ ×ª×•×¨× ×œ×¡×¤×¨</span><i class="fas fa-chevron-left"></i>
        </button>
        <div class="text-xs text-slate-400">* ×‘×¢××•×“ ×¡×¤×¨, â€œ×”×•×¡×£â€ ××ª×™×™×—×¡ ×œ× ×ª×•× ×™× ×©×œ ×”×¡×¤×¨.</div>
      `, null, '×©××•×¨', false);

      $('#add-pr').onclick = () => { modal.hide(); const b=findBook(lang,id); b.printRuns.unshift({year:new Date().getFullYear(),qty:0,printer:"",notes:""}); saveStore(); render(); notify('× ×•×¡×¤×” ×”×“×¤×¡×”'); };
      $('#add-bd').onclick = () => { modal.hide(); const b=findBook(lang,id); b.donors.unshift({id:uid(),name:'×ª×•×¨× ×—×“×©',amount:0,date:todayISO(),note:''}); saveStore(); render(); notify('× ×•×¡×£ ×ª×•×¨×'); };
      return;
    }

    // ××™×¤×•×™ ×¤×©×•×˜ ×œ×¡×›××•×ª
    const addMap = {
      tasks: { schema:'task', empty: ()=>({id:uid(), ××©×™××”:'', ×× ×”×œ:'', ×“×—×™×¤×•×ª:'×¨×’×™×œ×”', ×˜×•×•×—:'×—×•×“×©×™'}) },
      ideas: { schema:'idea', empty: ()=>({id:uid(), ×›×•×ª×¨×ª:'', ×ª×™××•×¨:'', ××’×™×©:store.staff[0]?.×©×||'', ×¡×˜×˜×•×¡:'×—×“×©', ×ª××¨×™×š:todayISO()}) },
      staff: { schema:'staff', empty: ()=>({id:uid(), ×©×:'', ×ª×¤×§×™×“:'', ×˜×œ×¤×•×Ÿ:'', ××™××™×™×œ:''}) },
      donors:{ schema:'donor', empty: ()=>({id:uid(), ×©×:'', ×¤×¨×•×™×§×˜:'', ××ª× ×”:'', ×ª××¨×™×š:todayISO()}) },
      expenses:{ schema:'expense', empty: ()=>({id:uid(), ×¡×¤×§:'', ×¡×›×•×:'', ×¡×˜×˜×•×¡:'×××ª×™×Ÿ'}) },
      logistics:{
        schema:null
      },
      'books-he': { schema:'book_he' },
      'books-en': { schema:'book_en' }
    };

    if(currentTab==='books-he' || currentTab==='books-en'){
      const lang = currentTab==='books-he' ? 'he' : 'en';
      modal.show(`×”×•×¡×¤×ª ×¡×¤×¨ ×—×“×© (${lang==='he'?'×¢×‘×¨×™×ª':'×× ×’×œ×™×ª'})`, `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          ${formField({k:'name',label:'×©× ×”×¡×¤×¨',type:'text',req:true},{})}
          ${formField({k:'target',label:'×™×¢×“ ×’×™×•×¡ (â‚ª)',type:'number',req:true},{})}
          ${formField({k:'raised',label:'× ×’×‘×” ×¢×“ ×›×” (â‚ª)',type:'number',req:true},{})}
          ${formField({k:'subtitle',label:'×›×•×ª×¨×ª ××©× ×” (××•×¤×¦×™×•× ×œ×™)',type:'text'},{})}
        </div>
      `, () => {
        const name = $('#f_name').value.trim();
        const target = parseInt($('#f_target').value||0);
        const raised = parseInt($('#f_raised').value||0);
        const subtitle = $('#f_subtitle').value||'';
        if(!name) return alert('× × ×œ×”×–×™×Ÿ ×©× ×¡×¤×¨');
        const b = {
          id: `${lang}-${uid()}`, name, target, raised, progress:0, donorsCount:0,
          identity:{ subtitle, author:"", editor:"", series:"", isbn:"", pages:0, trim: lang==='he'?'17Ã—24':'6Ã—9', binding:"", notes:"" },
          printRuns:[], donors:[]
        };
        recalcBookProgress(b);
        store.books[lang].unshift(b);
        saveStore();
        modal.hide();
        render();
        notify('×¡×¤×¨ × ×•×¡×£ âœ…');
      }, '×”×•×¡×£');
      $('#f_target').value = 50000;
      $('#f_raised').value = 0;
      return;
    }

    if(currentTab==='logistics'){
      modal.show('×”×•×¡×£ ×™×¢×“ ×œ×”×¤×¦×”', `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <button class="p-4 rounded-xl bg-blue-50 hover:bg-blue-100 font-extrabold text-blue-700 text-right" id="add-isr">
            <i class="fas fa-map-marker-alt ml-2"></i> ×™×¢×“ ×‘××¨×¥
          </button>
          <button class="p-4 rounded-xl bg-purple-50 hover:bg-purple-100 font-extrabold text-purple-700 text-right" id="add-intl">
            <i class="fas fa-globe ml-2"></i> ×™×¢×“ ×‘×—×•×´×œ
          </button>
        </div>
        <div class="text-xs text-slate-400 mt-3">* ××—×¨×™ ×”×•×¡×¤×” ××¤×©×¨ ×œ×œ×—×•×¥ ×¢×œ ×”×™×¢×“ ×•×œ×¢×¨×•×š.</div>
      `, null, '×©××•×¨', false);

      $('#add-isr').onclick = () => {
        store.logistics.israel.unshift({id:uid(), city:'×¢×™×¨ ×—×“×©×”', books:0, status:'×‘×”××ª× ×”'});
        saveStore(); modal.hide(); render(); notify('× ×•×¡×£ ×™×¢×“ ×‘××¨×¥');
      };
      $('#add-intl').onclick = () => {
        store.logistics.international.unshift({id:uid(), country:'××“×™× ×” ×—×“×©×”', books:0, status:'×‘×ª×›× ×•×Ÿ'});
        saveStore(); modal.hide(); render(); notify('× ×•×¡×£ ×™×¢×“ ×‘×—×•×´×œ');
      };
      return;
    }

    const cfg = addMap[currentTab];
    if(!cfg) return;

    const schemaKey = cfg.schema;
    const schema = SCHEMAS[schemaKey];
    const entity = cfg.empty();

    modal.show(`×”×•×¡×¤×”: ${$('#current-tab-title').innerText}`, `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${schema.fields.map(f => formField(f, entity[f.k] ?? '')).join('')}
      </div>
    `, () => {
      for(const f of schema.fields){
        const v = $(`#f_${f.k}`).value;
        if(f.req && !String(v).trim()) return alert('× × ×œ××œ× ×©×“×•×ª ×—×•×‘×”');
      }
      for(const f of schema.fields){
        let v = $(`#f_${f.k}`).value;
        if(f.type==='number') v = parseInt(v||0);
        entity[f.k] = v;
      }
      schema.list().push(entity);
      saveStore();
      modal.hide();
      render();
      notify('× ×•×¡×£ âœ¨');
    }, '×”×•×¡×£');
  }

  // =========================
  // EDIT DATA MODAL (×©×•××¨ "×¢×¨×•×š × ×ª×•× ×™×" ×‘×œ×™ ×œ××—×•×§)
  // =========================
  function showEditDataModal(){
    modal.show('×¢×¨×™×›×ª × ×ª×•× ×™× ×‘××¢×¨×›×ª', `
      <div class="space-y-3">
        <button class="w-full p-4 bg-blue-50 hover:bg-blue-100 rounded-lg text-right font-extrabold text-blue-700 transition flex items-center justify-between" data-bulk="staff">
          <span><i class="fas fa-users ml-2"></i> ×¢×¨×™×›×ª ×¦×•×•×ª ×”×¢×•×‘×“×™×</span><i class="fas fa-chevron-left"></i>
        </button>

        <button class="w-full p-4 bg-emerald-50 hover:bg-emerald-100 rounded-lg text-right font-extrabold text-emerald-700 transition flex items-center justify-between" data-bulk="books-he">
          <span><i class="fas fa-book ml-2"></i> ×¢×¨×™×›×ª ×¡×¤×¨×™× ×¢×‘×¨×™×ª</span><i class="fas fa-chevron-left"></i>
        </button>

        <button class="w-full p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-right font-extrabold text-purple-700 transition flex items-center justify-between" data-bulk="books-en">
          <span><i class="fas fa-language ml-2"></i> ×¢×¨×™×›×ª ×¡×¤×¨×™× ×× ×’×œ×™×ª</span><i class="fas fa-chevron-left"></i>
        </button>

        <button class="w-full p-4 bg-pink-50 hover:bg-pink-100 rounded-lg text-right font-extrabold text-pink-700 transition flex items-center justify-between" data-bulk="donors">
          <span><i class="fas fa-heart ml-2"></i> ×¢×¨×™×›×ª ×ª×•×¨××™× (×›×œ×œ×™)</span><i class="fas fa-chevron-left"></i>
        </button>

        <button class="w-full p-4 bg-red-50 hover:bg-red-100 rounded-lg text-right font-extrabold text-red-700 transition flex items-center justify-between" data-bulk="expenses">
          <span><i class="fas fa-file-invoice ml-2"></i> ×¢×¨×™×›×ª ×”×•×¦××•×ª</span><i class="fas fa-chevron-left"></i>
        </button>

        <button class="w-full p-4 bg-slate-50 hover:bg-slate-100 rounded-lg text-right font-extrabold text-slate-700 transition flex items-center justify-between" data-bulk="logistics">
          <span><i class="fas fa-shipping-fast ml-2"></i> ×¢×¨×™×›×ª ×”×¤×¦×”</span><i class="fas fa-chevron-left"></i>
        </button>
      </div>
    `, null, '×©××•×¨', false);
  }

  // =========================
  // EVENTS (delegation)
  // =========================
  document.body.addEventListener('click', (e) => {
    // tabs
    const tabEl = e.target.closest('[data-tab]');
    if(tabEl){
      const tab = tabEl.dataset.tab;
      switchTab(tab, {pushHistory:true});
    }

    // back
    if(e.target.closest('#btn-back')) goBack();

    // add / edit data / refresh
    if(e.target.closest('#btn-add')) showAddModal();
    if(e.target.closest('#btn-edit-data')) showEditDataModal();
    if(e.target.closest('#btn-refresh')){
      $('#refresh-icon').classList.add('animate-spin');
      setTimeout(()=>{
        $('#refresh-icon').classList.remove('animate-spin');
        render();
        notify('×”× ×ª×•× ×™× ×¨×•×¢× × ×•');
      }, 500);
    }

    // reset local
    if(e.target.closest('#btn-reset')){
      if(confirm('×œ××—×•×§ × ×ª×•× ×™× ×©××•×¨×™× ×‘×“×¤×“×¤×Ÿ ×•×œ×—×–×•×¨ ×œ×‘×¨×™×¨×ª ××—×“×œ?')){
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    // open entity edit
    const open = e.target.closest('[data-open]');
    if(open){
      openEditEntity(open.dataset.open, open.dataset.id);
    }

    // open book detail
    const ob = e.target.closest('[data-open-book]')?.dataset?.openBook;
    if(ob){
      const [lang,id] = ob.split('|');
      currentBookContext = {lang, id};
      switchTab('book-detail');
      render();
    }

    // tasks: owner filter quick
    const setOwner = e.target.closest('[data-set-owner]')?.dataset?.setOwner;
    if(setOwner !== undefined){
      selectedTaskOwner = setOwner || 'ALL';
      saveStore();
      if(currentTab==='tasks') render();
    }
    const filter = e.target.closest('[data-filter-tasks]')?.dataset?.filterTasks;
    if(filter){
      selectedTaskOwner = filter;
      switchTab('tasks');
    }

    // donors summary cards
    const sum = e.target.closest('[data-open-summary]')?.dataset?.openSummary;
    if(sum){
      const total = store.donors.reduce((s,d)=>s+parseInt(d.××ª× ×”||0),0);
      const avg = Math.round(total / Math.max(1, store.donors.length));
      const map = { total:{t:'×¡×”×´×› ×’×™×•×¡ ×”×—×•×“×©',b:money(total)}, count:{t:'×ª×•×¨××™× ×¤×¢×™×œ×™×',b:String(store.donors.length)}, avg:{t:'×××•×¦×¢ ×ª×¨×•××”',b:money(avg)} };
      modal.show(map[sum].t, `<div class="card bg-slate-50 border text-center"><div class="text-4xl font-extrabold">${map[sum].b}</div></div>`, null, '×©××•×¨', false);
    }

    // expenses: mark paid
    const mp = e.target.closest('[data-mark-paid]')?.dataset?.markPaid;
    if(mp){
      if(confirm('×œ×¡××Ÿ ×—×•×‘ ×–×” ×›×©×•×œ×?')){
        store.expenses = store.expenses.filter(x=>x.id!==mp);
        saveStore();
        render();
        notify('×¡×•××Ÿ ×›×©×•×œ× âœ…');
      }
    }

    // ideas: convert
    const it = e.target.closest('[data-idea-to-task]')?.dataset?.ideaToTask;
    if(it){
      const idea = store.ideas.find(x=>x.id===it);
      if(!idea) return;
      if(!confirm('×œ×”×¤×•×š ×¨×¢×™×•×Ÿ ×–×” ×œ××©×™××”?')) return;
      store.tasks.unshift({
        id: uid(),
        ××©×™××”: idea.×›×•×ª×¨×ª,
        ×× ×”×œ: idea.××’×™×© || (store.staff[0]?.×©× || ''),
        ×“×—×™×¤×•×ª: '×¨×’×™×œ×”',
        ×˜×•×•×—: '××¨×•×š'
      });
      idea.×¡×˜×˜×•×¡ = '××•×©×¨';
      saveStore();
      switchTab('tasks');
      notify('×”×•××¨ ×œ××©×™××” ğŸ¯');
    }

    // bulk editor routing
    const bulk = e.target.closest('[data-bulk]')?.dataset?.bulk;
    if(bulk){
      if(bulk==='staff'){
        modal.show('×¢×¨×™×›×ª ×¦×•×•×ª (×œ×—×™×¦×” ×¢×œ ×¢×•×‘×“ = ×¢×¨×™×›×”)', `
          <div class="space-y-2">
            ${store.staff.map(s=>`
              <button class="w-full p-3 bg-slate-50 rounded-xl text-right hover:bg-slate-100"
                data-open="staff" data-id="${s.id}">
                <div class="font-extrabold">${escapeHtml(s.×©×)}</div>
                <div class="text-xs text-slate-500">${escapeHtml(s.×ª×¤×§×™×“)}</div>
              </button>
            `).join('')}
            <button class="w-full p-3 border-2 border-dashed border-blue-300 rounded-xl text-blue-700 font-extrabold hover:bg-blue-50" id="bulk-add-staff">
              <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×¢×•×‘×“ ×—×“×©
            </button>
          </div>
        `, null, '×©××•×¨', false);
        $('#bulk-add-staff').onclick = ()=>{ store.staff.push({id:uid(),×©×:'×¢×•×‘×“ ×—×“×©',×ª×¤×§×™×“:'×ª×¤×§×™×“',×˜×œ×¤×•×Ÿ:'',××™××™×™×œ:''}); saveStore(); modal.hide(); render(); notify('×¢×•×‘×“ × ×•×¡×£'); };
      }
      if(bulk==='donors'){
        modal.show('×¢×¨×™×›×ª ×ª×•×¨××™× (×œ×—×™×¦×” ×¢×œ ×©×•×¨×” = ×¢×¨×™×›×”)', `
          <div class="space-y-2">
            ${store.donors.map(d=>`
              <button class="w-full p-3 bg-slate-50 rounded-xl text-right hover:bg-slate-100" data-open="donor" data-id="${d.id}">
                <div class="font-extrabold">${escapeHtml(d.×©×)} <span class="text-emerald-700">${money(parseInt(d.××ª× ×”||0))}</span></div>
                <div class="text-xs text-slate-500">${escapeHtml(d.×¤×¨×•×™×§×˜)} â€¢ ${escapeHtml(d.×ª××¨×™×š)}</div>
              </button>
            `).join('')}
            <button class="w-full p-3 border-2 border-dashed border-blue-300 rounded-xl text-blue-700 font-extrabold hover:bg-blue-50" id="bulk-add-donor">
              <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×ª×•×¨×
            </button>
          </div>
        `, null, '×©××•×¨', false);
        $('#bulk-add-donor').onclick = ()=>{ store.donors.push({id:uid(),×©×:'×ª×•×¨× ×—×“×©',×¤×¨×•×™×§×˜:'×¤×¨×•×™×§×˜',××ª× ×”:'1000',×ª××¨×™×š:todayISO()}); saveStore(); modal.hide(); render(); notify('×ª×•×¨× × ×•×¡×£'); };
      }
      if(bulk==='expenses'){
        modal.show('×¢×¨×™×›×ª ×”×•×¦××•×ª (×œ×—×™×¦×” = ×¢×¨×™×›×”)', `
          <div class="space-y-2">
            ${store.expenses.map(x=>`
              <button class="w-full p-3 bg-slate-50 rounded-xl text-right hover:bg-slate-100" data-open="expense" data-id="${x.id}">
                <div class="font-extrabold">${escapeHtml(x.×¡×¤×§)} <span class="text-red-700">${money(parseInt(x.×¡×›×•×||0))}</span></div>
                <div class="text-xs text-slate-500">${escapeHtml(x.×¡×˜×˜×•×¡||'')}</div>
              </button>
            `).join('')}
            <button class="w-full p-3 border-2 border-dashed border-blue-300 rounded-xl text-blue-700 font-extrabold hover:bg-blue-50" id="bulk-add-exp">
              <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×”×•×¦××”
            </button>
          </div>
        `, null, '×©××•×¨', false);
        $('#bulk-add-exp').onclick = ()=>{ store.expenses.push({id:uid(),×¡×¤×§:'×¡×¤×§ ×—×“×©',×¡×›×•×:'1000',×¡×˜×˜×•×¡:'×××ª×™×Ÿ'}); saveStore(); modal.hide(); render(); notify('×”×•×¦××” × ×•×¡×¤×”'); };
      }
      if(bulk==='logistics'){
        modal.show('×¢×¨×™×›×ª ×”×¤×¦×” (×œ×—×™×¦×” = ×¢×¨×™×›×”)', `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="p-3 rounded-xl bg-blue-50">
              <div class="font-extrabold text-blue-800 mb-2">×”×¤×¦×” ×‘××¨×¥</div>
              <div class="space-y-2">
                ${store.logistics.israel.map(x=>`
                  <button class="w-full p-3 bg-white/80 rounded-xl text-right hover:bg-white" data-open="logistics_israel" data-id="${x.id}">
                    <div class="font-extrabold">${escapeHtml(x.city)} â€¢ ${x.books} ×¡×¤×¨×™×</div>
                    <div class="text-xs text-slate-500">${escapeHtml(x.status)}</div>
                  </button>
                `).join('')}
              </div>
            </div>
            <div class="p-3 rounded-xl bg-purple-50">
              <div class="font-extrabold text-purple-800 mb-2">×”×¤×¦×” ×‘×—×•×´×œ</div>
              <div class="space-y-2">
                ${store.logistics.international.map(x=>`
                  <button class="w-full p-3 bg-white/80 rounded-xl text-right hover:bg-white" data-open="logistics_intl" data-id="${x.id}">
                    <div class="font-extrabold">${escapeHtml(x.country)} â€¢ ${x.books} ×¡×¤×¨×™×</div>
                    <div class="text-xs text-slate-500">${escapeHtml(x.status)}</div>
                  </button>
                `).join('')}
              </div>
            </div>
          </div>
        `, null, '×©××•×¨', false);
      }
      if(bulk==='books-he' || bulk==='books-en'){
        const lang = bulk==='books-he'?'he':'en';
        modal.show(`×¢×¨×™×›×ª ×¡×¤×¨×™× (${lang==='he'?'×¢×‘×¨×™×ª':'×× ×’×œ×™×ª'})`, `
          <div class="space-y-2">
            ${store.books[lang].map(b=>`
              <button class="w-full p-3 bg-slate-50 rounded-xl text-right hover:bg-slate-100" data-open-book="${lang}|${b.id}">
                <div class="font-extrabold">${escapeHtml(b.name)} <span class="text-emerald-700">${money(b.raised)}</span></div>
                <div class="text-xs text-slate-500">×™×¢×“: ${money(b.target)} â€¢ ${b.progress}%</div>
              </button>
            `).join('')}
            <button class="w-full p-3 border-2 border-dashed border-blue-300 rounded-xl text-blue-700 font-extrabold hover:bg-blue-50" id="bulk-add-book">
              <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×¡×¤×¨
            </button>
          </div>
        `, null, '×©××•×¨', false);
        $('#bulk-add-book').onclick = ()=>{ modal.hide(); switchTab(lang==='he'?'books-he':'books-en'); showAddModal(); };
      }
    }
  });

  document.body.addEventListener('change', (e) => {
    if(e.target.matches('[data-owner-select]')){
      selectedTaskOwner = e.target.value || 'ALL';
      saveStore();
      if(currentTab==='tasks') render();
    }
  });

  // expose for inline book fields
  window.setBookField = setBookField;

  // INIT
  $('#btn-back').onclick = goBack;
  switchTab('tasks', {pushHistory:false});
})();
</script>
</body>
</html>
