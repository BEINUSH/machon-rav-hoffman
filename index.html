<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>××¢×¨×›×ª × ×™×”×•×œ - ××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap');
    body { font-family: 'Assistant', sans-serif; background:#f8fafc; color:#1e293b; }
    .sidebar-link{transition:all .2s;border-radius:.75rem;margin-bottom:.25rem;display:flex;align-items:center;padding:.75rem 1rem;cursor:pointer}
    .sidebar-link:hover{background:#334155;color:#fff}
    .sidebar-link.active{background:#3b82f6;color:#fff}
    .card{background:#fff;border-radius:1rem;box-shadow:0 4px 6px -1px rgb(0 0 0 / .08);padding:1.25rem}
    .fade-in{animation:fadeIn .35s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .progress-bar{transition:width .6s ease-out}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .55rem;border-radius:999px;font-size:.75rem;font-weight:700}
    .btn{display:inline-flex;align-items:center;gap:.5rem;font-weight:800;border-radius:.75rem;padding:.55rem .9rem;transition:.15s}
    .btn:active{transform:scale(.98)}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-primary:hover{background:#1d4ed8}
    .btn-soft{background:#f1f5f9;color:#334155}
    .btn-soft:hover{background:#e2e8f0}
    .btn-purple{background:#7c3aed;color:#fff}
    .btn-purple:hover{background:#6d28d9}
    .btn-emerald{background:#059669;color:#fff}
    .btn-emerald:hover{background:#047857}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-danger:hover{background:#dc2626}
    .input{width:100%;padding:.75rem;border:2px solid #e2e8f0;border-radius:.75rem;outline:none}
    .input:focus{border-color:#3b82f6}
    .mini{font-size:11px}
  </style>
</head>

<body class="flex h-screen overflow-hidden">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-slate-800 text-slate-300 flex flex-col shadow-2xl z-20 overflow-y-auto shrink-0">
    <div class="p-6 border-b border-slate-700">
      <h1 class="text-white text-xl font-bold tracking-tight">××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ</h1>
      <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest">× ×™×”×•×œ ×•×”×•×¦××” ×œ××•×¨</p>
    </div>

    <nav id="sidebar" class="flex-1 p-4 space-y-1 text-sm"></nav>

    <div class="p-4 bg-slate-900 border-t border-slate-700 space-y-3">
      <div>
        <p class="text-[10px] text-slate-500 mb-1 font-bold">×‘×¢×œ×•×ª ×”×¢××•×ª×”:</p>
        <p class="text-xs font-bold text-white">×××™×¨ ×©××—×” ×©×˜×™×™×Ÿ</p>
      </div>

      <button onclick="resetLocalData()" class="w-full btn btn-soft justify-center bg-slate-800 hover:bg-slate-700 text-slate-200">
        <i class="fas fa-eraser"></i> × ×™×§×•×™ × ×ª×•× ×™× ×©××•×¨×™×
      </button>
      <p class="text-[10px] text-slate-500 leading-snug">* ××•×—×§ ×¨×§ × ×ª×•× ×™× ×©××•×¨×™× ×‘×“×¤×“×¤×Ÿ (LocalStorage).</p>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 flex flex-col min-w-0">
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm">
      <div class="flex items-center gap-3">
        <button id="btn-back" onclick="goBack()" class="hidden btn btn-soft">
          <i class="fas fa-arrow-right"></i> ×—×–×¨×”
        </button>
        <h2 id="current-tab-title" class="text-lg font-bold text-slate-800">â€”</h2>
      </div>

      <div class="flex gap-2">
        <button onclick="showAddModal()" class="btn btn-primary shadow-md">
          <i class="fas fa-plus"></i>
          <span id="add-btn-text">×”×•×¡×£ ×—×“×©</span>
        </button>

        <button onclick="showEditHub()" class="btn btn-purple shadow-md">
          <i class="fas fa-edit"></i> ×¢×¨×•×š × ×ª×•× ×™×
        </button>

        <button onclick="refreshData()" class="btn btn-soft">
          <i class="fas fa-sync-alt" id="refresh-icon"></i>
        </button>
      </div>
    </header>

    <div id="main-area" class="p-8 overflow-y-auto h-full bg-slate-50">
      <div id="tab-content" class="space-y-6"></div>
    </div>
  </main>

  <!-- MODAL -->
  <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden max-h-[90vh] flex flex-col">
      <div class="p-6 border-b bg-slate-50 flex items-center justify-between">
        <h3 id="modal-title" class="text-xl font-bold text-slate-800">â€”</h3>
        <button onclick="hideModal()" class="text-slate-400 hover:text-slate-700 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="p-6 space-y-4 overflow-y-auto flex-1" id="modal-body"></div>

      <div class="p-6 bg-white border-t flex justify-between items-center gap-2">
        <div id="modal-left-actions" class="flex gap-2"></div>
        <div class="flex gap-2">
          <button onclick="hideModal()" class="btn btn-soft">×‘×™×˜×•×œ</button>
          <button onclick="processSubmit()" id="btn-submit" class="btn btn-primary">
            <i class="fas fa-check"></i> ×©××•×¨
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   âœ… STORAGE
========================= */
const STORAGE_KEY = 'hoffman_admin_store_v2';
const uid = () => Math.random().toString(36).slice(2,10);
const todayISO = () => new Date().toISOString().split('T')[0];
const money = n => `â‚ª${Number(n||0).toLocaleString()}`;
const byId = id => document.getElementById(id);

function saveStore(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }catch(e){} }
function loadStore(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):null; }catch(e){ return null; } }
function resetLocalData(){ if(confirm('×œ××—×•×§ × ×ª×•× ×™× ×©××•×¨×™× ×‘×“×¤×“×¤×Ÿ ×•×œ×—×–×•×¨ ×œ×‘×¨×™×¨×ª ××—×“×œ?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } }

/* =========================
   âœ… DEFAULT DATA (× ×©××¨ ×”×›×œ + ×”×•×¡×¤× ×• IDEAS)
========================= */
let store = {
  tasks: [
    { id: uid(), ××©×™××”:"×”×›× ×ª ×—×©×‘×•× ×•×ª ×œ×ª×•×¨××™× ×—×•×“×© ×–×”", ×× ×”×œ:"××©×” ×›×”×Ÿ", ×“×—×™×¤×•×ª:"×’×‘×•×”×”", ×˜×•×•×—:"×—×•×“×©×™", ×”×¢×¨×•×ª:"" },
    { id: uid(), ××©×™××”:"×©×œ×™×—×ª ×¢×“×›×•×Ÿ ×œ×× ×•×™×™ ×”× ×™×•×–×œ×˜×¨", ×× ×”×œ:"×™×•×¡×™ ×œ×•×™", ×“×—×™×¤×•×ª:"×’×‘×•×”×”", ×˜×•×•×—:"×—×•×“×©×™", ×”×¢×¨×•×ª:"" },
    { id: uid(), ××©×™××”:"×‘×™×§×•×¨ ××¦×œ ××•×´×œ ×‘× ×™ ×‘×¨×§", ×× ×”×œ:"×“×•×“ ×’×•×œ×“", ×“×—×™×¤×•×ª:"×’×‘×•×”×”", ×˜×•×•×—:"×—×•×“×©×™", ×”×¢×¨×•×ª:"" },
    { id: uid(), ××©×™××”:"×ª×™××•× ×¤×’×™×©×ª ×ª×›× ×•×Ÿ ×©× ×” ×”×‘××”", ×× ×”×œ:"××©×” ×›×”×Ÿ", ×“×—×™×¤×•×ª:"×¨×’×™×œ×”", ×˜×•×•×—:"××¨×•×š", ×”×¢×¨×•×ª:"" },
    { id: uid(), ××©×™××”:"×¢×“×›×•×Ÿ ××ª×¨ ×”××™× ×˜×¨× ×˜", ×× ×”×œ:"×™×•×¡×™ ×œ×•×™", ×“×—×™×¤×•×ª:"×¨×’×™×œ×”", ×˜×•×•×—:"××¨×•×š", ×”×¢×¨×•×ª:"" }
  ],
  staff: [
    { id: uid(), ×©×:"××©×” ×›×”×Ÿ", ×ª×¤×§×™×“:"×× ×”×œ ×›×œ×œ×™", ×˜×œ×¤×•×Ÿ:"050-1234567", ××™××™×™×œ:"moshe@hoffman.org" },
    { id: uid(), ×©×:"×™×•×¡×™ ×œ×•×™", ×ª×¤×§×™×“:"×× ×”×œ ×©×™×•×•×§", ×˜×œ×¤×•×Ÿ:"052-7654321", ××™××™×™×œ:"yossi@hoffman.org" },
    { id: uid(), ×©×:"×“×•×“ ×’×•×œ×“", ×ª×¤×§×™×“:"×œ×•×’×™×¡×˜×™×§×”", ×˜×œ×¤×•×Ÿ:"054-9876543", ××™××™×™×œ:"david@hoffman.org" },
    { id: uid(), ×©×:"×©×¨×” ×’×¨×™×Ÿ", ×ª×¤×§×™×“:"×¢×•×¨×›×ª ×¨××©×™×ª", ×˜×œ×¤×•×Ÿ:"050-5555555", ××™××™×™×œ:"sara@hoffman.org" }
  ],
  ideas: [
    { id: uid(), ×›×•×ª×¨×ª:"×œ×¢×©×•×ª ×ª×‘× ×™×ª PDF ××•×˜×•××˜×™×ª ×œ×“×•×— ×ª×•×¨××™×", ××¦×™×¢:"×™×•×¡×™ ×œ×•×™", ×ª××¨×™×š: todayISO(), ×¡×˜×˜×•×¡:"×—×“×©", ×¤×¨×˜×™×:"××¤×©×¨ ×œ×”×•×¡×™×£ ×›×¤×ª×•×¨ Export ×‘×¢×ª×™×“" },
    { id: uid(), ×›×•×ª×¨×ª:"×œ×”×•×¡×™×£ ×¢××•×“ '×¡×¤×¨×™× ×©×”×•×œ×›×™× ×œ×“×¤×•×¡' ×¢× ×ª××¨×™×š ×™×¢×“", ××¦×™×¢:"×©×¨×” ×’×¨×™×Ÿ", ×ª××¨×™×š: todayISO(), ×¡×˜×˜×•×¡:"×‘×‘×“×™×§×”", ×¤×¨×˜×™×:"×›×•×œ×œ ×¤×¡ ×”×ª×§×“××•×ª ××•×œ ×“×“×œ×™×™×Ÿ" }
  ],
  books: {
    he: [
      { id:"he-mechunach", name:"×”××—×•× ×š", progress:90, target:25000, raised:22500, donorsCount:15,
        identity:{ subtitle:"××”×“×•×¨×” ××ª×•×§× ×ª ×•××•×¨×—×‘×ª", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×›×¨×™×›×” ×§×©×”", notes:"" },
        printRuns:[{year:2018,qty:4000,printer:"",notes:"×”×“×¤×¡×” ×¨××©×•× ×”"},{year:2020,qty:7000,printer:"",notes:""}],
        donors:[{id:uid(),name:"××‘×¨×”× ×›×”×Ÿ",amount:5000,date:"2025-02-01",note:"×ª××™×›×” ×›×œ×œ×™×ª"}]
      },
      { id:"he-yesodot", name:"×™×¡×•×“×•×ª ×”×—×™× ×•×š", progress:65, target:50000, raised:32500, donorsCount:12,
        identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
        printRuns:[{year:2021,qty:4000,printer:"",notes:""}], donors:[]
      },
      { id:"he-modaot", name:"××•×“×¢×•×ª", progress:82, target:40000, raised:32800, donorsCount:18,
        identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
        printRuns:[{year:2022,qty:5000,printer:"",notes:""}], donors:[]
      },
      { id:"he-shidduchim", name:"×©×™×“×•×›×™×", progress:45, target:35000, raised:15750, donorsCount:8,
        identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
        printRuns:[], donors:[]
      },
      { id:"he-al-hapachad", name:"×¢×œ ×”×¤×—×“", progress:28, target:30000, raised:8400, donorsCount:5,
        identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
        printRuns:[], donors:[]
      },
      { id:"he-kmayim", name:"×›××™×", progress:55, target:45000, raised:24750, donorsCount:11,
        identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
        printRuns:[], donors:[]
      }
    ],
    en: [
      { id:"en-awareness", name:"Awareness (××•×“×¢×•×ª)", progress:70, target:60000, raised:42000, donorsCount:22,
        identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Hardcover", notes:"" },
        printRuns:[], donors:[]
      },
      { id:"en-shidduchim", name:"Shidduchim (×©×™×“×•×›×™×)", progress:40, target:50000, raised:20000, donorsCount:10,
        identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Paperback", notes:"" },
        printRuns:[], donors:[]
      },
      { id:"en-foundations", name:"Foundations of Education", progress:55, target:55000, raised:30250, donorsCount:14,
        identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Paperback", notes:"" },
        printRuns:[], donors:[]
      },
      { id:"en-like-water", name:"Like Water (×›××™×)", progress:35, target:40000, raised:14000, donorsCount:7,
        identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Paperback", notes:"" },
        printRuns:[], donors:[]
      }
    ]
  },
  donors: [
    { id: uid(), ×©×:"××‘×¨×”× ×›×”×Ÿ", ×¤×¨×•×™×§×˜:"×™×¡×•×“×•×ª ×”×—×™× ×•×š", ××ª× ×”:"5000", ×ª××¨×™×š:"2025-02-01" },
    { id: uid(), ×©×:"×©×¨×” ×œ×•×™", ×¤×¨×•×™×§×˜:"×©×™×“×•×›×™×", ××ª× ×”:"3500", ×ª××¨×™×š:"2025-02-05" },
    { id: uid(), ×©×:"×™×¢×§×‘ ×’×¨×™× ×‘×¨×’", ×¤×¨×•×™×§×˜:"××•×“×¢×•×ª", ××ª× ×”:"7200", ×ª××¨×™×š:"2025-01-10" },
    { id: uid(), ×©×:"×¨×—×œ ×©×•×•×¨×¥", ×¤×¨×•×™×§×˜:"×›××™×", ××ª× ×”:"2800", ×ª××¨×™×š:"2025-02-05" }
  ],
  expenses: [
    { id: uid(), ×¡×¤×§:"×“×¤×•×¡ ××¨×›×–", ×¡×›×•×:"12500", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ" },
    { id: uid(), ×¡×¤×§:"××©×¨×“ - ×©×›×™×¨×•×ª ×—×•×“×©×™×ª", ×¡×›×•×:"1000", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ" },
    { id: uid(), ×¡×¤×§:"×’××´×— ×”×¡×¤×¨×™×", ×¡×›×•×:"8300", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ" },
    { id: uid(), ×¡×¤×§:"×©×œ×™×—×•×™×•×ª ×‘×™× ×´×œ", ×¡×›×•×:"4200", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ" }
  ],
  logistics: {
    israel: [
      { id: uid(), city:"×™×¨×•×©×œ×™×", books:350, status:"×¤×¢×™×œ" },
      { id: uid(), city:"×‘× ×™ ×‘×¨×§", books:280, status:"×¤×¢×™×œ" },
      { id: uid(), city:"×¦×¤×ª", books:120, status:"×¤×¢×™×œ" },
      { id: uid(), city:"×‘××¨ ×©×‘×¢", books:95, status:"×‘×”××ª× ×”" }
    ],
    international: [
      { id: uid(), country:"××¨×”×´×‘", books:500, status:"×‘×©×œ×™×—×”" },
      { id: uid(), country:"×× ×’×œ×™×”", books:180, status:"×¤×¢×™×œ" },
      { id: uid(), country:"×¦×¨×¤×ª", books:95, status:"×¤×¢×™×œ" },
      { id: uid(), country:"××•×¡×˜×¨×œ×™×”", books:65, status:"×‘×ª×›× ×•×Ÿ" }
    ]
  }
};

// load persisted
const loaded = loadStore();
if(loaded && typeof loaded === 'object'){
  // merge-friendly: ×× ×—×¡×¨×™× ×©×“×•×ª ×—×“×©×™× ×›××• ideas â€“ × ×©×œ×™×
  store = { ...store, ...loaded };
  store.ideas = store.ideas || [];
  store.tasks = store.tasks || [];
  store.staff = store.staff || [];
  store.donors = store.donors || [];
  store.expenses = store.expenses || [];
  store.books = store.books || {he:[],en:[]};
  store.logistics = store.logistics || {israel:[], international:[]};
}

/* =========================
   âœ… THEME BY MANAGER
========================= */
const PALETTE = [
  { base:'#2563eb', soft:'#eff6ff', text:'#1d4ed8' },
  { base:'#16a34a', soft:'#ecfdf5', text:'#15803d' },
  { base:'#7c3aed', soft:'#f5f3ff', text:'#6d28d9' },
  { base:'#f59e0b', soft:'#fffbeb', text:'#b45309' },
  { base:'#ef4444', soft:'#fef2f2', text:'#b91c1c' },
  { base:'#0ea5e9', soft:'#f0f9ff', text:'#0284c7' },
  { base:'#14b8a6', soft:'#f0fdfa', text:'#0f766e' },
  { base:'#64748b', soft:'#f1f5f9', text:'#334155' },
];
function managerIndex(name){
  const idx = store.staff.findIndex(s => s.×©× === name);
  if(idx >= 0) return idx % PALETTE.length;
  let hash=0; for(const ch of String(name||'')) hash=(hash*31+ch.charCodeAt(0))>>>0;
  return hash % PALETTE.length;
}
function managerTheme(name){ return PALETTE[managerIndex(name)]; }
function taskCountFor(name){ return store.tasks.filter(t => t.×× ×”×œ === name).length; }

/* =========================
   âœ… STATE + NAV
========================= */
let currentTab = 'tasks';
let historyStack = [];
let selectedTaskOwner = 'ALL';
let currentBookContext = null; // {lang,id}
let submitHandler = null;

const TABS = [
  { section:'× ×™×”×•×œ ×©×•×˜×£', items:[
    { id:'tasks', label:'××©×™××•×ª ×•×œ×•"×–', icon:'fa-list-ul' },
    { id:'staff', label:'×¢×•×‘×“×™ ×”××›×•×Ÿ', icon:'fa-users-cog' },
    { id:'ideas', label:'×¨×¢×™×•× ×•×ª ×¢×•×‘×“×™×', icon:'fa-lightbulb' }, // âœ… ×—×“×©
  ]},
  { section:'××¢×¨×š ×”×¡×¤×¨×™×', items:[
    { id:'books-he', label:'×¡×¤×¨×™× - ×¢×‘×¨×™×ª', icon:'fa-book' },
    { id:'books-en', label:'××“×•×¨ ×× ×’×œ×™×ª', icon:'fa-language' },
  ]},
  { section:'×›×¡×¤×™× ×•×œ×•×’×™×¡×˜×™×§×”', items:[
    { id:'donors', label:'×’×™×•×¡ ×›×¡×¤×™×', icon:'fa-hand-holding-heart' },
    { id:'logistics', label:'×”×¤×¦×” ×•×—×•"×œ', icon:'fa-shipping-fast' },
    { id:'expenses', label:'×—×•×‘×•×ª ×œ×¡×¤×§×™×', icon:'fa-file-invoice-dollar' },
  ]},
];

const TAB_TITLES = {
  'tasks': '××©×™××•×ª ×•×œ×•"×– ×‘×™×¦×•×¢',
  'staff': '×¢×•×‘×“×™ ×”××›×•×Ÿ ×•×¦×•×•×ª ×”× ×™×”×•×œ',
  'ideas': '×¨×¢×™×•× ×•×ª ×¢×•×‘×“×™× (×œ×—×™×¥ + ×”××¨×” ×œ××©×™××”)',
  'books-he': '××¢×¨×š ×”×¡×¤×¨×™× - ×¢×‘×¨×™×ª (×œ×—×™×¦×” ×¢×œ ×¡×¤×¨ = ×¢××•×“ ××œ×)',
  'books-en': 'International Division - English (Click a book)',
  'donors': '×’×™×•×¡ ×›×¡×¤×™× ×•×ª×•×¨××™× ××§×˜×•××œ×™×™×',
  'logistics': '×”×¤×¦×” ×‘××¨×¥ ×•×‘×—×•×´×œ',
  'expenses': '×—×•×‘×•×ª ×œ×¡×¤×§×™× ×•×¢×œ×•×™×•×ª ×©×•×˜×¤×•×ª',
  'book-detail': '×ª×¢×•×“×ª ×–×”×•×ª ×©×œ ×¡×¤×¨'
};

function buildSidebar(){
  const nav = byId('sidebar');
  nav.innerHTML = TABS.map(block => `
    <div class="text-[10px] font-bold text-slate-500 px-4 ${block.section==='× ×™×”×•×œ ×©×•×˜×£'?'mb-2':'mt-6 mb-2'} uppercase">${block.section}</div>
    ${block.items.map(it => `
      <div onclick="switchTab('${it.id}')" class="nav-item sidebar-link" id="btn-${it.id}">
        <i class="fas ${it.icon} ml-3"></i> ${it.label}
      </div>
    `).join('')}
  `).join('');
}

function setBackButton(visible){ byId('btn-back').classList.toggle('hidden', !visible); }

function setAddButtonText(){
  const map = {
    'tasks':'×”×•×¡×£ ××©×™××”',
    'staff':'×”×•×¡×£ ×¢×•×‘×“',
    'ideas':'×”×•×¡×£ ×¨×¢×™×•×Ÿ',
    'donors':'×”×•×¡×£ ×ª×¨×•××”',
    'expenses':'×”×•×¡×£ ×”×•×¦××”',
    'logistics':'×”×•×¡×£ ×™×¢×“',
    'books-he':'×”×•×¡×£ ×¡×¤×¨',
    'books-en':'×”×•×¡×£ ×¡×¤×¨',
    'book-detail':'×”×•×¡×£ × ×ª×•×Ÿ'
  };
  byId('add-btn-text').innerText = map[currentTab] || '×”×•×¡×£ ×—×“×©';
}

function switchTab(tabId, opts={pushHistory:true}){
  if(tabId !== 'book-detail') currentBookContext = null;
  if(opts.pushHistory) historyStack.push(currentTab);
  currentTab = tabId;
  setAddButtonText();

  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const btn = byId('btn-' + tabId); if(btn) btn.classList.add('active');

  const content = byId('tab-content');
  const title = byId('current-tab-title');
  title.innerText = TAB_TITLES[tabId] || '××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ';

  content.classList.remove('fade-in'); void content.offsetWidth; content.classList.add('fade-in');
  setBackButton(tabId === 'book-detail');

  const renderers = {
    'tasks': renderTasks,
    'staff': renderStaff,
    'ideas': renderIdeas,
    'donors': renderDonors,
    'expenses': renderExpenses,
    'logistics': renderLogistics,
    'books-he': (el)=>renderBooks(el,'he'),
    'books-en': (el)=>renderBooks(el,'en'),
    'book-detail': (el)=>currentBookContext && renderBookDetail(el, currentBookContext.lang, currentBookContext.id)
  };
  (renderers[tabId] || (()=>{ content.innerHTML = `<div class="card">×œ× × ××¦× ×˜××‘</div>`; }))(content);
}

function goBack(){
  const prev = historyStack.pop();
  if(!prev) return switchTab('tasks', {pushHistory:false});
  switchTab(prev, {pushHistory:false});
}

function refreshData(){
  const icon = byId('refresh-icon');
  icon.classList.add('animate-spin');
  setTimeout(()=>{
    icon.classList.remove('animate-spin');
    if(currentTab === 'book-detail' && currentBookContext){
      renderBookDetail(byId('tab-content'), currentBookContext.lang, currentBookContext.id);
    }else{
      switchTab(currentTab, {pushHistory:false});
    }
    showNotification('×”× ×ª×•× ×™× ×¨×•×¢× × ×• ×‘×”×¦×œ×—×”');
  }, 500);
}

/* =========================
   âœ… UTIL
========================= */
function escapeHtml(str){
  return String(str)
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#039;");
}
function findBook(lang,id){ return (store.books[lang]||[]).find(b => b.id === id); }
function recalcBook(b){
  b.progress = Math.max(0, Math.min(100, Math.round((Number(b.raised||0) / Math.max(1, Number(b.target||0))) * 100))));
}
function showNotification(msg){
  const n = document.createElement('div');
  n.className = 'fixed top-10 left-1/2 transform -translate-x-1/2 bg-emerald-600 text-white px-8 py-3 rounded-lg shadow-2xl z-50 font-extrabold';
  n.innerHTML = `<i class="fas fa-check-circle ml-2"></i> ${msg}`;
  document.body.appendChild(n);
  setTimeout(()=>{ n.style.opacity='0'; n.style.transition='opacity .25s'; setTimeout(()=>n.remove(),260); }, 2200);
}

/* =========================
   âœ… GENERIC MODAL
========================= */
function showModal(title, bodyHtml, {onSubmit=null, submitText='×©××•×¨', leftActionsHtml='' }={}){
  byId('modal-title').innerText = title;
  byId('modal-body').innerHTML = bodyHtml;
  byId('modal-left-actions').innerHTML = leftActionsHtml || '';
  byId('modal').classList.remove('hidden');

  submitHandler = onSubmit;
  byId('btn-submit').style.display = onSubmit ? 'inline-flex' : 'none';
  byId('btn-submit').innerHTML = `<i class="fas fa-check"></i> ${submitText}`;
}
function hideModal(){
  byId('modal').classList.add('hidden');
  byId('btn-submit').style.display = 'inline-flex';
  byId('modal-left-actions').innerHTML = '';
  submitHandler = null;
}
function processSubmit(){ if(typeof submitHandler === 'function') submitHandler(); }

/* =========================
   âœ… CLICKABLE EDITABLE CARDS (×›×œ ×“×‘×¨ ×œ×—×™×¥)
   - ×¤×ª×™×—×ª ×›×¨×˜×™×¡ = ×˜×•×¤×¡ ×¢×¨×™×›×” ××™×“×™ + ×¤×¢×•×œ×•×ª
========================= */
function openTaskCard(idx){
  const t = store.tasks[idx];
  if(!t) return;
  const th = managerTheme(t.×× ×”×œ);
  showModal(
    `××©×™××”: ${t.××©×™××”}`,
    `
      <div class="p-4 rounded-xl border" style="background:${th.soft}; border-color:${th.base}">
        <div class="text-xs font-extrabold" style="color:${th.text}">××—×¨××™: ${escapeHtml(t.×× ×”×œ)}</div>
        <div class="text-[10px]" style="color:${th.text}99">×“×—×™×¤×•×ª: ${escapeHtml(t.×“×—×™×¤×•×ª)} â€¢ ×˜×•×•×—: ${escapeHtml(t.×˜×•×•×—)}</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="mini font-extrabold text-slate-600">×ª×™××•×¨</label>
          <input class="input" id="t-name" value="${escapeHtml(t.××©×™××”)}"/>
        </div>
        <div>
          <label class="mini font-extrabold text-slate-600">××—×¨××™</label>
          <select class="input" id="t-manager">
            ${store.staff.map(s => `<option ${s.×©×===t.×× ×”×œ?'selected':''} value="${escapeHtml(s.×©×)}">${escapeHtml(s.×©×)}</option>`).join('')}
          </select>
        </div>
        <div>
          <label class="mini font-extrabold text-slate-600">×“×—×™×¤×•×ª</label>
          <select class="input" id="t-urg">
            ${['×¨×’×™×œ×”','×’×‘×•×”×”'].map(v => `<option ${v===t.×“×—×™×¤×•×ª?'selected':''} value="${v}">${v}${v==='×’×‘×•×”×”'?' ğŸ”¥':''}</option>`).join('')}
          </select>
        </div>
        <div>
          <label class="mini font-extrabold text-slate-600">×˜×•×•×—</label>
          <select class="input" id="t-time">
            ${['×—×•×“×©×™','××¨×•×š'].map(v => `<option ${v===t.×˜×•×•×—?'selected':''} value="${v}">${v}</option>`).join('')}
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="mini font-extrabold text-slate-600">×”×¢×¨×•×ª</label>
          <textarea class="input" id="t-note" rows="3" placeholder="×”×¢×¨×•×ª...">${escapeHtml(t.×”×¢×¨×•×ª||'')}</textarea>
        </div>
      </div>
    `,
    {
      onSubmit: ()=>{
        t.××©×™××” = byId('t-name').value.trim();
        t.×× ×”×œ  = byId('t-manager').value;
        t.×“×—×™×¤×•×ª= byId('t-urg').value;
        t.×˜×•×•×—  = byId('t-time').value;
        t.×”×¢×¨×•×ª = byId('t-note').value;
        saveStore(); hideModal(); switchTab('tasks',{pushHistory:false}); showNotification('×”××©×™××” ×¢×•×“×›× ×” âœ…');
      },
      submitText: '×©××•×¨ ×©×™× ×•×™×™×',
      leftActionsHtml: `
        <button class="btn btn-emerald" onclick="completeTask(${idx})"><i class="fas fa-check"></i> ×¡××Ÿ ×›×‘×•×¦×¢</button>
        <button class="btn btn-danger" onclick="deleteTask(${idx})"><i class="fas fa-trash"></i> ××—×§</button>
      `
    }
  );
}
function completeTask(idx){
  if(confirm('×œ×¡××Ÿ ××©×™××” ×–×• ×›×‘×•×¦×¢×” (×•×œ×”×¡×™×¨ ××”×¨×©×™××”)?')){
    store.tasks.splice(idx,1);
    saveStore(); hideModal(); switchTab('tasks',{pushHistory:false}); showNotification('×¡×•××Ÿ ×›×‘×•×¦×¢ ğŸ‰');
  }
}
function deleteTask(idx){
  if(confirm('×œ××—×•×§ ××ª ×”××©×™××”?')){
    store.tasks.splice(idx,1);
    saveStore(); hideModal(); switchTab('tasks',{pushHistory:false}); showNotification('× ××—×§ âœ…');
  }
}

function openStaffCard(idx){
  const s = store.staff[idx];
  if(!s) return;
  const th = managerTheme(s.×©×);
  showModal(
    `×¢×•×‘×“: ${s.×©×}`,
    `
      <div class="p-4 rounded-xl border" style="background:${th.soft}; border-color:${th.base}">
        <div class="font-extrabold" style="color:${th.text}">${escapeHtml(s.×ª×¤×§×™×“)}</div>
        <div class="mini" style="color:${th.text}aa">×œ×—×™×¦×” ×¢×œ ××©×™××•×ª ×©×œ×• ×¢×•×‘×“×ª ×’× ×›××Ÿ</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        ${inputRow('×©×', 's-name', s.×©×)}
        ${inputRow('×ª×¤×§×™×“', 's-role', s.×ª×¤×§×™×“)}
        ${inputRow('×˜×œ×¤×•×Ÿ', 's-phone', s.×˜×œ×¤×•×Ÿ)}
        ${inputRow('××™××™×™×œ', 's-email', s.××™××™×™×œ)}
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button class="btn btn-soft" onclick="selectedTaskOwner='${escapeHtml(s.×©×)}'; hideModal(); switchTab('tasks',{pushHistory:true});">
          <i class="fas fa-eye"></i> ×”×¦×’ â€œ×”××©×™××•×ª ×©×œ×™â€
        </button>
        <button class="btn btn-soft" onclick="copyText('${escapeHtml(s.××™××™×™×œ)}')"><i class="fas fa-copy"></i> ×”×¢×ª×§ ××™××™×™×œ</button>
        <button class="btn btn-soft" onclick="copyText('${escapeHtml(s.×˜×œ×¤×•×Ÿ)}')"><i class="fas fa-copy"></i> ×”×¢×ª×§ ×˜×œ×¤×•×Ÿ</button>
      </div>

      <div class="mt-5">
        <div class="font-extrabold text-slate-700 mb-2"><i class="fas fa-list-check ml-2 text-slate-400"></i> ××©×™××•×ª ×©×œ ×”×¢×•×‘×“</div>
        <div class="space-y-2">
          ${store.tasks.filter(t=>t.×× ×”×œ===s.×©×).slice(0,8).map(t=>{
            const th2 = managerTheme(t.×× ×”×œ);
            const i = store.tasks.indexOf(t);
            return `
              <button class="w-full text-right p-3 rounded-xl border hover:shadow-sm transition"
                style="background:${th2.soft}; border-color:${th2.base}"
                onclick="openTaskCard(${i})">
                <div class="font-extrabold" style="color:${th2.text}">${escapeHtml(t.××©×™××”)}</div>
                <div class="mini text-slate-500">×“×—×™×¤×•×ª: ${escapeHtml(t.×“×—×™×¤×•×ª)} â€¢ ×˜×•×•×—: ${escapeHtml(t.×˜×•×•×—)}</div>
              </button>
            `;
          }).join('') || `<div class="text-sm text-slate-500">××™×Ÿ ×›×¨×’×¢ ××©×™××•×ª.</div>`}
        </div>
      </div>
    `,
    {
      onSubmit: ()=>{
        const oldName = s.×©×;
        s.×©× = byId('s-name').value.trim() || s.×©×;
        s.×ª×¤×§×™×“ = byId('s-role').value;
        s.×˜×œ×¤×•×Ÿ = byId('s-phone').value;
        s.××™××™×™×œ = byId('s-email').value;

        // âœ… ×× ×©×™× ×• ×©× ×¢×•×‘×“: ×œ×¢×“×›×Ÿ ××©×™××•×ª ×©×œ×•
        if(oldName !== s.×©×){
          store.tasks.forEach(t=>{ if(t.×× ×”×œ===oldName) t.×× ×”×œ = s.×©×; });
          store.ideas.forEach(i=>{ if(i.××¦×™×¢===oldName) i.××¦×™×¢ = s.×©×; });
        }

        saveStore(); hideModal(); switchTab('staff',{pushHistory:false}); showNotification('×”×¢×•×‘×“ ×¢×•×“×›×Ÿ âœ…');
      },
      submitText:'×©××•×¨ ×¢×•×‘×“',
      leftActionsHtml:`<button class="btn btn-danger" onclick="deleteStaff(${idx})"><i class="fas fa-trash"></i> ××—×§ ×¢×•×‘×“</button>`
    }
  );
}
function deleteStaff(idx){
  if(confirm('×œ××—×•×§ ×¢×•×‘×“ ×–×”? (×œ× ××•×—×§ ××©×™××•×ª, ×¨×§ ××©××™×¨ ××ª ×©××• ×›×¤×™ ×©×”×™×”)')){
    store.staff.splice(idx,1);
    saveStore(); hideModal(); switchTab('staff',{pushHistory:false}); showNotification('×”×¢×•×‘×“ × ××—×§ âœ…');
  }
}

function openIdeaCard(idx){
  const it = store.ideas[idx];
  if(!it) return;
  showModal(
    `×¨×¢×™×•×Ÿ: ${it.×›×•×ª×¨×ª}`,
    `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        ${inputRow('×›×•×ª×¨×ª', 'i-title', it.×›×•×ª×¨×ª)}
        <div>
          <label class="mini font-extrabold text-slate-600">××¦×™×¢</label>
          <select class="input" id="i-by">
            ${store.staff.map(s => `<option ${s.×©×===it.××¦×™×¢?'selected':''} value="${escapeHtml(s.×©×)}">${escapeHtml(s.×©×)}</option>`).join('')}
            <option ${!store.staff.some(s=>s.×©×===it.××¦×™×¢)?'selected':''} value="${escapeHtml(it.××¦×™×¢||'')}">${escapeHtml(it.××¦×™×¢||'â€”')}</option>
          </select>
        </div>
        <div>
          <label class="mini font-extrabold text-slate-600">×ª××¨×™×š</label>
          <input class="input" id="i-date" type="date" value="${escapeHtml(it.×ª××¨×™×š||todayISO())}"/>
        </div>
        <div>
          <label class="mini font-extrabold text-slate-600">×¡×˜×˜×•×¡</label>
          <select class="input" id="i-status">
            ${['×—×“×©','×‘×‘×“×™×§×”','××•×©×¨','×‘×•×¦×¢','× ×“×—×”'].map(v => `<option ${v===it.×¡×˜×˜×•×¡?'selected':''} value="${v}">${v}</option>`).join('')}
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="mini font-extrabold text-slate-600">×¤×¨×˜×™×</label>
          <textarea class="input" id="i-notes" rows="4" placeholder="×ª×™××•×¨ ×§×¦×¨...">${escapeHtml(it.×¤×¨×˜×™×||'')}</textarea>
        </div>
      </div>

      <div class="mt-4 p-4 rounded-xl bg-slate-50 border">
        <div class="font-extrabold text-slate-700 mb-1"><i class="fas fa-wand-magic-sparkles ml-2 text-slate-400"></i> ×©×“×¨×•×’ ×—×›×</div>
        <div class="text-sm text-slate-500">××¤×©×¨ ×œ×”×¤×•×š ×¨×¢×™×•×Ÿ ×œ××©×™××” ×‘×œ×—×™×¦×” â€” ×•××– ×”×•× × ×›× ×¡ ×œ×˜××‘ ××©×™××•×ª ×¢× ××—×¨××™ ×•×“×—×™×¤×•×ª.</div>
      </div>
    `,
    {
      onSubmit: ()=>{
        it.×›×•×ª×¨×ª = byId('i-title').value.trim();
        it.××¦×™×¢ = byId('i-by').value;
        it.×ª××¨×™×š = byId('i-date').value;
        it.×¡×˜×˜×•×¡ = byId('i-status').value;
        it.×¤×¨×˜×™× = byId('i-notes').value;
        saveStore(); hideModal(); switchTab('ideas',{pushHistory:false}); showNotification('×”×¨×¢×™×•×Ÿ ×¢×•×“×›×Ÿ âœ…');
      },
      submitText:'×©××•×¨ ×¨×¢×™×•×Ÿ',
      leftActionsHtml: `
        <button class="btn btn-emerald" onclick="ideaToTask(${idx})"><i class="fas fa-arrow-turn-down"></i> ×”×¤×•×š ×œ××©×™××”</button>
        <button class="btn btn-danger" onclick="deleteIdea(${idx})"><i class="fas fa-trash"></i> ××—×§</button>
      `
    }
  );
}
function ideaToTask(idx){
  const it = store.ideas[idx];
  if(!it) return;
  const manager = it.××¦×™×¢ || (store.staff[0]?.×©× || '×œ×œ× ××—×¨××™');
  store.tasks.unshift({
    id: uid(),
    ××©×™××”: it.×›×•×ª×¨×ª,
    ×× ×”×œ: manager,
    ×“×—×™×¤×•×ª: '×¨×’×™×œ×”',
    ×˜×•×•×—: '××¨×•×š',
    ×”×¢×¨×•×ª: it.×¤×¨×˜×™× || `×”×•×¢×‘×¨ ××¨×¢×™×•×Ÿ ×‘×ª××¨×™×š ${it.×ª××¨×™×š || todayISO()}`
  });
  it.×¡×˜×˜×•×¡ = '××•×©×¨';
  saveStore();
  hideModal();
  switchTab('tasks', {pushHistory:false});
  showNotification('×”×•××¨ ×œ××©×™××” âœ…');
}
function deleteIdea(idx){
  if(confirm('×œ××—×•×§ ××ª ×”×¨×¢×™×•×Ÿ?')){
    store.ideas.splice(idx,1);
    saveStore(); hideModal(); switchTab('ideas',{pushHistory:false}); showNotification('× ××—×§ âœ…');
  }
}

function copyText(txt){
  try{ navigator.clipboard.writeText(txt); showNotification('×”×•×¢×ª×§ âœ…'); }catch(e){ alert('×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ×‘×“×¤×“×¤×Ÿ ×–×”'); }
}

function inputRow(label, id, value){
  return `
    <div>
      <label class="mini font-extrabold text-slate-600">${label}</label>
      <input class="input" id="${id}" value="${escapeHtml(value ?? '')}" />
    </div>
  `;
}

/* =========================
   âœ… RENDERERS
========================= */
function renderTasks(el){
  const filtered = selectedTaskOwner==='ALL' ? store.tasks : store.tasks.filter(t=>t.×× ×”×œ===selectedTaskOwner);
  const high = filtered.filter(t=>t.×“×—×™×¤×•×ª==='×’×‘×•×”×”');

  const legend = store.staff.map(s=>{
    const th = managerTheme(s.×©×);
    const c = taskCountFor(s.×©×);
    return `
      <button onclick="setTasksOwner('${escapeHtml(s.×©×)}')" class="px-3 py-2 rounded-xl text-xs font-extrabold border hover:shadow-sm transition flex items-center gap-2"
        style="border-color:${th.base}; background:${th.soft}; color:${th.text}">
        <span class="w-3 h-3 rounded-full" style="background:${th.base}"></span>
        <span>${escapeHtml(s.×©×)}</span>
        <span class="mr-1 px-2 py-0.5 rounded-full text-[10px]" style="background:#ffffffa6;border:1px solid ${th.base};color:${th.text}">
          ${c} ××©×™××•×ª
        </span>
      </button>
    `;
  }).join('');

  el.innerHTML = `
    <div class="card border-r-4 border-slate-300">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="text-slate-800 font-extrabold text-lg"><i class="fas fa-filter ml-2 text-slate-400"></i> ×¡×™× ×•×Ÿ â€œ×”××©×™××•×ª ×©×œ×™â€</div>
          <span class="text-xs text-slate-400">×‘×—×¨ ×¢×•×‘×“ ×›×“×™ ×œ×¨××•×ª ×¨×§ ××ª ×”××©×™××•×ª ×©×œ×•</span>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="setTasksOwner('ALL')" class="btn btn-soft">
            <i class="fas fa-layer-group"></i> ×›×œ ×”××©×™××•×ª
          </button>
          <select onchange="setTasksOwner(this.value)" class="input !py-2 !px-4 !text-sm !font-extrabold">
            <option value="ALL">×‘×—×¨ ×¢×•×‘×“â€¦</option>
            ${store.staff.map(s => `<option value="${escapeHtml(s.×©×)}" ${selectedTaskOwner===s.×©×?'selected':''}>${escapeHtml(s.×©×)}</option>`).join('')}
          </select>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">${legend}</div>
      <div class="mt-3 text-xs text-slate-500">
        ××¦×‘ × ×•×›×—×™: <span class="font-extrabold">${selectedTaskOwner==='ALL'?'×›×œ ×”×¢×•×‘×“×™×':escapeHtml(selectedTaskOwner)}</span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card border-r-8 border-red-500">
        <h4 class="font-extrabold text-red-600 mb-4 text-lg flex items-center">
          <i class="fas fa-fire ml-2"></i> ×“×—×•×£ ×œ×‘×™×¦×•×¢ ××™×“×™
          <span class="mr-auto bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs">${high.length}</span>
        </h4>

        ${
          high.length ? high.map(t=>{
            const th = managerTheme(t.×× ×”×œ);
            const idx = store.tasks.indexOf(t);
            return `
              <button onclick="openTaskCard(${idx})" class="w-full text-right p-4 rounded-xl mb-3 border transition hover:shadow-sm"
                style="background:${th.soft}; border-color:${th.base}">
                <div class="font-extrabold" style="color:${th.text}">${escapeHtml(t.××©×™××”)}</div>
                <div class="text-[10px] mt-1" style="color:${th.text}99">××—×¨××™: ${escapeHtml(t.×× ×”×œ)} â€¢ ×˜×•×•×—: ${escapeHtml(t.×˜×•×•×—)}</div>
                <div class="mt-2 text-xs font-extrabold" style="color:${th.text}">
                  <i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥ ×œ×¢×¨×™×›×”
                </div>
              </button>
            `;
          }).join('') : `<p class="text-slate-400 text-center py-8">××™×Ÿ ××©×™××•×ª ×“×—×•×¤×•×ª ğŸ‰</p>`
        }
      </div>

      <div class="card border-r-8 border-slate-300">
        <h4 class="font-extrabold text-slate-600 mb-4 text-lg">×›×œ×œ ×”××©×™××•×ª</h4>
        <div class="divide-y">
          ${filtered.map(t=>{
            const idx = store.tasks.indexOf(t);
            const th = managerTheme(t.×× ×”×œ);
            return `
              <button onclick="openTaskCard(${idx})" class="w-full text-right p-3 text-sm flex justify-between items-center hover:bg-slate-50">
                <span class="font-extrabold text-slate-800 flex items-center gap-2">
                  <span class="w-2.5 h-2.5 rounded-full" style="background:${th.base}"></span>
                  ${escapeHtml(t.××©×™××”)}
                </span>
                <span class="text-xs font-extrabold px-2 py-1 rounded-full"
                  style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                  ${escapeHtml(t.×× ×”×œ)}
                </span>
              </button>
            `;
          }).join('')}
        </div>
        <div class="pt-4 text-xs text-slate-400">* ×›×œ ××©×™××” ×œ×—×™×¦×” = ×›×¨×˜×™×¡ ×¢×¨×™×›×” ××œ×</div>
      </div>
    </div>
  `;
}
function setTasksOwner(val){ selectedTaskOwner = val || 'ALL'; renderTasks(byId('tab-content')); }

function renderStaff(el){
  el.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      ${store.staff.map((s, idx)=>{
        const th = managerTheme(s.×©×);
        const c = taskCountFor(s.×©×);
        return `
          <button onclick="openStaffCard(${idx})" class="card border-b-4 hover:shadow-lg transition text-right"
            style="border-bottom-color:${th.base}">
            <div class="flex items-center space-x-3 space-x-reverse mb-4">
              <div class="p-3 rounded-full" style="background:${th.soft}; color:${th.text}">
                <i class="fas fa-user-tie"></i>
              </div>
              <div>
                <div class="font-extrabold text-lg">${escapeHtml(s.×©×)}</div>
                <div class="text-xs text-slate-400 font-extrabold uppercase">${escapeHtml(s.×ª×¤×§×™×“)}</div>
              </div>

              <div class="mr-auto flex items-center gap-2">
                <span class="chip" style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                  <i class="fas fa-list-check"></i> ${c} ××©×™××•×ª
                </span>
                <span class="chip bg-slate-100 text-slate-600"><i class="fas fa-mouse-pointer"></i> ×œ×—×¥</span>
              </div>
            </div>

            <div class="text-xs space-y-1 text-slate-600">
              <div><i class="fas fa-phone ml-2" style="color:${th.text}"></i> ${escapeHtml(s.×˜×œ×¤×•×Ÿ)}</div>
              <div><i class="fas fa-envelope ml-2" style="color:${th.text}"></i> ${escapeHtml(s.××™××™×™×œ)}</div>
            </div>

            <div class="mt-4">
              <button type="button" onclick="event.stopPropagation(); selectedTaskOwner='${escapeHtml(s.×©×)}'; switchTab('tasks',{pushHistory:true});"
                class="w-full px-4 py-2 rounded-xl text-sm font-extrabold transition"
                style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                <i class="fas fa-eye ml-2"></i> ×”×¦×’ â€œ×”××©×™××•×ª ×©×œ×™â€
              </button>
            </div>
          </button>
        `;
      }).join('')}
    </div>
  `;
}

function renderIdeas(el){
  const total = store.ideas.length;
  const stats = ['×—×“×©','×‘×‘×“×™×§×”','××•×©×¨','×‘×•×¦×¢','× ×“×—×”'].map(s=>({s, c: store.ideas.filter(i=>i.×¡×˜×˜×•×¡===s).length}));

  el.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="card border-r-4 border-amber-400">
        <div class="mini text-slate-400 font-extrabold uppercase">×¡×”×´×› ×¨×¢×™×•× ×•×ª</div>
        <div class="text-3xl font-extrabold mt-1">${total}</div>
        <div class="mini text-slate-500 mt-2"><i class="fas fa-mouse-pointer ml-1 text-slate-400"></i> ×›×œ ×¨×¢×™×•×Ÿ ×œ×—×™×¥ ×œ×¢×¨×™×›×”</div>
      </div>
      ${stats.slice(0,3).map(x=>`
        <div class="card border-r-4 border-slate-200">
          <div class="mini text-slate-400 font-extrabold uppercase">${x.s}</div>
          <div class="text-3xl font-extrabold mt-1">${x.c}</div>
        </div>
      `).join('')}
    </div>

    <div class="card">
      <div class="flex items-center justify-between mb-3">
        <div class="font-extrabold text-lg"><i class="fas fa-lightbulb ml-2 text-amber-400"></i> ×¨×¢×™×•× ×•×ª ×¢×•×‘×“×™×</div>
        <span class="chip bg-amber-50 text-amber-700"><i class="fas fa-arrow-turn-down"></i> ×™×© ×›×¤×ª×•×¨ â€œ×”×¤×•×š ×œ××©×™××”â€</span>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-right text-sm">
          <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
            <tr>
              <th class="p-3">×¨×¢×™×•×Ÿ</th>
              <th class="p-3">××¦×™×¢</th>
              <th class="p-3">×ª××¨×™×š</th>
              <th class="p-3">×¡×˜×˜×•×¡</th>
              <th class="p-3 text-left">×¤×¢×•×œ×”</th>
            </tr>
          </thead>
          <tbody>
            ${
              store.ideas.length ? store.ideas.map((it, idx)=>{
                const th = managerTheme(it.××¦×™×¢);
                const badge =
                  it.×¡×˜×˜×•×¡==='×—×“×©' ? 'bg-blue-50 text-blue-700' :
                  it.×¡×˜×˜×•×¡==='×‘×‘×“×™×§×”' ? 'bg-amber-50 text-amber-700' :
                  it.×¡×˜×˜×•×¡==='××•×©×¨' ? 'bg-emerald-50 text-emerald-700' :
                  it.×¡×˜×˜×•×¡==='×‘×•×¦×¢' ? 'bg-slate-100 text-slate-700' :
                  'bg-red-50 text-red-700';
                return `
                  <tr class="border-b hover:bg-slate-50 cursor-pointer" onclick="openIdeaCard(${idx})">
                    <td class="p-3 font-extrabold text-slate-800">
                      <span class="inline-flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full" style="background:${th.base}"></span>
                        ${escapeHtml(it.×›×•×ª×¨×ª)}
                      </span>
                    </td>
                    <td class="p-3 text-xs">
                      <span class="px-2 py-1 rounded-full font-extrabold" style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                        ${escapeHtml(it.××¦×™×¢ || 'â€”')}
                      </span>
                    </td>
                    <td class="p-3 text-xs text-slate-500">${escapeHtml(it.×ª××¨×™×š || 'â€”')}</td>
                    <td class="p-3 text-xs">
                      <span class="px-2 py-1 rounded-full font-extrabold ${badge}">${escapeHtml(it.×¡×˜×˜×•×¡||'×—×“×©')}</span>
                    </td>
                    <td class="p-3 text-left">
                      <button class="btn btn-emerald !py-2 !px-3 !text-xs" onclick="event.stopPropagation(); ideaToTask(${idx});">
                        <i class="fas fa-arrow-turn-down"></i> ×œ××©×™××”
                      </button>
                    </td>
                  </tr>
                `;
              }).join('') : `
                <tr><td colspan="5" class="p-6 text-center text-slate-400">××™×Ÿ ×¨×¢×™×•× ×•×ª ×¢×“×™×™×Ÿ. ×œ×—×¥ â€œ×”×•×¡×£ ×¨×¢×™×•×Ÿâ€.</td></tr>
              `
            }
          </tbody>
        </table>
      </div>
      <div class="pt-3 text-xs text-slate-400">* ×›×œ ×©×•×¨×” ×œ×—×™×¦×” = ×›×¨×˜×™×¡ ×¢×¨×™×›×” + ×”××¨×” ×œ××©×™××”</div>
    </div>
  `;
}

function renderBooks(el, lang){
  const list = store.books[lang] || [];
  el.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="text-sm text-slate-500">
        <span class="chip bg-blue-50 text-blue-700"><i class="fas fa-info-circle"></i> ×œ×—×¥ ×¢×œ ×¡×¤×¨ ×œ×¤×ª×™×—×ª ×¢××•×“ ××œ×</span>
      </div>
      <div class="text-xs text-slate-400">×¡×”×´×›: ${list.length} ×¡×¤×¨×™×</div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      ${list.map(b=>`
        <button onclick="openBookDetail('${lang}','${b.id}')" class="card border-t-4 border-blue-600 hover:shadow-xl transition text-right">
          <div class="flex items-start justify-between gap-3">
            <h4 class="font-extrabold text-lg mb-1">${escapeHtml(b.name)}</h4>
            <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-arrow-left"></i> ×¢××•×“</span>
          </div>
          <div class="text-[10px] text-slate-400 mb-4 font-extrabold uppercase">××¦×‘ ×’×™×•×¡ ×›×¡×¤×™×</div>

          <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden mb-3">
            <div class="bg-gradient-to-l from-emerald-400 to-emerald-600 h-full progress-bar" style="width:${b.progress||0}%"></div>
          </div>

          <div class="flex justify-between items-center mb-4">
            <span class="text-sm font-extrabold text-emerald-600">${money(b.raised)}</span>
            <span class="text-xs text-slate-400">×™×¢×“: ${money(b.target)}</span>
          </div>

          <div class="flex items-center justify-between text-xs text-slate-500">
            <span><i class="fas fa-users ml-1"></i> ${(b.donorsCount ?? (b.donors?.length||0))} ×ª×•×¨××™×</span>
            <span class="chip bg-purple-50 text-purple-700"><i class="fas fa-print"></i> ×”×“×¤×¡×•×ª: ${(b.printRuns||[]).length}</span>
          </div>
        </button>
      `).join('')}
    </div>
  `;
}

function openBookDetail(lang, id){
  currentBookContext = { lang, id };
  switchTab('book-detail');
}

// âš¡ × ×©××¨ ××¤×•×¨×˜ (×›×™ ×–×” ×¢××•×“ ×¢×©×™×¨), ××‘×œ ×©×™×¤×¨× ×•: ×›×œ ×©×•×¨×” ×”×™× editable + × ×©××¨ ××•×˜×•××˜×™×ª
function renderBookDetail(el, lang, bookId){
  const b = findBook(lang, bookId);
  if(!b){ el.innerHTML = `<div class="card">×œ× × ××¦× ×¡×¤×¨</div>`; return; }
  byId('current-tab-title').innerText = `×¡×¤×¨: ${b.name}`;

  b.identity = b.identity || {};
  b.printRuns = b.printRuns || [];
  b.donors = b.donors || [];

  const sumPrint = b.printRuns.reduce((s,r)=>s+(Number(r.qty)||0),0);
  const sumDon = b.donors.reduce((s,d)=>s+(Number(d.amount)||0),0);

  el.innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card lg:col-span-1 border-r-4 border-blue-600">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-400 font-extrabold uppercase">×ª×¢×•×“×ª ×–×”×•×ª â€¢ ${lang==='he'?'×¢×‘×¨×™×ª':'English'}</div>
            <div class="text-2xl font-extrabold mt-1">${escapeHtml(b.name)}</div>
            <div class="text-sm text-slate-500 mt-1">${escapeHtml(b.identity.subtitle||'â€”')}</div>
          </div>
          <div class="text-blue-600 text-2xl"><i class="fas fa-book-open"></i></div>
        </div>

        <div class="mt-6 space-y-3 text-sm">
          <div class="flex justify-between"><span class="text-slate-500">×™×¢×“ ×’×™×•×¡</span><span class="font-extrabold">${money(b.target)}</span></div>
          <div class="flex justify-between"><span class="text-slate-500">× ×’×‘×”</span><span class="font-extrabold text-emerald-600">${money(b.raised)}</span></div>
          <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
            <div class="bg-gradient-to-l from-emerald-400 to-emerald-600 h-full progress-bar" style="width:${b.progress||0}%"></div>
          </div>

          <div class="pt-3 border-t grid grid-cols-2 gap-3">
            <div class="p-3 rounded-xl bg-slate-50">
              <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×”×“×¤×¡×•×ª</div>
              <div class="text-xl font-extrabold mt-1">${b.printRuns.length}</div>
            </div>
            <div class="p-3 rounded-xl bg-slate-50">
              <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×¢×•×ª×§×™×</div>
              <div class="text-xl font-extrabold mt-1">${Number(sumPrint).toLocaleString()}</div>
            </div>
            <div class="p-3 rounded-xl bg-emerald-50 col-span-2">
              <div class="text-[10px] text-emerald-600 font-extrabold uppercase">×ª×•×¨××™× ×‘×¨××ª ×”×¡×¤×¨</div>
              <div class="text-xl font-extrabold mt-1">${money(sumDon)}</div>
            </div>
          </div>

          <button onclick="saveStore(); showNotification('× ×©××¨ âœ…');" class="w-full mt-3 btn btn-primary justify-center">
            <i class="fas fa-save"></i> ×©××•×¨ (××§×•××™)
          </button>

          <div class="text-xs text-slate-400">* × ×©××¨ ××•×˜×•××˜×™×ª ×‘×“×¤×“×¤×Ÿ (LocalStorage).</div>
        </div>
      </div>

      <div class="lg:col-span-2 space-y-6">
        <div class="card border-r-4 border-slate-300">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-extrabold text-slate-800"><i class="fas fa-id-card ml-2 text-slate-500"></i> ×¤×¨×˜×™ ×”×¡×¤×¨</h3>
            <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-pen"></i> ×¢×¨×™×›×” ×—×™×”</span>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            ${bookField(lang, b.id, 'subtitle', '×›×•×ª×¨×ª ××©× ×”', b.identity.subtitle)}
            ${bookField(lang, b.id, 'author', '××—×‘×¨', b.identity.author)}
            ${bookField(lang, b.id, 'editor', '×¢×•×¨×š', b.identity.editor)}
            ${bookField(lang, b.id, 'series', '×¡×“×¨×”', b.identity.series)}
            ${bookField(lang, b.id, 'isbn', 'ISBN', b.identity.isbn)}
            ${bookField(lang, b.id, 'pages', '××¡×³ ×¢××•×“×™×', b.identity.pages, 'number')}
            ${bookField(lang, b.id, 'trim', '×’×•×“×œ (Trim)', b.identity.trim)}
            ${bookField(lang, b.id, 'binding', '×›×¨×™×›×”', b.identity.binding)}
          </div>

          <div class="mt-4">
            <label class="block text-xs font-extrabold text-slate-600 mb-1">×”×¢×¨×•×ª</label>
            <textarea class="input" rows="3" oninput="setBookField('${lang}','${b.id}','notes',this.value)" placeholder="×”×¢×¨×•×ª ×¤× ×™××™×•×ª...">${escapeHtml(b.identity.notes||'')}</textarea>
          </div>
        </div>

        <div class="card border-r-4 border-purple-500">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-extrabold text-slate-800"><i class="fas fa-print ml-2 text-purple-600"></i> ×”×™×¡×˜×•×¨×™×™×ª ×”×“×¤×¡×•×ª</h3>
            <button onclick="addPrintRun('${lang}','${b.id}')" class="btn btn-purple">
              <i class="fas fa-plus"></i> ×”×•×¡×£ ×”×“×¤×¡×”
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-right text-sm">
              <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
                <tr>
                  <th class="p-3">×©× ×”</th>
                  <th class="p-3">×›××•×ª</th>
                  <th class="p-3">×“×¤×•×¡</th>
                  <th class="p-3">×”×¢×¨×•×ª</th>
                  <th class="p-3 text-left">×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody>
                ${
                  b.printRuns.length ? b.printRuns.map((r, idx)=>`
                    <tr class="border-b hover:bg-slate-50">
                      <td class="p-3"><input type="number" class="input !p-2 !rounded-lg w-24" value="${r.year ?? ''}" oninput="updatePrintRun('${lang}','${b.id}',${idx},'year',this.value)" /></td>
                      <td class="p-3"><input type="number" class="input !p-2 !rounded-lg w-28" value="${r.qty ?? ''}" oninput="updatePrintRun('${lang}','${b.id}',${idx},'qty',this.value)" /></td>
                      <td class="p-3"><input class="input !p-2 !rounded-lg" value="${escapeHtml(r.printer||'')}" oninput="updatePrintRun('${lang}','${b.id}',${idx},'printer',this.value)" /></td>
                      <td class="p-3"><input class="input !p-2 !rounded-lg" value="${escapeHtml(r.notes||'')}" oninput="updatePrintRun('${lang}','${b.id}',${idx},'notes',this.value)" /></td>
                      <td class="p-3 text-left">
                        <button onclick="deletePrintRun('${lang}','${b.id}',${idx})" class="text-red-600 hover:underline text-xs font-extrabold">
                          <i class="fas fa-trash ml-1"></i> ××—×§
                        </button>
                      </td>
                    </tr>
                  `).join('') : `
                    <tr><td class="p-6 text-center text-slate-400" colspan="5">××™×Ÿ ×¢×“×™×™×Ÿ ×”×“×¤×¡×•×ª. ×œ×—×¥ "×”×•×¡×£ ×”×“×¤×¡×”".</td></tr>
                  `
                }
              </tbody>
            </table>
          </div>

          <div class="mt-3 text-xs text-slate-400">×¡×”×´×› ×¢×•×ª×§×™×: <span class="font-extrabold text-slate-700">${Number(sumPrint).toLocaleString()}</span></div>
        </div>

        <div class="card border-r-4 border-emerald-500">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-extrabold text-slate-800"><i class="fas fa-hand-holding-heart ml-2 text-emerald-600"></i> ×ª×•×¨××™× ×©×œ ×”×¡×¤×¨</h3>
            <button onclick="addBookDonor('${lang}','${b.id}')" class="btn btn-emerald">
              <i class="fas fa-plus"></i> ×”×•×¡×£ ×ª×•×¨×
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-right text-sm">
              <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
                <tr>
                  <th class="p-3">×©× ×ª×•×¨×</th>
                  <th class="p-3">×ª××¨×™×š</th>
                  <th class="p-3">×¡×›×•×</th>
                  <th class="p-3">×”×¢×¨×”</th>
                  <th class="p-3 text-left">×¤×¢×•×œ×•×ª</th>
                </tr>
              </thead>
              <tbody>
                ${
                  b.donors.length ? b.donors.map((d, idx)=>`
                    <tr class="border-b hover:bg-slate-50">
                      <td class="p-3"><input class="input !p-2 !rounded-lg" value="${escapeHtml(d.name||'')}" oninput="updateBookDonor('${lang}','${b.id}',${idx},'name',this.value)" /></td>
                      <td class="p-3"><input type="date" class="input !p-2 !rounded-lg w-44" value="${d.date||todayISO()}" oninput="updateBookDonor('${lang}','${b.id}',${idx},'date',this.value)" /></td>
                      <td class="p-3"><input type="number" class="input !p-2 !rounded-lg w-32" value="${d.amount ?? ''}" oninput="updateBookDonor('${lang}','${b.id}',${idx},'amount',this.value)" /></td>
                      <td class="p-3"><input class="input !p-2 !rounded-lg" value="${escapeHtml(d.note||'')}" oninput="updateBookDonor('${lang}','${b.id}',${idx},'note',this.value)" /></td>
                      <td class="p-3 text-left">
                        <button onclick="deleteBookDonor('${lang}','${b.id}',${idx})" class="text-red-600 hover:underline text-xs font-extrabold">
                          <i class="fas fa-trash ml-1"></i> ××—×§
                        </button>
                      </td>
                    </tr>
                  `).join('') : `
                    <tr><td class="p-6 text-center text-slate-400" colspan="5">××™×Ÿ ×ª×•×¨××™× ×¢×“×™×™×Ÿ. ×œ×—×¥ "×”×•×¡×£ ×ª×•×¨×".</td></tr>
                  `
                }
              </tbody>
            </table>
          </div>

          <div class="mt-3 text-xs text-slate-400">×¡×”×´×› ×ª×¨×•××•×ª ×œ×¡×¤×¨: <span class="font-extrabold text-emerald-700">${money(sumDon)}</span></div>
        </div>
      </div>
    </div>
  `;
}
function bookField(lang, id, key, label, value, type='text'){
  return `
    <div>
      <label class="block text-xs font-extrabold text-slate-600 mb-1">${label}</label>
      <input type="${type}" class="input" value="${escapeHtml(String(value ?? ''))}"
        oninput="setBookField('${lang}','${id}','${key}', this.value)" placeholder="${label}" />
    </div>
  `;
}
function setBookField(lang, id, key, value){
  const b = findBook(lang, id); if(!b) return;
  b.identity = b.identity || {};
  b.identity[key] = (key==='pages') ? parseInt(value||0) : value;
  saveStore();
}
function addPrintRun(lang,id){
  const b = findBook(lang,id); if(!b) return;
  b.printRuns = b.printRuns || [];
  b.printRuns.unshift({ year:new Date().getFullYear(), qty:0, printer:"", notes:"" });
  saveStore(); renderBookDetail(byId('tab-content'), lang, id); showNotification('× ×•×¡×¤×” ×”×“×¤×¡×”');
}
function updatePrintRun(lang,id,idx,field,value){
  const b = findBook(lang,id); if(!b) return;
  const r = b.printRuns[idx]; if(!r) return;
  r[field] = (field==='year'||field==='qty') ? parseInt(value||0) : value;
  saveStore();
}
function deletePrintRun(lang,id,idx){
  const b = findBook(lang,id); if(!b) return;
  if(confirm('×œ××—×•×§ ×©×•×¨×ª ×”×“×¤×¡×”?')){
    b.printRuns.splice(idx,1);
    saveStore(); renderBookDetail(byId('tab-content'), lang, id); showNotification('× ××—×§');
  }
}
function addBookDonor(lang,id){
  const b = findBook(lang,id); if(!b) return;
  b.donors = b.donors || [];
  b.donors.unshift({ id:uid(), name:"×ª×•×¨× ×—×“×©", amount:0, date:todayISO(), note:"" });
  saveStore(); renderBookDetail(byId('tab-content'), lang, id); showNotification('× ×•×¡×£ ×ª×•×¨×');
}
function updateBookDonor(lang,id,idx,field,value){
  const b = findBook(lang,id); if(!b) return;
  const d = b.donors[idx]; if(!d) return;
  d[field] = (field==='amount') ? parseInt(value||0) : value;
  saveStore();
}
function deleteBookDonor(lang,id,idx){
  const b = findBook(lang,id); if(!b) return;
  if(confirm('×œ××—×•×§ ×ª×•×¨× ××”×¡×¤×¨?')){
    b.donors.splice(idx,1);
    saveStore(); renderBookDetail(byId('tab-content'), lang, id); showNotification('× ××—×§');
  }
}

function renderDonors(el){
  const total = store.donors.reduce((s,d)=>s+parseInt(d.××ª× ×”||0),0);
  const avg = Math.round(total / Math.max(1, store.donors.length));

  el.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="card bg-emerald-500 text-white shadow-emerald-200 shadow-xl text-right">
        <div class="text-xs font-extrabold opacity-80 uppercase mb-1">×¡×”×´×› ×’×™×•×¡ ×”×—×•×“×©</div>
        <div class="text-4xl font-extrabold">${money(total)}</div>
      </div>
      <div class="card bg-blue-500 text-white text-right">
        <div class="text-xs font-extrabold opacity-80 uppercase mb-1">×ª×•×¨××™× ×¤×¢×™×œ×™×</div>
        <div class="text-4xl font-extrabold">${store.donors.length}</div>
      </div>
      <div class="card bg-purple-500 text-white text-right">
        <div class="text-xs font-extrabold opacity-80 uppercase mb-1">×××•×¦×¢ ×ª×¨×•××”</div>
        <div class="text-4xl font-extrabold">${money(avg)}</div>
      </div>
    </div>

    <div class="card">
      <h4 class="font-extrabold mb-4 text-lg">×¨×©×™××ª ×ª×•×¨××™× (×œ×—×™×¥ ×œ×¢×¨×™×›×”)</h4>
      <div class="overflow-x-auto">
        <table class="w-full text-right text-sm">
          <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
            <tr><th class="p-3">×©× ×ª×•×¨×</th><th class="p-3">×¤×¨×•×™×§×˜</th><th class="p-3">×ª××¨×™×š</th><th class="p-3">×¡×›×•×</th></tr>
          </thead>
          <tbody>
            ${store.donors.map((d, idx)=>`
              <tr class="border-b hover:bg-slate-50 cursor-pointer" onclick="openDonorCard(${idx})">
                <td class="p-3 font-extrabold text-slate-800">${escapeHtml(d.×©×)}</td>
                <td class="p-3 text-slate-500 text-xs">${escapeHtml(d.×¤×¨×•×™×§×˜)}</td>
                <td class="p-3 text-slate-400 text-xs">${escapeHtml(d.×ª××¨×™×š)}</td>
                <td class="p-3 font-extrabold text-emerald-600">${money(parseInt(d.××ª× ×”||0))}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      <div class="pt-3 text-xs text-slate-400">* ×›×œ ×©×•×¨×” ×œ×—×™×¦×” = ×¢×¨×™×›×”</div>
    </div>
  `;
}
function openDonorCard(idx){
  const d = store.donors[idx];
  if(!d) return;
  showModal(
    `×ª×•×¨×: ${d.×©×}`,
    `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        ${inputRow('×©×', 'd-name', d.×©×)}
        ${inputRow('×¤×¨×•×™×§×˜', 'd-proj', d.×¤×¨×•×™×§×˜)}
        <div>
          <label class="mini font-extrabold text-slate-600">×ª××¨×™×š</label>
          <input class="input" id="d-date" type="date" value="${escapeHtml(d.×ª××¨×™×š||todayISO())}"/>
        </div>
        <div>
          <label class="mini font-extrabold text-slate-600">×¡×›×•×</label>
          <input class="input" id="d-amt" type="number" value="${escapeHtml(d.××ª× ×”||0)}"/>
        </div>
      </div>
    `,
    {
      onSubmit: ()=>{
        d.×©× = byId('d-name').value;
        d.×¤×¨×•×™×§×˜ = byId('d-proj').value;
        d.×ª××¨×™×š = byId('d-date').value;
        d.××ª× ×” = String(parseInt(byId('d-amt').value||0));
        saveStore(); hideModal(); switchTab('donors',{pushHistory:false}); showNotification('×”×ª×•×¨× ×¢×•×“×›×Ÿ âœ…');
      },
      submitText:'×©××•×¨',
      leftActionsHtml:`<button class="btn btn-danger" onclick="deleteDonor(${idx})"><i class="fas fa-trash"></i> ××—×§</button>`
    }
  );
}
function deleteDonor(idx){
  if(confirm('×œ××—×•×§ ×ª×•×¨×?')){
    store.donors.splice(idx,1);
    saveStore(); hideModal(); switchTab('donors',{pushHistory:false}); showNotification('× ××—×§ âœ…');
  }
}

function renderExpenses(el){
  const total = store.expenses.reduce((s,e)=>s+parseInt(e.×¡×›×•×||0),0);
  el.innerHTML = `
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 text-center">
      <div class="card border-b-4 border-blue-500">
        <p class="text-[10px] text-slate-400 font-extrabold uppercase">××©×¨×“</p>
        <h2 class="text-2xl font-extrabold mt-1">â‚ª1,000</h2>
      </div>
      <div class="card border-b-4 border-slate-800">
        <p class="text-[10px] text-slate-400 font-extrabold uppercase">×—× ×™×”</p>
        <h2 class="text-2xl font-extrabold mt-1">â‚ª450</h2>
      </div>
      <div class="card border-b-4 border-slate-800">
        <p class="text-[10px] text-slate-400 font-extrabold uppercase">×¨×›×‘</p>
        <h2 class="text-2xl font-extrabold mt-1">â‚ª1,500</h2>
      </div>
      <div class="card border-b-4 border-emerald-500">
        <p class="text-[10px] text-slate-400 font-extrabold uppercase">×“×™×’×™×˜×œ</p>
        <h2 class="text-2xl font-extrabold mt-1">$100</h2>
      </div>
      <div class="card border-b-4 border-red-500">
        <p class="text-[10px] text-red-400 font-extrabold uppercase">×—×•×‘×•×ª</p>
        <h2 class="text-2xl font-extrabold mt-1 text-red-600">${money(total)}</h2>
      </div>
    </div>

    <div class="card">
      <h4 class="font-extrabold mb-4 text-lg">×—×•×‘×•×ª ×œ×¡×¤×§×™× ×•×’××´×—×™× (×œ×—×™×¥ ×œ×¢×¨×™×›×”)</h4>
      <table class="w-full text-right text-sm">
        <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
          <tr><th class="p-3">×¡×¤×§</th><th class="p-3 text-left">×¡×›×•×</th><th class="p-3 text-left">×¤×¢×•×œ×•×ª</th></tr>
        </thead>
        <tbody>
          ${store.expenses.map((e, idx)=>`
            <tr class="border-b hover:bg-slate-50">
              <td class="p-3 font-extrabold text-slate-800">
                <button class="text-right hover:underline" onclick="openExpenseCard(${idx})">${escapeHtml(e.×¡×¤×§)}</button>
              </td>
              <td class="p-3 text-left">
                <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-extrabold">${money(parseInt(e.×¡×›×•×||0))}</span>
              </td>
              <td class="p-3 text-left">
                <button onclick="markAsPaid(${idx})" class="text-emerald-600 hover:underline text-xs font-extrabold">
                  <i class="fas fa-check ml-1"></i> ×©×•×œ×
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}
function openExpenseCard(idx){
  const e = store.expenses[idx]; if(!e) return;
  showModal(
    `×—×•×‘: ${e.×¡×¤×§}`,
    `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        ${inputRow('×¡×¤×§', 'e-name', e.×¡×¤×§)}
        <div>
          <label class="mini font-extrabold text-slate-600">×¡×›×•×</label>
          <input class="input" id="e-amt" type="number" value="${escapeHtml(e.×¡×›×•×||0)}"/>
        </div>
      </div>
    `,
    {
      onSubmit: ()=>{
        e.×¡×¤×§ = byId('e-name').value;
        e.×¡×›×•× = String(parseInt(byId('e-amt').value||0));
        saveStore(); hideModal(); switchTab('expenses',{pushHistory:false}); showNotification('×¢×•×“×›×Ÿ âœ…');
      },
      submitText:'×©××•×¨',
      leftActionsHtml: `
        <button class="btn btn-emerald" onclick="markAsPaid(${idx})"><i class="fas fa-check"></i> ×©×•×œ×</button>
        <button class="btn btn-danger" onclick="deleteExpense(${idx})"><i class="fas fa-trash"></i> ××—×§</button>
      `
    }
  );
}
function markAsPaid(idx){
  if(confirm('×œ×¡××Ÿ ×—×•×‘ ×–×” ×›×©×•×œ× (×•×œ×”×¡×™×¨ ××”×¨×©×™××”)?')){
    store.expenses.splice(idx,1);
    saveStore(); hideModal(); switchTab('expenses',{pushHistory:false}); showNotification('×¡×•××Ÿ ×›×©×•×œ× âœ…');
  }
}
function deleteExpense(idx){
  if(confirm('×œ××—×•×§ ×”×•×¦××”?')){
    store.expenses.splice(idx,1);
    saveStore(); hideModal(); switchTab('expenses',{pushHistory:false}); showNotification('× ××—×§ âœ…');
  }
}

function renderLogistics(el){
  const israel = store.logistics.israel || [];
  const international = store.logistics.international || [];
  el.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card border-r-4 border-blue-500">
        <h4 class="font-extrabold text-blue-600 mb-4 text-lg"><i class="fas fa-map-marker-alt ml-2"></i> ×”×¤×¦×” ×‘××¨×¥</h4>
        <div class="space-y-3">
          ${israel.map((loc, idx)=>`
            <button onclick="openLogCard('israel',${idx})" class="w-full text-right p-3 bg-blue-50 rounded-lg flex justify-between items-center hover:bg-blue-100 transition">
              <div>
                <div class="font-extrabold">${escapeHtml(loc.city)}</div>
                <div class="text-xs text-slate-500 mt-1">
                  <span class="px-2 py-0.5 rounded ${loc.status==='×¤×¢×™×œ'?'bg-emerald-100 text-emerald-700':'bg-amber-100 text-amber-700'}">${escapeHtml(loc.status)}</span>
                </div>
              </div>
              <span class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full font-extrabold">${loc.books} ×¡×¤×¨×™×</span>
            </button>
          `).join('')}
        </div>
      </div>

      <div class="card border-r-4 border-purple-500">
        <h4 class="font-extrabold text-purple-600 mb-4 text-lg"><i class="fas fa-globe ml-2"></i> ×”×¤×¦×” ×‘×—×•×´×œ</h4>
        <div class="space-y-3">
          ${international.map((loc, idx)=>`
            <button onclick="openLogCard('international',${idx})" class="w-full text-right p-3 bg-purple-50 rounded-lg flex justify-between items-center hover:bg-purple-100 transition">
              <div>
                <div class="font-extrabold">${escapeHtml(loc.country)}</div>
                <div class="text-xs text-slate-500 mt-1">
                  <span class="px-2 py-0.5 rounded ${
                    loc.status==='×¤×¢×™×œ'?'bg-emerald-100 text-emerald-700':
                    loc.status==='×‘×©×œ×™×—×”'?'bg-blue-100 text-blue-700':'bg-slate-100 text-slate-700'
                  }">${escapeHtml(loc.status)}</span>
                </div>
              </div>
              <span class="text-xs bg-purple-600 text-white px-3 py-1 rounded-full font-extrabold">${loc.books} ×¡×¤×¨×™×</span>
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}
function openLogCard(type, idx){
  const arr = type==='israel' ? store.logistics.israel : store.logistics.international;
  const item = arr[idx]; if(!item) return;
  const isIsrael = type==='israel';
  showModal(
    isIsrael ? `×”×¤×¦×” ×‘××¨×¥: ${item.city}` : `×”×¤×¦×” ×‘×—×•×´×œ: ${item.country}`,
    `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        ${isIsrael ? inputRow('×¢×™×¨','l-name', item.city) : inputRow('××“×™× ×”','l-name', item.country)}
        <div>
          <label class="mini font-extrabold text-slate-600">××¡×¤×¨ ×¡×¤×¨×™×</label>
          <input class="input" id="l-books" type="number" value="${escapeHtml(item.books||0)}"/>
        </div>
        <div class="md:col-span-2">
          <label class="mini font-extrabold text-slate-600">×¡×˜×˜×•×¡</label>
          <select class="input" id="l-status">
            ${
              (isIsrael ? ['×¤×¢×™×œ','×‘×”××ª× ×”'] : ['×¤×¢×™×œ','×‘×©×œ×™×—×”','×‘×ª×›× ×•×Ÿ'])
              .map(v => `<option ${v===item.status?'selected':''} value="${v}">${v}</option>`).join('')
            }
          </select>
        </div>
      </div>
    `,
    {
      onSubmit: ()=>{
        if(isIsrael) item.city = byId('l-name').value; else item.country = byId('l-name').value;
        item.books = parseInt(byId('l-books').value||0);
        item.status = byId('l-status').value;
        saveStore(); hideModal(); switchTab('logistics',{pushHistory:false}); showNotification('×¢×•×“×›×Ÿ âœ…');
      },
      submitText:'×©××•×¨',
      leftActionsHtml:`<button class="btn btn-danger" onclick="deleteLog('${type}',${idx})"><i class="fas fa-trash"></i> ××—×§</button>`
    }
  );
}
function deleteLog(type, idx){
  if(confirm('×œ××—×•×§ ×™×¢×“ ×”×¤×¦×”?')){
    const arr = type==='israel' ? store.logistics.israel : store.logistics.international;
    arr.splice(idx,1);
    saveStore(); hideModal(); switchTab('logistics',{pushHistory:false}); showNotification('× ××—×§ âœ…');
  }
}

/* =========================
   âœ… ADD MODAL (×›×•×œ×œ IDEAS)
========================= */
function showAddModal(){
  if(currentTab==='book-detail' && currentBookContext){
    const {lang,id} = currentBookContext;
    showModal(
      '×”×•×¡×¤×” ×œ×¡×¤×¨',
      `
        <button onclick="addPrintRun('${lang}','${id}'); hideModal();" class="w-full p-4 bg-purple-50 hover:bg-purple-100 rounded-xl text-right font-extrabold text-purple-700 transition flex items-center justify-between">
          <span><i class="fas fa-print ml-2"></i> ×”×•×¡×£ ×©×•×¨×ª ×”×“×¤×¡×”</span><i class="fas fa-chevron-left"></i>
        </button>
        <button onclick="addBookDonor('${lang}','${id}'); hideModal();" class="w-full p-4 bg-emerald-50 hover:bg-emerald-100 rounded-xl text-right font-extrabold text-emerald-700 transition flex items-center justify-between">
          <span><i class="fas fa-hand-holding-heart ml-2"></i> ×”×•×¡×£ ×ª×•×¨× ×œ×¡×¤×¨</span><i class="fas fa-chevron-left"></i>
        </button>
        <div class="text-xs text-slate-400">* ×‘×¢××•×“ ×¡×¤×¨, â€œ×”×•×¡×£â€ ××ª×™×™×—×¡ ×œ× ×ª×•× ×™ ×”×¡×¤×¨.</div>
      `,
      { onSubmit:null }
    );
    return;
  }

  if(currentTab==='tasks'){
    showModal('×”×•×¡×¤×ª ××©×™××” ×—×“×©×”', `
      <input id="in-name" class="input" placeholder="×ª×™××•×¨ ×”××©×™××”">
      <select id="in-manager" class="input mt-3">
        <option value="">×‘×—×¨ ×× ×”×œ ×‘×™×¦×•×¢...</option>
        ${store.staff.map(s=>`<option value="${escapeHtml(s.×©×)}">${escapeHtml(s.×©×)}</option>`).join('')}
      </select>
      <select id="in-urgency" class="input mt-3">
        <option value="×¨×’×™×œ×”">×“×—×™×¤×•×ª ×¨×’×™×œ×”</option>
        <option value="×’×‘×•×”×”">×“×—×™×¤×•×ª ×’×‘×•×”×” ğŸ”¥</option>
      </select>
      <select id="in-timeframe" class="input mt-3">
        <option value="×—×•×“×©×™">×—×•×“×©×™</option>
        <option value="××¨×•×š">×˜×•×•×— ××¨×•×š</option>
      </select>
      <textarea id="in-note" class="input mt-3" rows="3" placeholder="×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)"></textarea>
    `, {
      onSubmit: ()=>{
        const name = byId('in-name').value.trim();
        const manager = byId('in-manager').value;
        if(!name || !manager) return alert('× × ×œ××œ× ×ª×™××•×¨ + ××—×¨××™');
        store.tasks.unshift({
          id: uid(),
          ××©×™××”: name,
          ×× ×”×œ: manager,
          ×“×—×™×¤×•×ª: byId('in-urgency').value,
          ×˜×•×•×—: byId('in-timeframe').value,
          ×”×¢×¨×•×ª: byId('in-note').value || ''
        });
        saveStore(); hideModal(); switchTab('tasks',{pushHistory:false}); showNotification('× ×•×¡×¤×” ××©×™××” âœ¨');
      }
    });
  }

  else if(currentTab==='staff'){
    showModal('×”×•×¡×¤×ª ×¢×•×‘×“ ×—×“×©', `
      <input id="in-staff-name" class="input mb-3" placeholder="×©× ×”×¢×•×‘×“">
      <input id="in-staff-role" class="input mb-3" placeholder="×ª×¤×§×™×“">
      <input id="in-staff-phone" class="input mb-3" placeholder="×˜×œ×¤×•×Ÿ">
      <input id="in-staff-email" class="input" placeholder="××™××™×™×œ">
    `, {
      onSubmit: ()=>{
        const name = byId('in-staff-name').value.trim();
        const role = byId('in-staff-role').value.trim();
        if(!name || !role) return alert('× × ×œ××œ× ×œ×¤×—×•×ª ×©× ×•×ª×¤×§×™×“');
        store.staff.push({ id:uid(), ×©×:name, ×ª×¤×§×™×“:role, ×˜×œ×¤×•×Ÿ:byId('in-staff-phone').value, ××™××™×™×œ:byId('in-staff-email').value });
        saveStore(); hideModal(); switchTab('staff',{pushHistory:false}); showNotification('× ×•×¡×£ ×¢×•×‘×“ âœ¨');
      }
    });
  }

  else if(currentTab==='ideas'){
    showModal('×”×•×¡×¤×ª ×¨×¢×™×•×Ÿ ×—×“×©', `
      <input id="in-idea-title" class="input" placeholder="×›×•×ª×¨×ª ×”×¨×¢×™×•×Ÿ">
      <select id="in-idea-by" class="input mt-3">
        <option value="">×‘×—×¨ ××¦×™×¢...</option>
        ${store.staff.map(s=>`<option value="${escapeHtml(s.×©×)}">${escapeHtml(s.×©×)}</option>`).join('')}
      </select>
      <select id="in-idea-status" class="input mt-3">
        ${['×—×“×©','×‘×‘×“×™×§×”','××•×©×¨','×‘×•×¦×¢','× ×“×—×”'].map(v=>`<option value="${v}">${v}</option>`).join('')}
      </select>
      <textarea id="in-idea-notes" class="input mt-3" rows="4" placeholder="×¤×¨×˜×™×/×”×¡×‘×¨ ×§×¦×¨..."></textarea>
    `, {
      onSubmit: ()=>{
        const title = byId('in-idea-title').value.trim();
        const by = byId('in-idea-by').value;
        if(!title) return alert('× × ×œ×”×–×™×Ÿ ×›×•×ª×¨×ª ×¨×¢×™×•×Ÿ');
        store.ideas.unshift({
          id: uid(),
          ×›×•×ª×¨×ª: title,
          ××¦×™×¢: by || 'â€”',
          ×ª××¨×™×š: todayISO(),
          ×¡×˜×˜×•×¡: byId('in-idea-status').value,
          ×¤×¨×˜×™×: byId('in-idea-notes').value || ''
        });
        saveStore(); hideModal(); switchTab('ideas',{pushHistory:false}); showNotification('× ×•×¡×£ ×¨×¢×™×•×Ÿ ğŸ’¡');
      }
    });
  }

  else if(currentTab==='donors'){
    const allBooks = [...(store.books.he||[]), ...(store.books.en||[])];
    showModal('×”×•×¡×¤×ª ×ª×¨×•××” ×—×“×©×”', `
      <input id="in-donor-name" class="input mb-3" placeholder="×©× ×”×ª×•×¨×">
      <select id="in-donor-project" class="input mb-3">
        <option value="">×‘×—×¨ ×¤×¨×•×™×§×˜/×¡×¤×¨...</option>
        ${allBooks.map(b=>`<option value="${escapeHtml(b.name)}">${escapeHtml(b.name)}</option>`).join('')}
      </select>
      <input id="in-donor-amount" type="number" class="input mb-3" placeholder="×¡×›×•× ×”×ª×¨×•××” (â‚ª)">
      <input id="in-donor-date" type="date" class="input" value="${todayISO()}">
    `,{
      onSubmit: ()=>{
        const name = byId('in-donor-name').value.trim();
        const proj = byId('in-donor-project').value;
        const amt = parseInt(byId('in-donor-amount').value||0);
        const date = byId('in-donor-date').value;
        if(!name || !proj || !amt) return alert('× × ×œ××œ× ×©× + ×¤×¨×•×™×§×˜ + ×¡×›×•×');
        store.donors.unshift({ id:uid(), ×©×:name, ×¤×¨×•×™×§×˜:proj, ××ª× ×”:String(amt), ×ª××¨×™×š:date });
        saveStore(); hideModal(); switchTab('donors',{pushHistory:false}); showNotification('× ×•×¡×¤×” ×ª×¨×•××” âœ¨');
      }
    });
  }

  else if(currentTab==='expenses'){
    showModal('×”×•×¡×¤×ª ×”×•×¦××” ×—×“×©×”', `
      <input id="in-expense-name" class="input mb-3" placeholder="×©× ×”×¡×¤×§">
      <input id="in-expense-amount" type="number" class="input" placeholder="×¡×›×•× ×”×—×•×‘ (â‚ª)">
    `,{
      onSubmit: ()=>{
        const name = byId('in-expense-name').value.trim();
        const amt = parseInt(byId('in-expense-amount').value||0);
        if(!name || !amt) return alert('× × ×œ××œ× ×¡×¤×§ + ×¡×›×•×');
        store.expenses.unshift({ id:uid(), ×¡×¤×§:name, ×¡×›×•×:String(amt), ×¡×˜×˜×•×¡:'×××ª×™×Ÿ' });
        saveStore(); hideModal(); switchTab('expenses',{pushHistory:false}); showNotification('× ×•×¡×¤×” ×”×•×¦××” âœ¨');
      }
    });
  }

  else if(currentTab==='logistics'){
    showModal('×”×•×¡×¤×ª ×™×¢×“ ×”×¤×¦×”', `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="mini font-extrabold text-slate-600">×¡×•×’</label>
          <select id="in-log-type" class="input">
            <option value="israel">×‘××¨×¥</option>
            <option value="international">×‘×—×•×´×œ</option>
          </select>
        </div>
        <div>
          <label class="mini font-extrabold text-slate-600">×©× ×™×¢×“</label>
          <input id="in-log-name" class="input" placeholder="×¢×™×¨ / ××“×™× ×”">
        </div>
        <div>
          <label class="mini font-extrabold text-slate-600">×›××•×ª ×¡×¤×¨×™×</label>
          <input id="in-log-books" type="number" class="input" value="0">
        </div>
        <div>
          <label class="mini font-extrabold text-slate-600">×¡×˜×˜×•×¡</label>
          <select id="in-log-status" class="input">
            <option value="×¤×¢×™×œ">×¤×¢×™×œ</option>
            <option value="×‘×”××ª× ×”">×‘×”××ª× ×”</option>
            <option value="×‘×©×œ×™×—×”">×‘×©×œ×™×—×”</option>
            <option value="×‘×ª×›× ×•×Ÿ">×‘×ª×›× ×•×Ÿ</option>
          </select>
        </div>
      </div>
    `,{
      onSubmit: ()=>{
        const type = byId('in-log-type').value;
        const name = byId('in-log-name').value.trim();
        const books = parseInt(byId('in-log-books').value||0);
        const status = byId('in-log-status').value;
        if(!name) return alert('× × ×œ×”×–×™×Ÿ ×©× ×™×¢×“');
        if(type==='israel') store.logistics.israel.unshift({ id:uid(), city:name, books, status: status==='×‘×©×œ×™×—×”'||status==='×‘×ª×›× ×•×Ÿ'?'×¤×¢×™×œ':status });
        else store.logistics.international.unshift({ id:uid(), country:name, books, status: status==='×‘×”××ª× ×”'?'×‘×ª×›× ×•×Ÿ':status });
        saveStore(); hideModal(); switchTab('logistics',{pushHistory:false}); showNotification('× ×•×¡×£ ×™×¢×“ âœ¨');
      }
    });
  }

  else if(currentTab==='books-he' || currentTab==='books-en'){
    const lang = currentTab==='books-he'?'he':'en';
    showModal(`×”×•×¡×¤×ª ×¡×¤×¨ ×—×“×© (${lang==='he'?'×¢×‘×¨×™×ª':'×× ×’×œ×™×ª'})`, `
      <input id="in-book-name" class="input mb-3" placeholder="×©× ×”×¡×¤×¨">
      <input id="in-book-target" type="number" class="input mb-3" placeholder="×™×¢×“ ×’×™×•×¡ (â‚ª)" value="50000">
      <input id="in-book-raised" type="number" class="input mb-3" placeholder="× ×’×‘×” ×¢×“ ×›×” (â‚ª)" value="0">
      <input id="in-book-subtitle" class="input" placeholder="×›×•×ª×¨×ª ××©× ×” (××•×¤×¦×™×•× ×œ×™)">
    `,{
      onSubmit: ()=>{
        const name = byId('in-book-name').value.trim();
        if(!name) return alert('× × ×œ×”×–×™×Ÿ ×©× ×¡×¤×¨');
        const target = parseInt(byId('in-book-target').value||0);
        const raised = parseInt(byId('in-book-raised').value||0);
        const subtitle = byId('in-book-subtitle').value || '';
        const b = {
          id:`${lang}-${uid()}`,
          name, target, raised, donorsCount:0,
          progress: Math.round((raised / Math.max(1, target)) * 100),
          identity:{ subtitle, author:"", editor:"", series:"", isbn:"", pages:0, trim: lang==='he'?'17Ã—24':'6Ã—9', binding:"", notes:"" },
          printRuns:[], donors:[]
        };
        store.books[lang].unshift(b);
        saveStore(); hideModal(); switchTab(currentTab,{pushHistory:false}); showNotification('× ×•×¡×£ ×¡×¤×¨ âœ¨');
      }
    });
  }
}

/* =========================
   âœ… EDIT HUB (×§×¦×¨ ×™×•×ª×¨, ××‘×œ ××©××™×¨ ××ª ××•×ª×• ×¨×¢×™×•×Ÿ)
========================= */
function showEditHub(){
  showModal(
    '×¢×¨×™×›×ª × ×ª×•× ×™× ×‘××¢×¨×›×ª',
    `
      <div class="space-y-3">
        ${hubBtn('×¢×¨×™×›×ª ×¦×•×•×ª ×”×¢×•×‘×“×™×','fa-users','blue', ()=>{ hideModal(); switchTab('staff'); })}
        ${hubBtn('×¢×¨×™×›×ª ××©×™××•×ª','fa-list-check','slate', ()=>{ hideModal(); switchTab('tasks'); })}
        ${hubBtn('×¢×¨×™×›×ª ×¨×¢×™×•× ×•×ª ×¢×•×‘×“×™×','fa-lightbulb','amber', ()=>{ hideModal(); switchTab('ideas'); })}
        ${hubBtn('×¢×¨×™×›×ª ×¡×¤×¨×™× ×¢×‘×¨×™×ª','fa-book','emerald', ()=>{ hideModal(); switchTab('books-he'); })}
        ${hubBtn('×¢×¨×™×›×ª ×¡×¤×¨×™× ×× ×’×œ×™×ª','fa-language','purple', ()=>{ hideModal(); switchTab('books-en'); })}
        ${hubBtn('×¢×¨×™×›×ª ×ª×•×¨××™×','fa-heart','pink', ()=>{ hideModal(); switchTab('donors'); })}
        ${hubBtn('×¢×¨×™×›×ª ×”×•×¦××•×ª','fa-file-invoice','red', ()=>{ hideModal(); switchTab('expenses'); })}
        ${hubBtn('×¢×¨×™×›×ª ×”×¤×¦×”','fa-shipping-fast','slate', ()=>{ hideModal(); switchTab('logistics'); })}
      </div>
      <div class="text-xs text-slate-400 mt-3">* ×›×œ ×”×˜××‘×™× ×›×‘×¨ â€œ×œ×—×™×¦×™× ×œ×¢×¨×™×›×”â€, ××– ×–×” ×¨×§ ×§×™×¦×•×¨ ×“×¨×š.</div>
    `,
    { onSubmit:null }
  );
}
function hubBtn(label, icon, tone, onClick){
  const bg =
    tone==='blue'?'bg-blue-50 hover:bg-blue-100 text-blue-700':
    tone==='emerald'?'bg-emerald-50 hover:bg-emerald-100 text-emerald-700':
    tone==='purple'?'bg-purple-50 hover:bg-purple-100 text-purple-700':
    tone==='pink'?'bg-pink-50 hover:bg-pink-100 text-pink-700':
    tone==='amber'?'bg-amber-50 hover:bg-amber-100 text-amber-700':
    tone==='red'?'bg-red-50 hover:bg-red-100 text-red-700':
    'bg-slate-50 hover:bg-slate-100 text-slate-700';
  // ×™×•×¦×¨×™× ×›×¤×ª×•×¨ ×©××¤×¢×™×œ ×¤×•× ×§×¦×™×” ×“×¨×š window
  const fn = `hub_${uid()}`;
  window[fn] = onClick;
  return `
    <button onclick="${fn}()" class="w-full p-4 ${bg} rounded-xl text-right font-extrabold transition flex items-center justify-between">
      <span><i class="fas ${icon} ml-2"></i> ${label}</span>
      <i class="fas fa-chevron-left"></i>
    </button>
  `;
}

/* =========================
   âœ… INIT
========================= */
window.onload = ()=>{
  buildSidebar();
  setAddButtonText();
  switchTab('tasks', {pushHistory:false});
  saveStore(); // ×™×¦×™×‘
};
</script>
</body>
</html>
