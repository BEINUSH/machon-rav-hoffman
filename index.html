<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>××¢×¨×›×ª × ×™×”×•×œ - ××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
    body{font-family:'Assistant',sans-serif;background:#f8fafc;color:#0f172a}
    .sidebar-link{transition:.15s;border-radius:.9rem;margin-bottom:.25rem;display:flex;align-items:center;padding:.8rem 1rem;cursor:pointer}
    .sidebar-link:hover{background:#334155;color:#fff}
    .sidebar-link.active{background:linear-gradient(135deg,#2563eb,#0ea5e9);color:#fff;box-shadow:0 12px 22px -18px rgba(37,99,235,.75)}
    .card{background:#fff;border-radius:1.25rem;box-shadow:0 10px 18px -18px rgba(2,6,23,.35);padding:1.25rem;border:1px solid #e2e8f0}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .65rem;border-radius:999px;font-size:.75rem;font-weight:800}
    .fade-in{animation:fadeIn .25s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .progress-bar{transition:width .6s ease-out}
    .glass{background:rgba(255,255,255,.72);backdrop-filter: blur(10px);}
    .btn{display:inline-flex;align-items:center;gap:.5rem;font-weight:800;border-radius:.9rem;padding:.55rem .9rem;transition:.15s}
    .btn:active{transform:scale(.98)}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-primary:hover{background:#1d4ed8}
    .btn-ghost{background:#f1f5f9;color:#0f172a}
    .btn-ghost:hover{background:#e2e8f0}
    .btn-purple{background:#7c3aed;color:#fff}
    .btn-purple:hover{background:#6d28d9}
    .btn-emerald{background:#10b981;color:#fff}
    .btn-emerald:hover{background:#059669}
    .mini-input{width:100%;padding:.75rem;border:2px solid #e2e8f0;border-radius:.9rem;outline:none}
    .mini-input:focus{border-color:#3b82f6}
    .soft-shadow{box-shadow:0 18px 40px -30px rgba(2,6,23,.6)}
    .calendar-day{border:1px solid #e2e8f0;border-radius:1rem;padding:.6rem;min-height:92px;background:#fff;transition:.12s}
    .calendar-day:hover{transform:translateY(-2px);box-shadow:0 14px 26px -22px rgba(2,6,23,.6)}
    .calendar-day.muted{background:#f8fafc;color:#94a3b8}
  </style>
</head>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
  apiKey: "AIza....",
  authDomain: "hoffman-admin.firebaseapp.com",
  projectId: "hoffman-admin",
  storageBucket: "hoffman-admin.firebasestorage.app",
  messagingSenderId: "453190767819",
  appId: "1:453190767819:web:xxxxxxx"

  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ×‘×“×™×§×ª â€œ×¨×™×œ-×˜×™×™×â€: ×›×œ ×©×™× ×•×™ ×‘××•×¡×£ data ×™×•×“×¤×¡ ×™×©×¨ ×œ×§×•× ×¡×•×œ
  onSnapshot(collection(db, "data"), (snap) => {
    const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    console.log("LIVE DATA:", rows);
  });
</script>

<body class="flex h-screen overflow-hidden">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-slate-900 text-slate-300 flex flex-col shadow-2xl z-20 overflow-y-auto shrink-0">
    <div class="p-6 border-b border-slate-800">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-white text-xl font-extrabold tracking-tight">××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ</h1>
          <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest">× ×™×”×•×œ â€¢ ×”×•×¦××” ×œ××•×¨ â€¢ ×›×¡×¤×™×</p>
        </div>
        <div class="p-2 rounded-xl bg-slate-800 text-slate-200">
          <i class="fa-solid fa-layer-group"></i>
        </div>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-1 text-sm">
      <div class="text-[10px] font-bold text-slate-500 px-4 mb-2 uppercase">× ×™×”×•×œ ×©×•×˜×£</div>
      <div class="nav-item sidebar-link active" data-tab="tasks" id="btn-tasks"><i class="fas fa-list-ul ml-3"></i> ××©×™××•×ª ×•×œ×•"×–</div>
      <div class="nav-item sidebar-link" data-tab="ideas" id="btn-ideas"><i class="fas fa-lightbulb ml-3"></i> ×¨×¢×™×•× ×•×ª ×•××™×–××™×</div>
      <div class="nav-item sidebar-link" data-tab="staff" id="btn-staff"><i class="fas fa-users-cog ml-3"></i> ×¢×•×‘×“×™ ×”××›×•×Ÿ</div>

      <div class="text-[10px] font-bold text-slate-500 px-4 mt-6 mb-2 uppercase">××¢×¨×š ×”×¡×¤×¨×™×</div>
      <div class="nav-item sidebar-link" data-tab="books-he" id="btn-books-he"><i class="fas fa-book ml-3"></i> ×¡×¤×¨×™× - ×¢×‘×¨×™×ª</div>
      <div class="nav-item sidebar-link" data-tab="books-en" id="btn-books-en"><i class="fas fa-language ml-3"></i> ××“×•×¨ ×× ×’×œ×™×ª</div>

      <div class="text-[10px] font-bold text-slate-500 px-4 mt-6 mb-2 uppercase">×›×¡×¤×™× ×•×œ×•×’×™×¡×˜×™×§×”</div>
      <div class="nav-item sidebar-link" data-tab="donors" id="btn-donors"><i class="fas fa-hand-holding-heart ml-3"></i> ×’×™×•×¡ ×›×¡×¤×™×</div>
      <div class="nav-item sidebar-link" data-tab="logistics" id="btn-logistics"><i class="fas fa-shipping-fast ml-3"></i> ×”×¤×¦×” ×•×—×•"×œ</div>
      <div class="nav-item sidebar-link" data-tab="expenses" id="btn-expenses"><i class="fas fa-file-invoice-dollar ml-3"></i> ×—×•×‘×•×ª ×œ×¡×¤×§×™×</div>
    </nav>

    <div class="p-4 bg-slate-950 border-t border-slate-800 space-y-3">
      <div>
        <p class="text-[10px] text-slate-500 mb-1 font-bold">×‘×¢×œ×•×ª ×”×¢××•×ª×”:</p>
        <p class="text-xs font-bold text-white">×××™×¨ ×©××—×” ×©×˜×™×™×Ÿ</p>
      </div>

      <button id="btn-reset" class="w-full btn btn-ghost justify-center text-xs font-extrabold">
        <i class="fas fa-eraser"></i> × ×™×§×•×™ × ×ª×•× ×™× ×©××•×¨×™×
      </button>
      <p class="text-[10px] text-slate-500 leading-snug">* ××•×—×§ × ×ª×•× ×™× ××”×“×¤×“×¤×Ÿ (LocalStorage) ×•××—×–×™×¨ ×‘×¨×™×¨×ª ××—×“×œ.</p>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 flex flex-col min-w-0">
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm">
      <div class="flex items-center gap-3">
        <button id="btn-back" class="hidden btn btn-ghost text-sm">
          <i class="fas fa-arrow-right"></i> ×—×–×¨×”
        </button>
        <h2 id="current-tab-title" class="text-lg font-extrabold text-slate-900">××©×™××•×ª ×•×œ×•"×– ×‘×™×¦×•×¢</h2>
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button id="btn-add" class="btn btn-primary shadow-md">
          <i class="fas fa-plus"></i>
          <span id="add-btn-text">×”×•×¡×£ ××©×™××”</span>
        </button>

        <button id="btn-edit-data" class="btn btn-purple shadow-md">
          <i class="fas fa-edit"></i> ×¢×¨×•×š × ×ª×•× ×™×
        </button>

        <button id="btn-refresh" class="btn btn-ghost">
          <i class="fas fa-sync-alt" id="refresh-icon"></i>
        </button>
      </div>
    </header>

    <div id="main-area" class="p-8 overflow-y-auto h-full bg-slate-50">
      <div id="tab-content" class="space-y-6"></div>
    </div>
  </main>

  <!-- MODAL -->
  <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl soft-shadow w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
      <div class="p-6 border-b bg-slate-50 flex items-center justify-between">
        <h3 id="modal-title" class="text-xl font-extrabold text-slate-900">×—×œ×•×Ÿ</h3>
        <button id="btn-close-modal" class="text-slate-400 hover:text-slate-700 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6 space-y-4 overflow-y-auto flex-1" id="modal-body"></div>
      <div class="p-6 bg-white border-t flex justify-end space-x-3 space-x-reverse">
        <button id="btn-cancel" class="btn btn-ghost">×‘×™×˜×•×œ</button>
        <button id="btn-submit" class="btn btn-primary shadow-lg">
          <i class="fas fa-check"></i> ×©××•×¨
        </button>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // STORAGE + UTILS
  // =========================
  const STORAGE_KEY = 'hoffman_admin_store_v3';
  const $ = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>[...root.querySelectorAll(q)];
  const uid = () => Math.random().toString(36).slice(2,10);
  const todayISO = () => new Date().toISOString().split('T')[0];
  const money = n => `â‚ª${Number(n||0).toLocaleString()}`;
  const escapeHtml = (str) => String(str ?? '')
    .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#039;");
  const notify = (msg) => {
    const n = document.createElement('div');
    n.className = 'fixed top-10 left-1/2 -translate-x-1/2 bg-emerald-600 text-white px-8 py-3 rounded-xl shadow-2xl z-50 font-extrabold';
    n.innerHTML = `<i class="fas fa-check-circle ml-2"></i> ${escapeHtml(msg)}`;
    document.body.appendChild(n);
    setTimeout(()=>{ n.style.opacity='0'; n.style.transition='opacity .25s'; setTimeout(()=>n.remove(),260); }, 2200);
  };

  const saveStore = () => { try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }catch(e){} };
  const loadStore = () => { try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } };

  // =========================
  // DEFAULT STORE
  // =========================
  const defaultStore = {
    tasks: [
      { id: uid(), ××©×™××”:"×”×›× ×ª ×—×©×‘×•× ×•×ª ×œ×ª×•×¨××™× ×—×•×“×© ×–×”", ×× ×”×œ:"××©×” ×›×”×Ÿ", ×“×—×™×¤×•×ª:"×’×‘×•×”×”", ×˜×•×•×—:"×—×•×“×©×™",
        ×ª××¨×™×š: todayISO(), ×™×¢×“: todayISO(), ××—×•×–: 10, ×©×¢×•×ª: 0, ××•×¨×›×‘×•×ª: 3, ×˜×™×¤×•×œ:"", ×¢×“×›×•× ×™×: []
      },
      { id: uid(), ××©×™××”:"×©×œ×™×—×ª ×¢×“×›×•×Ÿ ×œ×× ×•×™×™ ×”× ×™×•×–×œ×˜×¨", ×× ×”×œ:"×™×•×¡×™ ×œ×•×™", ×“×—×™×¤×•×ª:"×’×‘×•×”×”", ×˜×•×•×—:"×—×•×“×©×™",
        ×ª××¨×™×š: todayISO(), ×™×¢×“: todayISO(), ××—×•×–: 0, ×©×¢×•×ª: 0, ××•×¨×›×‘×•×ª: 2, ×˜×™×¤×•×œ:"", ×¢×“×›×•× ×™×: []
      },
      { id: uid(), ××©×™××”:"×‘×™×§×•×¨ ××¦×œ ××•×´×œ ×‘× ×™ ×‘×¨×§", ×× ×”×œ:"×“×•×“ ×’×•×œ×“", ×“×—×™×¤×•×ª:"×’×‘×•×”×”", ×˜×•×•×—:"×—×•×“×©×™",
        ×ª××¨×™×š: todayISO(), ×™×¢×“: todayISO(), ××—×•×–: 0, ×©×¢×•×ª: 0, ××•×¨×›×‘×•×ª: 4, ×˜×™×¤×•×œ:"", ×¢×“×›×•× ×™×: []
      },
      { id: uid(), ××©×™××”:"×ª×™××•× ×¤×’×™×©×ª ×ª×›× ×•×Ÿ ×©× ×” ×”×‘××”", ×× ×”×œ:"××©×” ×›×”×Ÿ", ×“×—×™×¤×•×ª:"×¨×’×™×œ×”", ×˜×•×•×—:"××¨×•×š",
        ×ª××¨×™×š: todayISO(), ×™×¢×“: "", ××—×•×–: 0, ×©×¢×•×ª: 0, ××•×¨×›×‘×•×ª: 3, ×˜×™×¤×•×œ:"", ×¢×“×›×•× ×™×: []
      },
      { id: uid(), ××©×™××”:"×¢×“×›×•×Ÿ ××ª×¨ ×”××™× ×˜×¨× ×˜", ×× ×”×œ:"×™×•×¡×™ ×œ×•×™", ×“×—×™×¤×•×ª:"×¨×’×™×œ×”", ×˜×•×•×—:"××¨×•×š",
        ×ª××¨×™×š: todayISO(), ×™×¢×“: "", ××—×•×–: 0, ×©×¢×•×ª: 0, ××•×¨×›×‘×•×ª: 2, ×˜×™×¤×•×œ:"", ×¢×“×›×•× ×™×: []
      }
    ],
    ideas: [
      { id: uid(), ×›×•×ª×¨×ª:"×œ×”×•×¡×™×£ ×“×£ × ×—×™×ª×” ×œ×ª×•×¨××™×", ×ª×™××•×¨:"×“×£ ×§×¦×¨ ×¢× QR ×œ×ª×¨×•××” ××”×™×¨×”", ××’×™×©:"×™×•×¡×™ ×œ×•×™", ×¡×˜×˜×•×¡:"×—×“×©", ×ª××¨×™×š: todayISO(),
        ×§×˜×’×•×¨×™×”:"×“×™×’×™×˜×œ", ×¢×“×™×¤×•×ª:"×’×‘×•×”×”", ×”×©×¤×¢×”:4, ××××¥:2, ×ª×’×™×•×ª:"×ª×¨×•××•×ª,QR", ×¦×¢×“_×”×‘×:"×˜×™×•×˜×ª ×¢×™×¦×•×‘"
      },
      { id: uid(), ×›×•×ª×¨×ª:"×©×™×˜×ª ××¢×§×‘ ×”×“×¤×¡×•×ª", ×ª×™××•×¨:"×œ×¨×›×– ×”×“×¤×¡×•×ª ×œ×¤×™ ×©× ×”/×“×¤×•×¡/×”×¢×¨×•×ª", ××’×™×©:"×©×¨×” ×’×¨×™×Ÿ", ×¡×˜×˜×•×¡:"×‘×‘×“×™×§×”", ×ª××¨×™×š: todayISO(),
        ×§×˜×’×•×¨×™×”:"×ª×¤×¢×•×œ", ×¢×“×™×¤×•×ª:"×¨×’×™×œ×”", ×”×©×¤×¢×”:3, ××××¥:3, ×ª×’×™×•×ª:"×“×¤×•×¡", ×¦×¢×“_×”×‘×:"×”×’×“×¨×ª ×©×“×•×ª"
      }
    ],
    staff: [
      { id: uid(), ×©×:"××©×” ×›×”×Ÿ", ×ª×¤×§×™×“:"×× ×”×œ ×›×œ×œ×™", ×˜×œ×¤×•×Ÿ:"050-1234567", ××™××™×™×œ:"moshe@hoffman.org" },
      { id: uid(), ×©×:"×™×•×¡×™ ×œ×•×™", ×ª×¤×§×™×“:"×× ×”×œ ×©×™×•×•×§", ×˜×œ×¤×•×Ÿ:"052-7654321", ××™××™×™×œ:"yossi@hoffman.org" },
      { id: uid(), ×©×:"×“×•×“ ×’×•×œ×“", ×ª×¤×§×™×“:"×œ×•×’×™×¡×˜×™×§×”", ×˜×œ×¤×•×Ÿ:"054-9876543", ××™××™×™×œ:"david@hoffman.org" },
      { id: uid(), ×©×:"×©×¨×” ×’×¨×™×Ÿ", ×ª×¤×§×™×“:"×¢×•×¨×›×ª ×¨××©×™×ª", ×˜×œ×¤×•×Ÿ:"050-5555555", ××™××™×™×œ:"sara@hoffman.org" }
    ],
    books: {
      he: [
        {
          id:"he-mechunach", name:"×”××—×•× ×š",
          progress:90, target:25000, raised:22500, donorsCount:15,
          cost:{ expected: 18000, actual: 16500 },
          identity:{ subtitle:"××”×“×•×¨×” ××ª×•×§× ×ª ×•××•×¨×—×‘×ª", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×›×¨×™×›×” ×§×©×”", notes:"" },
          printRuns:[ {year:2018, qty:4000, printer:"", notes:"×”×“×¤×¡×” ×¨××©×•× ×”"}, {year:2020, qty:7000, printer:"", notes:""} ],
          donors:[ { id: uid(), name:"××‘×¨×”× ×›×”×Ÿ", amount:5000, date:"2025-02-01", note:"×ª××™×›×” ×›×œ×œ×™×ª" } ]
        },
        { id:"he-yesodot", name:"×™×¡×•×“×•×ª ×”×—×™× ×•×š", progress:65, target:50000, raised:32500, donorsCount:12,
          cost:{ expected: 24000, actual: 0 },
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
          printRuns:[{year:2021, qty:4000, printer:"", notes:""}], donors:[]
        },
      ],
      en: [
        { id:"en-awareness", name:"Awareness (××•×“×¢×•×ª)", progress:70, target:60000, raised:42000, donorsCount:22,
          cost:{ expected: 32000, actual: 0 },
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Hardcover", notes:"" },
          printRuns:[], donors:[]
        }
      ]
    },
    // campaigns for fundraising
    campaigns: [
      {
        id: "camp-la-lectures",
        ×©×: "××™×–× ×”×¨×¦××•×ª ×‘×œ×•×¡ ×× ×’×œ×¡",
        ××™×©_×§×©×¨: "â€”",
        ×˜×œ×¤×•×Ÿ: "",
        ××™××™×™×œ: "",
        ×™×¢×“: 120000,
        × ×’×‘×”: 35000,
        ×ª×™××•×¨: "×¡×‘×‘ ×”×¨×¦××•×ª + ×’×™×•×¡ ×ª×•×¨××™× ×‘××¨×”×´×‘",
        ×ª×•×¨××™×: [
          { id: uid(), name:"David S.", amount: 10000, date: todayISO(), note:"Kickoff donor" }
        ],
        ××©×™××•×ª: [
          { id: uid(), title:"×œ×§×‘×•×¢ ××•×œ×", owner:"×“×•×“ ×’×•×œ×“", due: "", status:"×¤×ª×•×—" },
          { id: uid(), title:"×œ×‘× ×•×ª ×“×£ ×ª×¨×•××”", owner:"×™×•×¡×™ ×œ×•×™", due: "", status:"×¤×ª×•×—" }
        ]
      }
    ],
    donors: [
      { id: uid(), ×©×:"××‘×¨×”× ×›×”×Ÿ", ×¤×¨×•×™×§×˜:"×™×¡×•×“×•×ª ×”×—×™× ×•×š", ××ª× ×”:"5000", ×ª××¨×™×š:"2025-02-01" },
      { id: uid(), ×©×:"×©×¨×” ×œ×•×™", ×¤×¨×•×™×§×˜:"×©×™×“×•×›×™×", ××ª× ×”:"3500", ×ª××¨×™×š:"2025-02-05" }
    ],
    expenses: [
      { id: uid(), ×¡×•×’:"×¡×¤×§", ×¡×¤×§:"×“×¤×•×¡ ××¨×›×–", ×ª×™××•×¨:"×”×“×¤×¡×”/×›×¨×™×›×”", ×¡×›×•×:12500, ×©×•×œ×:0, ×™×ª×¨×”:12500, ×ª××¨×™×š: todayISO(), ×™×¢×“:"", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ", ××™×©_×§×©×¨:"", ×—×©×‘×•× ×™×ª:"" },
      { id: uid(), ×¡×•×’:"×¡×¤×§", ×¡×¤×§:"××©×¨×“ - ×©×›×™×¨×•×ª ×—×•×“×©×™×ª", ×ª×™××•×¨:"×©×›×™×¨×•×ª", ×¡×›×•×:1000, ×©×•×œ×:0, ×™×ª×¨×”:1000, ×ª××¨×™×š: todayISO(), ×™×¢×“:"", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ", ××™×©_×§×©×¨:"", ×—×©×‘×•× ×™×ª:"" },
      { id: uid(), ×¡×•×’:"×’×\"×—", ×¡×¤×§:"×’××´×— ×”×¡×¤×¨×™×", ×ª×™××•×¨:"×”×œ×•×•××”/×”×—×–×¨", ×¡×›×•×:8300, ×©×•×œ×:0, ×™×ª×¨×”:8300, ×ª××¨×™×š: todayISO(), ×™×¢×“:"", ×¡×˜×˜×•×¡:"×××ª×™×Ÿ", ××™×©_×§×©×¨:"", ×—×©×‘×•× ×™×ª:"" }
    ],
    logistics: {
      warehouse: [
        { id: uid(), date: todayISO(), note:"×¡×¤×™×¨×ª ××—×¡×Ÿ", totalBooks: 1200, damaged: 15 }
      ],
      israel: [
        { id: uid(), city:"×™×¨×•×©×œ×™×", books:350, status:"×¤×¢×™×œ", date: todayISO(), note:"" },
        { id: uid(), city:"×‘× ×™ ×‘×¨×§", books:280, status:"×¤×¢×™×œ", date: todayISO(), note:"" },
      ],
      international: [
        { id: uid(), country:"××¨×”×´×‘", books:500, status:"×‘×©×œ×™×—×”", date: todayISO(), note:"" },
        { id: uid(), country:"×× ×’×œ×™×”", books:180, status:"×¤×¢×™×œ", date: todayISO(), note:"" },
      ]
    }
  };

  // =========================
  // MIGRATION (×™×©× ×™× -> ×—×“×©×™×)
  // =========================
  function migrateStore(s){
    if(!s || typeof s !== 'object') return structuredClone(defaultStore);

    // ensure arrays exist
    s.tasks ||= [];
    s.ideas ||= [];
    s.staff ||= [];
    s.books ||= {he:[], en:[]};
    s.donors ||= [];
    s.expenses ||= [];
    s.logistics ||= {warehouse:[], israel:[], international:[]};
    s.campaigns ||= [];

    // tasks fields
    for(const t of s.tasks){
      if(t.×ª××¨×™×š === undefined) t.×ª××¨×™×š = todayISO();
      if(t.×™×¢×“ === undefined) t.×™×¢×“ = "";
      if(t.××—×•×– === undefined) t.××—×•×– = 0;
      if(t.×©×¢×•×ª === undefined) t.×©×¢×•×ª = 0;
      if(t.××•×¨×›×‘×•×ª === undefined) t.××•×¨×›×‘×•×ª = 3;
      if(t.×˜×™×¤×•×œ === undefined) t.×˜×™×¤×•×œ = "";
      if(!Array.isArray(t.×¢×“×›×•× ×™×)) t.×¢×“×›×•× ×™× = [];
    }

    // ideas fields
    for(const i of s.ideas){
      if(i.×§×˜×’×•×¨×™×” === undefined) i.×§×˜×’×•×¨×™×” = "×›×œ×œ×™";
      if(i.×¢×“×™×¤×•×ª === undefined) i.×¢×“×™×¤×•×ª = "×¨×’×™×œ×”";
      if(i.×”×©×¤×¢×” === undefined) i.×”×©×¤×¢×” = 3;
      if(i.××××¥ === undefined) i.××××¥ = 3;
      if(i.×ª×’×™×•×ª === undefined) i.×ª×’×™×•×ª = "";
      if(i.×¦×¢×“_×”×‘× === undefined) i.×¦×¢×“_×”×‘× = "";
    }

    // expenses fields
    for(const e of s.expenses){
      if(e.×¡×•×’ === undefined) e.×¡×•×’ = "×¡×¤×§";
      if(e.×ª×™××•×¨ === undefined) e.×ª×™××•×¨ = "";
      // normalize numeric
      e.×¡×›×•× = Number(e.×¡×›×•× ?? 0);
      if(e.×©×•×œ× === undefined) e.×©×•×œ× = 0;
      if(e.×™×ª×¨×” === undefined) e.×™×ª×¨×” = Math.max(0, e.×¡×›×•× - Number(e.×©×•×œ×||0));
      if(e.×ª××¨×™×š === undefined) e.×ª××¨×™×š = todayISO();
      if(e.×™×¢×“ === undefined) e.×™×¢×“ = "";
      if(e.××™×©_×§×©×¨ === undefined) e.××™×©_×§×©×¨ = "";
      if(e.×—×©×‘×•× ×™×ª === undefined) e.×—×©×‘×•× ×™×ª = "";
      if(e.×¡×˜×˜×•×¡ === undefined) e.×¡×˜×˜×•×¡ = "×××ª×™×Ÿ";
    }

    // books: cost
    for(const lang of ['he','en']){
      for(const b of (s.books[lang]||[])){
        b.cost ||= { expected: 0, actual: 0 };
        b.identity ||= {};
        b.printRuns ||= [];
        b.donors ||= [];
      }
    }

    // logistics: warehouse + dates
    s.logistics.warehouse ||= [];
    for(const x of (s.logistics.israel||[])){
      if(x.date === undefined) x.date = todayISO();
      if(x.note === undefined) x.note = "";
    }
    for(const x of (s.logistics.international||[])){
      if(x.date === undefined) x.date = todayISO();
      if(x.note === undefined) x.note = "";
    }

    // campaigns
    if(!Array.isArray(s.campaigns) || s.campaigns.length===0){
      s.campaigns = structuredClone(defaultStore.campaigns);
    } else {
      for(const c of s.campaigns){
        c.×©× ||= "××™×–×";
        c.××™×©_×§×©×¨ ||= "";
        c.×˜×œ×¤×•×Ÿ ||= "";
        c.××™××™×™×œ ||= "";
        c.×™×¢×“ = Number(c.×™×¢×“ ?? 0);
        c.× ×’×‘×” = Number(c.× ×’×‘×” ?? 0);
        c.×ª×™××•×¨ ||= "";
        c.×ª×•×¨××™× ||= [];
        c.××©×™××•×ª ||= [];
      }
    }

    return s;
  }

  let store = migrateStore(loadStore());
  saveStore();

  // =========================
  // THEME BY STAFF
  // =========================
  const PALETTE = [
    { base:'#2563eb', soft:'#eff6ff', text:'#1d4ed8' },
    { base:'#16a34a', soft:'#ecfdf5', text:'#15803d' },
    { base:'#7c3aed', soft:'#f5f3ff', text:'#6d28d9' },
    { base:'#f59e0b', soft:'#fffbeb', text:'#b45309' },
    { base:'#ef4444', soft:'#fef2f2', text:'#b91c1c' },
    { base:'#0ea5e9', soft:'#f0f9ff', text:'#0284c7' },
    { base:'#14b8a6', soft:'#f0fdfa', text:'#0f766e' },
    { base:'#64748b', soft:'#f1f5f9', text:'#334155' },
  ];
  const managerIndex = (name) => {
    const idx = store.staff.findIndex(s => s.×©× === name);
    if(idx >= 0) return idx % PALETTE.length;
    let hash=0; for(const ch of String(name||'')) hash = (hash*31 + ch.charCodeAt(0)) >>> 0;
    return hash % PALETTE.length;
  };
  const managerTheme = (name) => PALETTE[managerIndex(name)];
  const taskCountFor = (name) => store.tasks.filter(t=>t.×× ×”×œ===name).length;

  // =========================
  // APP STATE
  // =========================
  let currentTab = 'tasks';
  let historyStack = [];
  let currentBookContext = null; // {lang,id}
  let selectedTaskOwner = 'ALL';

  // =========================
  // MODAL CORE
  // =========================
  const modal = {
    show(title, bodyHtml, onSubmit=null, submitText='×©××•×¨', showSubmit=true){
      $('#modal-title').innerText = title;
      $('#modal-body').innerHTML = bodyHtml;
      $('#modal').classList.remove('hidden');
      $('#btn-submit').style.display = showSubmit ? 'inline-flex' : 'none';
      $('#btn-submit').innerHTML = `<i class="fas fa-check"></i> ${escapeHtml(submitText)}`;
      $('#btn-submit').onclick = onSubmit || (()=>modal.hide());
    },
    hide(){
      $('#modal').classList.add('hidden');
      $('#btn-submit').onclick = ()=>modal.hide();
      $('#btn-submit').style.display = 'inline-flex';
    }
  };
  $('#btn-close-modal').onclick = modal.hide;
  $('#btn-cancel').onclick = modal.hide;

  // =========================
  // FORMS
  // =========================
  function formField(field, value){
    const id = `f_${field.k}`;
    const base = `class="mini-input" id="${id}"`;
    const label = `<label class="block text-xs font-extrabold text-slate-600 mb-1">${escapeHtml(field.label)}</label>`;
    if(field.type === 'textarea'){
      return `<div>${label}<textarea ${base} rows="${field.rows||4}" placeholder="${escapeHtml(field.label)}">${escapeHtml(value)}</textarea></div>`;
    }
    if(field.type === 'select'){
      const opts = (field.options?.() || []).map(o => `
        <option value="${escapeHtml(o)}" ${String(value)===String(o)?'selected':''}>${escapeHtml(o)}</option>
      `).join('');
      return `<div>${label}<select ${base}>${opts}</select></div>`;
    }
    return `<div>${label}<input ${base} type="${field.type||'text'}" value="${escapeHtml(value)}" placeholder="${escapeHtml(field.label)}"/></div>`;
  }

  // =========================
  // SCHEMAS
  // =========================
  const SCHEMAS = {
    task: {
      title: (x)=>`××©×™××”: ${x.××©×™××”}`,
      list: ()=>store.tasks,
      remove: (id)=> store.tasks = store.tasks.filter(x=>x.id!==id),
      fields: [
        {k:'××©×™××”', label:'×ª×™××•×¨ ××©×™××”', type:'text', req:true},
        {k:'×× ×”×œ', label:'××—×¨××™', type:'select', req:true, options: ()=>store.staff.map(s=>s.×©×)},
        {k:'×“×—×™×¤×•×ª', label:'×“×—×™×¤×•×ª', type:'select', options: ()=>['×¨×’×™×œ×”','×’×‘×•×”×”']},
        {k:'×˜×•×•×—', label:'×˜×•×•×—', type:'select', options: ()=>['×—×•×“×©×™','××¨×•×š']},
        {k:'×ª××¨×™×š', label:'×ª××¨×™×š ××©×™××” (×œ×œ×•×— ×©× ×”)', type:'date', req:true},
        {k:'×™×¢×“', label:'×“×“×œ×™×™×Ÿ (××•×¤×¦×™×•× ×œ×™)', type:'date'},
        {k:'××—×•×–', label:'××—×•×– ×‘×™×¦×•×¢ (0-100)', type:'number'},
        {k:'×©×¢×•×ª', label:'×©×¢×•×ª ×©×”×•×©×§×¢×•', type:'number'},
        {k:'××•×¨×›×‘×•×ª', label:'××•×¨×›×‘×•×ª (1-5)', type:'select', options: ()=>['1','2','3','4','5']},
        {k:'×˜×™×¤×•×œ', label:'××™×š ××˜×¤×œ×™× ×‘××©×™××” (×¤×™×¨×•×˜ ×œ×¢×•×‘×“)', type:'textarea', rows:5},
      ]
    },
    idea: {
      title: (x)=>`×¨×¢×™×•×Ÿ: ${x.×›×•×ª×¨×ª}`,
      list: ()=>store.ideas,
      remove: (id)=> store.ideas = store.ideas.filter(x=>x.id!==id),
      fields: [
        {k:'×›×•×ª×¨×ª', label:'×›×•×ª×¨×ª', type:'text', req:true},
        {k:'×ª×™××•×¨', label:'×ª×™××•×¨', type:'textarea', rows:4},
        {k:'×§×˜×’×•×¨×™×”', label:'×§×˜×’×•×¨×™×”', type:'select', options: ()=>['×“×™×’×™×˜×œ','×ª×¤×¢×•×œ','×©×™×•×•×§','×¢×¨×™×›×”','×’×™×•×¡','×›×œ×œ×™']},
        {k:'×¢×“×™×¤×•×ª', label:'×¢×“×™×¤×•×ª', type:'select', options: ()=>['×¨×’×™×œ×”','×’×‘×•×”×”','×§×¨×™×˜×™×ª']},
        {k:'×”×©×¤×¢×”', label:'×”×©×¤×¢×” (1-5)', type:'select', options: ()=>['1','2','3','4','5']},
        {k:'××××¥', label:'××××¥ (1-5)', type:'select', options: ()=>['1','2','3','4','5']},
        {k:'×ª×’×™×•×ª', label:'×ª×’×™×•×ª (××•×¤×¨×“×•×ª ×‘×¤×¡×™×§×™×)', type:'text'},
        {k:'×¦×¢×“_×”×‘×', label:'×¦×¢×“ ×”×‘×', type:'text'},
        {k:'××’×™×©', label:'××™ ×”×¦×™×¢', type:'select', options: ()=>store.staff.map(s=>s.×©×)},
        {k:'×¡×˜×˜×•×¡', label:'×¡×˜×˜×•×¡', type:'select', options: ()=>['×—×“×©','×‘×‘×“×™×§×”','××•×©×¨','× ×“×—×”']},
        {k:'×ª××¨×™×š', label:'×ª××¨×™×š', type:'date'},
      ]
    },
    staff: {
      title: (x)=>`×¢×•×‘×“: ${x.×©×}`,
      list: ()=>store.staff,
      remove: (id)=> store.staff = store.staff.filter(x=>x.id!==id),
      fields: [
        {k:'×©×', label:'×©×', type:'text', req:true},
        {k:'×ª×¤×§×™×“', label:'×ª×¤×§×™×“', type:'text', req:true},
        {k:'×˜×œ×¤×•×Ÿ', label:'×˜×œ×¤×•×Ÿ', type:'text'},
        {k:'××™××™×™×œ', label:'××™××™×™×œ', type:'email'},
      ]
    },
    donor: {
      title: (x)=>`×ª×•×¨×: ${x.×©×}`,
      list: ()=>store.donors,
      remove: (id)=> store.donors = store.donors.filter(x=>x.id!==id),
      fields: [
        {k:'×©×', label:'×©× ×ª×•×¨×', type:'text', req:true},
        {k:'×¤×¨×•×™×§×˜', label:'×¤×¨×•×™×§×˜/×¡×¤×¨', type:'text', req:true},
        {k:'××ª× ×”', label:'×¡×›×•×', type:'number', req:true},
        {k:'×ª××¨×™×š', label:'×ª××¨×™×š', type:'date', req:true},
      ]
    },
    expense: {
      title: (x)=>`×—×•×‘: ${x.×¡×¤×§}`,
      list: ()=>store.expenses,
      remove: (id)=> store.expenses = store.expenses.filter(x=>x.id!==id),
      fields: [
        {k:'×¡×•×’', label:'×¡×•×’ (×¡×¤×§/×’×"×—)', type:'select', options: ()=>['×¡×¤×§','×’×"×—']},
        {k:'×¡×¤×§', label:'×©× ×¡×¤×§ / ×’×"×—', type:'text', req:true},
        {k:'×ª×™××•×¨', label:'××” ×”×•× ×¢×©×” / ×¢×œ ××” ×”×—×•×‘', type:'textarea', rows:3},
        {k:'×—×©×‘×•× ×™×ª', label:'×—×©×‘×•× ×™×ª / ××¡××›×ª×', type:'text'},
        {k:'××™×©_×§×©×¨', label:'××™×© ×§×©×¨', type:'text'},
        {k:'×ª××¨×™×š', label:'×ª××¨×™×š ×™×¦×™×¨×ª ×”×—×•×‘', type:'date'},
        {k:'×™×¢×“', label:'×“×“×œ×™×™×Ÿ ×œ×ª×©×œ×•×', type:'date'},
        {k:'×¡×›×•×', label:'×¡×›×•× ×›×•×œ×œ', type:'number', req:true},
        {k:'×©×•×œ×', label:'×›××” ×©×•×œ× ×¢×“ ×›×”', type:'number'},
        {k:'×™×ª×¨×”', label:'×™×ª×¨×” ×œ×ª×©×œ×•×', type:'number'},
        {k:'×¡×˜×˜×•×¡', label:'×¡×˜×˜×•×¡', type:'select', options: ()=>['×××ª×™×Ÿ','×©×•×œ×','×¤×¨×™×¡×”','×•×™×›×•×—']},
      ]
    },
    logistics_israel: {
      title: (x)=>`×”×¤×¦×” ×‘××¨×¥: ${x.city}`,
      list: ()=>store.logistics.israel,
      remove: (id)=> store.logistics.israel = store.logistics.israel.filter(x=>x.id!==id),
      fields: [
        {k:'city', label:'×¢×™×¨', type:'text', req:true},
        {k:'books', label:'×›××•×ª ×¡×¤×¨×™×', type:'number', req:true},
        {k:'status', label:'×¡×˜×˜×•×¡', type:'select', options: ()=>['×¤×¢×™×œ','×‘×”××ª× ×”']},
        {k:'date', label:'×ª××¨×™×š ×¢×“×›×•×Ÿ', type:'date'},
        {k:'note', label:'×”×¢×¨×”', type:'text'},
      ]
    },
    logistics_intl: {
      title: (x)=>`×”×¤×¦×” ×‘×—×•×´×œ: ${x.country}`,
      list: ()=>store.logistics.international,
      remove: (id)=> store.logistics.international = store.logistics.international.filter(x=>x.id!==id),
      fields: [
        {k:'country', label:'××“×™× ×”', type:'text', req:true},
        {k:'books', label:'×›××•×ª ×¡×¤×¨×™×', type:'number', req:true},
        {k:'status', label:'×¡×˜×˜×•×¡', type:'select', options: ()=>['×¤×¢×™×œ','×‘×©×œ×™×—×”','×‘×ª×›× ×•×Ÿ']},
        {k:'date', label:'×ª××¨×™×š ×¢×“×›×•×Ÿ', type:'date'},
        {k:'note', label:'×”×¢×¨×”', type:'text'},
      ]
    }
  };

  // =========================
  // TASK: updates (×™×•××Ÿ ×¢×“×›×•× ×™×)
  // =========================
  function renderTaskUpdates(task){
    const rows = (task.×¢×“×›×•× ×™×||[]).map((u,idx)=>`
      <div class="p-3 rounded-xl border bg-slate-50">
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-500 font-bold">${escapeHtml(u.date||'')}</div>
          <button class="text-red-600 text-xs font-extrabold hover:underline" data-del-update="${idx}">
            <i class="fas fa-trash ml-1"></i> ××—×§
          </button>
        </div>
        <div class="mt-2 text-sm font-bold text-slate-800">${escapeHtml(u.text||'')}</div>
        <div class="mt-2 text-[11px] text-slate-500">×©×¢×•×ª ×©× ×•×¡×¤×•: <b>${Number(u.hours||0)}</b> â€¢ ××—×•×– ××—×¨×™ ×¢×“×›×•×Ÿ: <b>${Number(u.progressAfter||0)}%</b></div>
      </div>
    `).join('');

    return `
      <div class="mt-4 pt-4 border-t">
        <div class="flex items-center justify-between mb-3">
          <div class="font-extrabold text-slate-800"><i class="fas fa-notes-medical ml-2 text-emerald-600"></i> ×™×•××Ÿ ×¢×“×›×•× ×™×</div>
          <button class="btn btn-emerald text-xs" id="btn-add-update">
            <i class="fas fa-plus"></i> ×”×•×¡×£ ×¢×“×›×•×Ÿ
          </button>
        </div>
        <div class="space-y-2" id="updates-wrap">
          ${rows || `<div class="text-sm text-slate-400 text-center py-4">××™×Ÿ ×¢×“×›×•× ×™× ×¢×“×™×™×Ÿ.</div>`}
        </div>
      </div>
    `;
  }

  // =========================
  // EDIT ENTITY
  // =========================
  function openEditEntity(schemaKey, entityId){
    const schema = SCHEMAS[schemaKey];
    const list = schema.list();
    const entity = list.find(x=>x.id===entityId);
    if(!entity) return;

    const th = (schemaKey==='task') ? managerTheme(entity.×× ×”×œ) : null;

    const topBar = th ? `
      <div class="p-4 rounded-2xl border mb-4" style="background:${th.soft}; border-color:${th.base}">
        <div class="text-xs font-extrabold" style="color:${th.text}">××—×¨××™: ${escapeHtml(entity.×× ×”×œ)}</div>
        <div class="text-[10px]" style="color:${th.text}99">×“×—×™×¤×•×ª: ${escapeHtml(entity.×“×—×™×¤×•×ª)} â€¢ ×˜×•×•×—: ${escapeHtml(entity.×˜×•×•×—)} â€¢ ××•×¨×›×‘×•×ª: ${escapeHtml(entity.××•×¨×›×‘×•×ª)}</div>
      </div>` : '';

    const extraTask = (schemaKey==='task') ? `
      <div class="mt-3 p-4 rounded-2xl border bg-white">
        <div class="text-xs text-slate-500 font-extrabold uppercase mb-2">×ª××•× ×ª ××¦×‘</div>
        <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
          <div class="h-full progress-bar" style="width:${Number(entity.××—×•×–||0)}%; background:linear-gradient(135deg,#34d399,#10b981)"></div>
        </div>
        <div class="mt-2 text-xs text-slate-500">××—×•×– ×‘×™×¦×•×¢: <b>${Number(entity.××—×•×–||0)}%</b> â€¢ ×©×¢×•×ª: <b>${Number(entity.×©×¢×•×ª||0)}</b></div>
      </div>
      ${renderTaskUpdates(entity)}
    ` : '';

    const body = `
      ${topBar}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${schema.fields.map(f => formField(f, entity[f.k] ?? '')).join('')}
      </div>

      ${extraTask}

      <div class="pt-4 mt-4 border-t flex items-center justify-between">
        <button class="text-red-600 font-extrabold text-sm hover:underline" id="btn-del">
          <i class="fas fa-trash ml-2"></i> ××—×§
        </button>

        ${schemaKey==='idea' ? `
          <button class="btn btn-emerald text-sm" id="btn-idea-to-task">
            <i class="fas fa-list-check"></i> ×”×¤×•×š ×œ××©×™××”
          </button>
        ` : ''}
      </div>
    `;

    modal.show(schema.title(entity), body, () => {
      // validate + save
      for(const f of schema.fields){
        const v = $(`#f_${f.k}`).value;
        if(f.req && !String(v).trim()) return alert('× × ×œ××œ× ×©×“×•×ª ×—×•×‘×”');
      }
      for(const f of schema.fields){
        let v = $(`#f_${f.k}`).value;
        if(f.type==='number') v = parseInt(v||0);
        entity[f.k] = v;
      }

      // task: recalc remaining for expenses
      if(schemaKey==='expense'){
        entity.×¡×›×•× = Number(entity.×¡×›×•×||0);
        entity.×©×•×œ× = Number(entity.×©×•×œ×||0);
        entity.×™×ª×¨×” = Math.max(0, entity.×¡×›×•× - entity.×©×•×œ×);
      }

      saveStore();
      modal.hide();
      render();
      notify('×¢×•×“×›×Ÿ âœ…');
    }, '×©××•×¨');

    $('#btn-del').onclick = () => {
      if(!confirm('×œ××—×•×§ ×¤×¨×™×˜ ×–×”?')) return;
      schema.remove(entityId);
      saveStore();
      modal.hide();
      render();
      notify('× ××—×§ ğŸ—‘ï¸');
    };

    // idea -> task
    const btnIdeaToTask = $('#btn-idea-to-task');
    if(btnIdeaToTask){
      btnIdeaToTask.onclick = () => {
        if(!confirm('×œ×”×¤×•×š ××ª ×”×¨×¢×™×•×Ÿ ×”×–×” ×œ××©×™××”?')) return;
        store.tasks.unshift({
          id: uid(),
          ××©×™××”: entity.×›×•×ª×¨×ª,
          ×× ×”×œ: entity.××’×™×© || (store.staff[0]?.×©× || ''),
          ×“×—×™×¤×•×ª: entity.×¢×“×™×¤×•×ª==='×§×¨×™×˜×™×ª' ? '×’×‘×•×”×”' : '×¨×’×™×œ×”',
          ×˜×•×•×—: '××¨×•×š',
          ×ª××¨×™×š: todayISO(),
          ×™×¢×“: "",
          ××—×•×–: 0,
          ×©×¢×•×ª: 0,
          ××•×¨×›×‘×•×ª: Number(entity.××××¥||3),
          ×˜×™×¤×•×œ: entity.×¦×¢×“_×”×‘× ? `×¦×¢×“ ×”×‘×: ${entity.×¦×¢×“_×”×‘×}` : "",
          ×¢×“×›×•× ×™×:[]
        });
        entity.×¡×˜×˜×•×¡ = '××•×©×¨';
        saveStore();
        modal.hide();
        switchTab('tasks');
        notify('×”×•××¨ ×œ××©×™××” ğŸ¯');
      };
    }

    // task updates add
    if(schemaKey==='task'){
      const btnAddUpdate = $('#btn-add-update');
      if(btnAddUpdate){
        btnAddUpdate.onclick = () => {
          // nested modal
          modal.show('×”×•×¡×£ ×¢×“×›×•×Ÿ ×œ××©×™××”', `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${formField({k:'u_date',label:'×ª××¨×™×š',type:'date',req:true}, todayISO())}
              ${formField({k:'u_hours',label:'×›××” ×©×¢×•×ª × ×•×¡×¤×• ×‘×¢×“×›×•×Ÿ ×–×”',type:'number',req:true}, 1)}
              ${formField({k:'u_progress',label:'××—×•×– ×‘×™×¦×•×¢ ××—×¨×™ ×”×¢×“×›×•×Ÿ (0-100)',type:'number',req:true}, entity.××—×•×–||0)}
              <div class="md:col-span-2">${formField({k:'u_text',label:'××” ×‘×•×¦×¢ / ××™×š ××˜×¤×œ×™×',type:'textarea',rows:5,req:true}, '')}</div>
            </div>
          `, () => {
            const d = $('#f_u_date').value;
            const h = Number($('#f_u_hours').value||0);
            const p = Math.max(0, Math.min(100, Number($('#f_u_progress').value||0)));
            const tx = $('#f_u_text').value.trim();
            if(!d || !tx) return alert('× × ×œ××œ× ×©×“×•×ª ×—×•×‘×”');

            entity.×¢×“×›×•× ×™×.unshift({ date:d, hours:h, progressAfter:p, text:tx });
            entity.×©×¢×•×ª = Number(entity.×©×¢×•×ª||0) + h;
            entity.××—×•×– = p;

            saveStore();
            modal.hide();
            // reopen entity editor with refreshed
            openEditEntity('task', entityId);
            notify('×¢×“×›×•×Ÿ × ×•×¡×£ ğŸ“');
          }, '×”×•×¡×£');
        };
      }

      // delete update delegation
      $('#modal-body').onclick = (e) => {
        const du = e.target.closest('[data-del-update]')?.dataset?.delUpdate;
        if(du !== undefined){
          if(!confirm('×œ××—×•×§ ×¢×“×›×•×Ÿ ×–×”?')) return;
          entity.×¢×“×›×•× ×™×.splice(Number(du),1);
          saveStore();
          openEditEntity('task', entityId);
          notify('×¢×“×›×•×Ÿ × ××—×§');
        }
      };
    }
  }

  // =========================
  // BOOK DETAIL
  // =========================
  const findBook = (lang,id) => store.books[lang].find(b=>b.id===id);

  function setBookField(lang, id, path, value){
    const b = findBook(lang, id); if(!b) return;
    const [root,key] = path.split('.');
    b[root] = b[root] || {};
    b[root][key] = (key==='pages' || key==='expected' || key==='actual') ? parseInt(value||0) : value;
    saveStore();
  }

  function recalcBookProgress(b){
    b.progress = Math.max(0, Math.min(100, Math.round((Number(b.raised||0) / Math.max(1, Number(b.target||0))) * 100)));
  }

  function renderBookDetail(container, lang, bookId){
    const b = findBook(lang, bookId);
    if(!b){ container.innerHTML = `<div class="card">×œ× × ××¦× ×¡×¤×¨</div>`; return; }
    currentBookContext = {lang, id: bookId};
    $('#current-tab-title').innerText = `×¡×¤×¨: ${b.name}`;
    $('#btn-back').classList.remove('hidden');

    b.cost ||= {expected:0, actual:0};
    const identity = b.identity || (b.identity = {});
    const pr = b.printRuns || (b.printRuns = []);
    const bd = b.donors || (b.donors = []);
    const sumPrint = pr.reduce((s,r)=>s+(Number(r.qty)||0),0);
    const sumDon = bd.reduce((s,d)=>s+(Number(d.amount)||0),0);

    const gap = Math.max(0, Number(b.target||0) - Number(b.raised||0));
    const costGap = Math.max(0, Number(b.cost.expected||0) - Number(b.cost.actual||0));

    const fieldInput = (label, val, oninput, type='text') => `
      <div>
        <label class="block text-xs font-extrabold text-slate-600 mb-1">${escapeHtml(label)}</label>
        <input type="${type}" value="${escapeHtml(String(val??''))}"
          oninput="${oninput}"
          class="mini-input" />
      </div>
    `;

    container.innerHTML = `
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card lg:col-span-1 border-r-4 border-blue-600">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-400 font-extrabold uppercase">×ª×¢×•×“×ª ×–×”×•×ª â€¢ ${lang==='he'?'×¢×‘×¨×™×ª':'English'}</div>
              <div class="text-2xl font-extrabold mt-1">${escapeHtml(b.name)}</div>
              <div class="text-sm text-slate-500 mt-1">${escapeHtml(identity.subtitle || 'â€”')}</div>
            </div>
            <div class="text-blue-600 text-2xl"><i class="fas fa-book-open"></i></div>
          </div>

          <div class="mt-6 space-y-3 text-sm">
            <div class="flex justify-between"><span class="text-slate-500">×™×¢×“ ×’×™×•×¡</span><span class="font-extrabold">${money(b.target)}</span></div>
            <div class="flex justify-between"><span class="text-slate-500">× ×’×‘×”</span><span class="font-extrabold text-emerald-600">${money(b.raised)}</span></div>
            <div class="flex justify-between"><span class="text-slate-500">×—×¡×¨ ×œ×’×™×•×¡</span><span class="font-extrabold text-red-600">${money(gap)}</span></div>

            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
              <div class="h-full progress-bar" style="width:${b.progress}%; background:linear-gradient(135deg,#34d399,#10b981)"></div>
            </div>

            <div class="mt-2 p-3 rounded-2xl bg-slate-50 border">
              <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¢×œ×•×ª ×”×¡×¤×¨</div>
              <div class="mt-1 flex justify-between text-sm">
                <span class="text-slate-600">×¦×¤×•×™×”</span><span class="font-extrabold">${money(b.cost.expected||0)}</span>
              </div>
              <div class="mt-1 flex justify-between text-sm">
                <span class="text-slate-600">×‘×¤×•×¢×œ</span><span class="font-extrabold">${money(b.cost.actual||0)}</span>
              </div>
              <div class="mt-1 flex justify-between text-sm">
                <span class="text-slate-600">×¤×¢×¨ ×¢×œ×•×ª</span><span class="font-extrabold">${money(costGap)}</span>
              </div>
              <div class="text-[11px] text-slate-500 mt-2">* ×’× ×× ×–×” â€œ×¡×¤×¨ ×¢×ª×™×“×™â€ â€” ××œ× ×¢×œ×•×ª ×¦×¤×•×™×” + ×™×¢×“ ×’×™×•×¡.</div>
            </div>

            <div class="pt-3 border-t grid grid-cols-2 gap-3">
              <div class="p-3 rounded-2xl bg-slate-50">
                <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×”×“×¤×¡×•×ª</div>
                <div class="text-xl font-extrabold mt-1">${pr.length}</div>
              </div>
              <div class="p-3 rounded-2xl bg-slate-50">
                <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×¢×•×ª×§×™×</div>
                <div class="text-xl font-extrabold mt-1">${Number(sumPrint).toLocaleString()}</div>
              </div>
              <div class="p-3 rounded-2xl bg-emerald-50 col-span-2 border border-emerald-100">
                <div class="text-[10px] text-emerald-700 font-extrabold uppercase">×ª×•×¨××™× ×‘×¨××ª ×”×¡×¤×¨</div>
                <div class="text-xl font-extrabold mt-1">${money(sumDon)}</div>
              </div>
            </div>

            <button class="w-full mt-3 btn btn-primary justify-center" id="btn-save-book">
              <i class="fas fa-save"></i> ×©××•×¨ (××§×•××™)
            </button>

            <div class="text-xs text-slate-400">* × ×©××¨ ×‘×“×¤×“×¤×Ÿ (LocalStorage) ××•×˜×•××˜×™×ª.</div>
          </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
          <div class="card border-r-4 border-slate-300">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-extrabold text-slate-900"><i class="fas fa-id-card ml-2 text-slate-500"></i> ×¤×¨×˜×™ ×”×¡×¤×¨</h3>
              <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-pen"></i> × ×™×ª×Ÿ ×œ×¢×¨×™×›×”</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              ${fieldInput('×›×•×ª×¨×ª ××©× ×”', identity.subtitle, `setBookField('${lang}','${b.id}','identity.subtitle', this.value)`)}
              ${fieldInput('××—×‘×¨', identity.author, `setBookField('${lang}','${b.id}','identity.author', this.value)`)}
              ${fieldInput('×¢×•×¨×š', identity.editor, `setBookField('${lang}','${b.id}','identity.editor', this.value)`)}
              ${fieldInput('×¡×“×¨×”', identity.series, `setBookField('${lang}','${b.id}','identity.series', this.value)`)}
              ${fieldInput('ISBN', identity.isbn, `setBookField('${lang}','${b.id}','identity.isbn', this.value)`)}
              ${fieldInput('××¡×³ ×¢××•×“×™×', identity.pages, `setBookField('${lang}','${b.id}','identity.pages', this.value)`, 'number')}
              ${fieldInput('×’×•×“×œ (Trim)', identity.trim, `setBookField('${lang}','${b.id}','identity.trim', this.value)`)}
              ${fieldInput('×›×¨×™×›×”', identity.binding, `setBookField('${lang}','${b.id}','identity.binding', this.value)`)}
              ${fieldInput('×¢×œ×•×ª ×¦×¤×•×™×”', b.cost.expected, `setBookField('${lang}','${b.id}','cost.expected', this.value)`, 'number')}
              ${fieldInput('×¢×œ×•×ª ×‘×¤×•×¢×œ', b.cost.actual, `setBookField('${lang}','${b.id}','cost.actual', this.value)`, 'number')}
            </div>

            <div class="mt-4">
              <label class="block text-xs font-extrabold text-slate-600 mb-1">×”×¢×¨×•×ª</label>
              <textarea class="mini-input" rows="3"
                oninput="setBookField('${lang}','${b.id}','identity.notes', this.value)"
                placeholder="×”×¢×¨×•×ª ×¤× ×™××™×•×ª...">${escapeHtml(identity.notes||'')}</textarea>
            </div>
          </div>

          <div class="card border-r-4 border-purple-500">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-extrabold text-slate-900"><i class="fas fa-print ml-2 text-purple-600"></i> ×”×™×¡×˜×•×¨×™×™×ª ×”×“×¤×¡×•×ª</h3>
              <button class="btn btn-purple text-sm" id="btn-add-pr">
                <i class="fas fa-plus"></i> ×”×•×¡×£ ×”×“×¤×¡×”
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-right text-sm">
                <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
                  <tr>
                    <th class="p-3">×©× ×”</th><th class="p-3">×›××•×ª</th><th class="p-3">×“×¤×•×¡</th><th class="p-3">×”×¢×¨×•×ª</th><th class="p-3 text-left">×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody>
                  ${
                    pr.length ? pr.map((r, idx)=>`
                      <tr class="border-b hover:bg-slate-50">
                        <td class="p-3"><input type="number" class="p-2 border rounded-lg w-24" value="${r.year??''}" data-pr="${idx}" data-f="year"></td>
                        <td class="p-3"><input type="number" class="p-2 border rounded-lg w-28" value="${r.qty??''}" data-pr="${idx}" data-f="qty"></td>
                        <td class="p-3"><input class="p-2 border rounded-lg w-full" value="${escapeHtml(r.printer||'')}" data-pr="${idx}" data-f="printer"></td>
                        <td class="p-3"><input class="p-2 border rounded-lg w-full" value="${escapeHtml(r.notes||'')}" data-pr="${idx}" data-f="notes"></td>
                        <td class="p-3 text-left">
                          <button class="text-red-600 hover:underline text-xs font-extrabold" data-delpr="${idx}">
                            <i class="fas fa-trash ml-1"></i> ××—×§
                          </button>
                        </td>
                      </tr>
                    `).join('') : `
                      <tr><td class="p-6 text-center text-slate-400" colspan="5">××™×Ÿ ×¢×“×™×™×Ÿ ×”×“×¤×¡×•×ª. ×œ×—×¥ "×”×•×¡×£ ×”×“×¤×¡×”".</td></tr>
                    `
                  }
                </tbody>
              </table>
            </div>
            <div class="mt-3 text-xs text-slate-400">×¡×”×´×› ×¢×•×ª×§×™×: <span class="font-extrabold text-slate-900">${Number(sumPrint).toLocaleString()}</span></div>
          </div>

          <div class="card border-r-4 border-emerald-500">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-extrabold text-slate-900"><i class="fas fa-hand-holding-heart ml-2 text-emerald-600"></i> ×ª×•×¨××™× ×©×œ ×”×¡×¤×¨</h3>
              <button class="btn btn-emerald text-sm" id="btn-add-bd">
                <i class="fas fa-plus"></i> ×”×•×¡×£ ×ª×•×¨×
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-right text-sm">
                <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
                  <tr><th class="p-3">×©×</th><th class="p-3">×ª××¨×™×š</th><th class="p-3">×¡×›×•×</th><th class="p-3">×”×¢×¨×”</th><th class="p-3 text-left">×¤×¢×•×œ×•×ª</th></tr>
                </thead>
                <tbody>
                  ${
                    bd.length ? bd.map((d, idx)=>`
                      <tr class="border-b hover:bg-slate-50">
                        <td class="p-3"><input class="p-2 border rounded-lg w-full" value="${escapeHtml(d.name||'')}" data-bd="${idx}" data-f="name"></td>
                        <td class="p-3"><input type="date" class="p-2 border rounded-lg" value="${d.date||todayISO()}" data-bd="${idx}" data-f="date"></td>
                        <td class="p-3"><input type="number" class="p-2 border rounded-lg w-32" value="${d.amount??''}" data-bd="${idx}" data-f="amount"></td>
                        <td class="p-3"><input class="p-2 border rounded-lg w-full" value="${escapeHtml(d.note||'')}" data-bd="${idx}" data-f="note"></td>
                        <td class="p-3 text-left">
                          <button class="text-red-600 hover:underline text-xs font-extrabold" data-delbd="${idx}">
                            <i class="fas fa-trash ml-1"></i> ××—×§
                          </button>
                        </td>
                      </tr>
                    `).join('') : `
                      <tr><td class="p-6 text-center text-slate-400" colspan="5">××™×Ÿ ×ª×•×¨××™× ×¢×“×™×™×Ÿ. ×œ×—×¥ "×”×•×¡×£ ×ª×•×¨×".</td></tr>
                    `
                  }
                </tbody>
              </table>
            </div>
            <div class="mt-3 text-xs text-slate-400">×¡×”×´×› ×ª×¨×•××•×ª ×œ×¡×¤×¨: <span class="font-extrabold text-emerald-700">${money(sumDon)}</span></div>
          </div>

        </div>
      </div>
    `;

    $('#btn-save-book').onclick = () => { saveStore(); notify('× ×©××¨ âœ…'); };

    $('#btn-add-pr').onclick = () => {
      pr.unshift({ year: new Date().getFullYear(), qty: 0, printer:"", notes:"" });
      saveStore();
      renderBookDetail(container, lang, bookId);
      notify('× ×•×¡×¤×” ×”×“×¤×¡×”');
    };
    $('#btn-add-bd').onclick = () => {
      bd.unshift({ id: uid(), name:'×ª×•×¨× ×—×“×©', amount:0, date: todayISO(), note:'' });
      saveStore();
      renderBookDetail(container, lang, bookId);
      notify('× ×•×¡×£ ×ª×•×¨×');
    };

    container.oninput = (e) => {
      const t = e.target;
      if(t?.dataset?.pr){
        const idx = Number(t.dataset.pr), f=t.dataset.f;
        if(!pr[idx]) return;
        pr[idx][f] = (f==='year'||f==='qty') ? parseInt(t.value||0) : t.value;
        saveStore();
      }
      if(t?.dataset?.bd){
        const idx = Number(t.dataset.bd), f=t.dataset.f;
        if(!bd[idx]) return;
        bd[idx][f] = (f==='amount') ? parseInt(t.value||0) : t.value;
        saveStore();
      }
    };

    container.onclick = (e) => {
      const delpr = e.target.closest('[data-delpr]')?.dataset?.delpr;
      if(delpr !== undefined){
        if(confirm('×œ××—×•×§ ×©×•×¨×ª ×”×“×¤×¡×”?')){
          pr.splice(Number(delpr),1);
          saveStore();
          renderBookDetail(container, lang, bookId);
          notify('×©×•×¨×ª ×”×“×¤×¡×” × ××—×§×”');
        }
      }
      const delbd = e.target.closest('[data-delbd]')?.dataset?.delbd;
      if(delbd !== undefined){
        if(confirm('×œ××—×•×§ ×ª×•×¨×?')){
          bd.splice(Number(delbd),1);
          saveStore();
          renderBookDetail(container, lang, bookId);
          notify('×ª×•×¨× × ××—×§');
        }
      }
    };
  }

  // =========================
  // TASKS: calendar
  // =========================
  function startOfMonth(d){
    return new Date(d.getFullYear(), d.getMonth(), 1);
  }
  function endOfMonth(d){
    return new Date(d.getFullYear(), d.getMonth()+1, 0);
  }
  function fmtMonth(d){
    return d.toLocaleDateString('he-IL',{month:'long',year:'numeric'});
  }
  function dateToISO(d){
    return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  }

  let calendarCursor = new Date(); // current month view

  function tasksOnDay(iso){
    const list = selectedTaskOwner==='ALL' ? store.tasks : store.tasks.filter(t=>t.×× ×”×œ===selectedTaskOwner);
    return list.filter(t => (t.×ª××¨×™×š||'') === iso);
  }

  function openDayTasks(iso){
    const list = tasksOnDay(iso);
    modal.show(`××©×™××•×ª ×œ×™×•×: ${iso}`, `
      <div class="text-sm text-slate-500">××¦×‘: <b>${selectedTaskOwner==='ALL'?'×›×œ ×”×¢×•×‘×“×™×':escapeHtml(selectedTaskOwner)}</b></div>
      <div class="mt-3 space-y-2">
        ${list.length ? list.map(t=>{
          const th = managerTheme(t.×× ×”×œ);
          return `
            <button class="w-full text-right p-4 rounded-2xl border hover:shadow-sm transition"
              style="border-color:${th.base}; background:${th.soft}"
              data-open="task" data-id="${t.id}">
              <div class="flex items-center justify-between gap-3">
                <div class="font-extrabold" style="color:${th.text}">${escapeHtml(t.××©×™××”)}</div>
                <span class="chip" style="background:#ffffffb3;border:1px solid ${th.base};color:${th.text}">
                  ${escapeHtml(t.×× ×”×œ)} â€¢ ${Number(t.××—×•×–||0)}%
                </span>
              </div>
              <div class="mt-2 text-xs" style="color:${th.text}99">
                ××•×¨×›×‘×•×ª: ${escapeHtml(t.××•×¨×›×‘×•×ª)} â€¢ ×©×¢×•×ª: ${Number(t.×©×¢×•×ª||0)} â€¢ ×“×“×œ×™×™×Ÿ: ${escapeHtml(t.×™×¢×“||'â€”')}
              </div>
            </button>
          `;
        }).join('') : `<div class="p-6 text-center text-slate-400">××™×Ÿ ××©×™××•×ª ×‘×™×•× ×”×–×”.</div>`}
      </div>
    `, null, '×©××•×¨', false);
  }

  function renderCalendar(){
    const d = new Date(calendarCursor);
    const start = startOfMonth(d);
    const end = endOfMonth(d);

    // calendar grid starts Sunday (0) in JS; in Israel often Sunday is first. We'll keep Sunday start.
    const startDow = start.getDay(); // 0-6
    const daysInMonth = end.getDate();

    // build 6 weeks grid (max)
    const cells = [];
    const totalCells = 42;
    for(let i=0;i<totalCells;i++){
      const dayNum = i - startDow + 1;
      if(dayNum < 1 || dayNum > daysInMonth){
        cells.push({ muted:true, label:'', iso:'' });
      } else {
        const dd = new Date(d.getFullYear(), d.getMonth(), dayNum);
        const iso = dateToISO(dd);
        const ts = tasksOnDay(iso);
        const urgent = ts.filter(x=>x.×“×—×™×¤×•×ª==='×’×‘×•×”×”').length;
        const avgProg = ts.length ? Math.round(ts.reduce((s,x)=>s+Number(x.××—×•×–||0),0)/ts.length) : 0;
        cells.push({ muted:false, label:String(dayNum), iso, count:ts.length, urgent, avgProg });
      }
    }

    const weekdays = ['××³','×‘×³','×’×³','×“×³','×”×³','×•×³','×©×³'];

    return `
      <div class="card">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-[10px] text-slate-400 font-extrabold uppercase">×œ×•×— ×©× ×” ××©×™××•×ª</div>
            <div class="text-xl font-extrabold text-slate-900 mt-1">${escapeHtml(fmtMonth(d))}</div>
            <div class="text-xs text-slate-500 mt-1">×œ×—×¥ ×¢×œ ×™×•× ×›×“×™ ×œ×¨××•×ª ××ª ×”××©×™××•×ª ×©×œ×•</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-ghost text-sm" id="cal-prev"><i class="fas fa-chevron-right"></i></button>
            <button class="btn btn-ghost text-sm" id="cal-today"><i class="fas fa-bullseye"></i> ×”×™×•×</button>
            <button class="btn btn-ghost text-sm" id="cal-next"><i class="fas fa-chevron-left"></i></button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-7 gap-2 text-center text-xs text-slate-500 font-extrabold">
          ${weekdays.map(w=>`<div class="py-2">${w}</div>`).join('')}
        </div>

        <div class="mt-2 grid grid-cols-7 gap-2">
          ${cells.map(c=>{
            if(c.muted){
              return `<div class="calendar-day muted"></div>`;
            }
            const badge = c.count ? `
              <div class="mt-2 flex flex-wrap gap-1">
                <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-list-check"></i> ${c.count}</span>
                ${c.urgent ? `<span class="chip bg-red-100 text-red-700"><i class="fas fa-fire"></i> ${c.urgent}</span>` : ``}
                <span class="chip bg-emerald-50 text-emerald-700"><i class="fas fa-chart-line"></i> ${c.avgProg}%</span>
              </div>
            ` : `<div class="mt-3 text-[11px] text-slate-400">××™×Ÿ ××©×™××•×ª</div>`;

            return `
              <button class="calendar-day text-right" data-day="${c.iso}">
                <div class="flex items-center justify-between">
                  <div class="font-extrabold text-slate-900">${c.label}</div>
                  <div class="text-[10px] text-slate-400">${c.iso}</div>
                </div>
                ${badge}
              </button>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }

  // =========================
  // RENDER: TABS
  // =========================
  function setAddButtonText(){
    const map = {
      tasks:'×”×•×¡×£ ××©×™××”',
      ideas:'×”×•×¡×£ ×¨×¢×™×•×Ÿ',
      staff:'×”×•×¡×£ ×¢×•×‘×“',
      donors:'×”×•×¡×£ ×ª×¨×•××”',
      expenses:'×”×•×¡×£ ×—×•×‘',
      logistics:'×”×•×¡×£ ×™×¢×“',
      'books-he':'×”×•×¡×£ ×¡×¤×¨',
      'books-en':'×”×•×¡×£ ×¡×¤×¨',
      'book-detail':'×”×•×¡×£ × ×ª×•×Ÿ'
    };
    $('#add-btn-text').innerText = map[currentTab] || '×”×•×¡×£ ×—×“×©';
  }

  function setActiveNav(tab){
    $$('.nav-item').forEach(el=>el.classList.remove('active'));
    const btn = $('#btn-'+tab);
    if(btn) btn.classList.add('active');
  }

  function setBackButton(visible){
    $('#btn-back').classList.toggle('hidden', !visible);
  }

  function switchTab(tab, opts={pushHistory:true}){
    if(opts.pushHistory) historyStack.push(currentTab);
    currentTab = tab;
    if(tab !== 'book-detail') currentBookContext = null;

    setActiveNav(tab);
    setAddButtonText();

    const content = $('#tab-content');
    content.classList.remove('fade-in'); void content.offsetWidth; content.classList.add('fade-in');

    const titles = {
      tasks:'××©×™××•×ª ×•×œ×•"×– ×‘×™×¦×•×¢ (×›×•×œ×œ ×œ×•×— ×©× ×”)',
      ideas:'×¨×¢×™×•× ×•×ª ×•××™×–××™× (×™×•×ª×¨ ××•×¤×¦×™×•×ª)',
      staff:'×¢×•×‘×“×™ ×”××›×•×Ÿ ×•×¦×•×•×ª ×”× ×™×”×•×œ',
      donors:'×’×™×•×¡ ×›×¡×¤×™× ×œ×¤×™ ××™×–××™× + ×ª×•×¨××™×',
      logistics:'×”×¤×¦×” + ××—×¡×Ÿ (×›×•×œ×œ ×ª××¨×™×›×™×)',
      expenses:'×—×•×‘×•×ª ×œ×¡×¤×§×™× ×•×’×"×—×™× (××¤×•×¨×˜)',
      'books-he':'××¢×¨×š ×”×¡×¤×¨×™× - ×¢×‘×¨×™×ª (×œ×—×™×¦×” ×¢×œ ×¡×¤×¨ = ×¢××•×“ ××œ×)',
      'books-en':'International Division - English (Click a book)',
      'book-detail':'×ª×¢×•×“×ª ×–×”×•×ª ×©×œ ×¡×¤×¨'
    };
    $('#current-tab-title').innerText = titles[tab] || '××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ';
    setBackButton(tab==='book-detail');

    render();
  }

  function goBack(){
    const prev = historyStack.pop();
    if(!prev) return switchTab('tasks', {pushHistory:false});
    switchTab(prev, {pushHistory:false});
  }

  function renderTasks(container){
    const listBase = selectedTaskOwner==='ALL' ? store.tasks : store.tasks.filter(t=>t.×× ×”×œ===selectedTaskOwner);
    const urgent = listBase.filter(t=>t.×“×—×™×¤×•×ª==='×’×‘×•×”×”');
    const avg = listBase.length ? Math.round(listBase.reduce((s,t)=>s+Number(t.××—×•×–||0),0)/listBase.length) : 0;
    const totalHours = Math.round(listBase.reduce((s,t)=>s+Number(t.×©×¢×•×ª||0),0));

    const legend = store.staff.map(s=>{
      const th = managerTheme(s.×©×);
      const c = taskCountFor(s.×©×);
      return `
        <button class="px-3 py-2 rounded-2xl text-xs font-extrabold border hover:shadow-sm transition flex items-center gap-2"
          data-set-owner="${escapeHtml(s.×©×)}"
          style="border-color:${th.base}; background:${th.soft}; color:${th.text}">
          <span class="w-3 h-3 rounded-full" style="background:${th.base}"></span>
          <span>${escapeHtml(s.×©×)}</span>
          <span class="mr-1 px-2 py-0.5 rounded-full text-[10px]" style="background:#ffffffa6;border:1px solid ${th.base};color:${th.text}">
            ${c} ××©×™××•×ª
          </span>
        </button>
      `;
    }).join('');

    const filtered = listBase;

    container.innerHTML = `
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card border-b-4 border-blue-500">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×××•×¦×¢ ×‘×™×¦×•×¢</div>
          <div class="text-4xl font-extrabold mt-1">${avg}%</div>
          <div class="mt-3 w-full bg-slate-100 h-3 rounded-full overflow-hidden">
            <div class="h-full progress-bar" style="width:${avg}%; background:linear-gradient(135deg,#38bdf8,#2563eb)"></div>
          </div>
        </div>
        <div class="card border-b-4 border-red-500">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×“×—×•×¤×•×ª</div>
          <div class="text-4xl font-extrabold mt-1">${urgent.length}</div>
          <div class="text-xs text-slate-500 mt-2">×‘×“×—×™×¤×•×ª "×’×‘×•×”×”"</div>
        </div>
        <div class="card border-b-4 border-emerald-500">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×©×¢×•×ª ×©×”×•×©×§×¢×•</div>
          <div class="text-4xl font-extrabold mt-1">${totalHours}</div>
          <div class="text-xs text-slate-500 mt-2">×¡×”×´×› ×©×¢×•×ª ×‘×›×œ ×”××©×™××•×ª</div>
        </div>
      </div>

      <div class="card border-r-4 border-slate-300">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="text-slate-900 font-extrabold text-lg"><i class="fas fa-filter ml-2 text-slate-400"></i> ×¡×™× ×•×Ÿ â€œ×”××©×™××•×ª ×©×œ×™â€</div>
            <span class="text-xs text-slate-400">×‘×—×¨ ×¢×•×‘×“ ×›×“×™ ×œ×¨××•×ª ×¨×§ ××ª ×”××©×™××•×ª ×©×œ×•</span>
          </div>
          <div class="flex items-center gap-2">
            <button data-set-owner="ALL" class="btn btn-ghost text-sm">
              <i class="fas fa-layer-group"></i> ×›×œ ×”××©×™××•×ª
            </button>
            <select data-owner-select class="px-4 py-2 rounded-2xl text-sm font-extrabold border bg-white">
              <option value="ALL">×‘×—×¨ ×¢×•×‘×“â€¦</option>
              ${store.staff.map(s => `<option value="${escapeHtml(s.×©×)}" ${selectedTaskOwner===s.×©×?'selected':''}>${escapeHtml(s.×©×)}</option>`).join('')}
            </select>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">${legend}</div>
        <div class="mt-3 text-xs text-slate-500">
          ××¦×‘ × ×•×›×—×™: <span class="font-extrabold">${selectedTaskOwner==='ALL'?'×›×œ ×”×¢×•×‘×“×™×':escapeHtml(selectedTaskOwner)}</span>
        </div>
      </div>

      ${renderCalendar()}

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card border-r-8 border-red-500">
          <h4 class="font-extrabold text-red-600 mb-4 text-lg flex items-center">
            <i class="fas fa-fire ml-2"></i> ×“×—×•×£ ×œ×‘×™×¦×•×¢ ××™×“×™
            <span class="mr-auto bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-extrabold">${urgent.length}</span>
          </h4>

          ${
            urgent.length ? urgent.map(t=>{
              const th = managerTheme(t.×× ×”×œ);
              return `
                <button class="w-full text-right p-4 rounded-2xl mb-3 border transition hover:shadow"
                  data-open="task" data-id="${t.id}"
                  style="background:${th.soft}; border-color:${th.base}">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="font-extrabold" style="color:${th.text}">${escapeHtml(t.××©×™××”)}</div>
                      <div class="text-[10px] mt-1" style="color:${th.text}99">××—×¨××™: ${escapeHtml(t.×× ×”×œ)} â€¢ ×˜×•×•×—: ${escapeHtml(t.×˜×•×•×—)} â€¢ ×ª××¨×™×š: ${escapeHtml(t.×ª××¨×™×š||'')}</div>
                    </div>
                    <span class="chip" style="background:#ffffffb3;border:1px solid ${th.base};color:${th.text}">
                      ${Number(t.××—×•×–||0)}%
                    </span>
                  </div>

                  <div class="mt-3 w-full bg-white/70 h-3 rounded-full overflow-hidden">
                    <div class="h-full progress-bar" style="width:${Number(t.××—×•×–||0)}%; background:linear-gradient(135deg,${th.base},#10b981)"></div>
                  </div>

                  <div class="mt-2 text-xs font-extrabold" style="color:${th.text}">
                    ××•×¨×›×‘×•×ª: ${escapeHtml(t.××•×¨×›×‘×•×ª)} â€¢ ×©×¢×•×ª: ${Number(t.×©×¢×•×ª||0)} â€¢ ×“×“×œ×™×™×Ÿ: ${escapeHtml(t.×™×¢×“||'â€”')}
                  </div>

                  <div class="mt-2 text-xs font-extrabold" style="color:${th.text}">
                    <i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥ ×œ×¢×¨×™×›×” + ×™×•××Ÿ ×¢×“×›×•× ×™×
                  </div>
                </button>
              `;
            }).join('') : `<p class="text-slate-400 text-center py-8">××™×Ÿ ××©×™××•×ª ×“×—×•×¤×•×ª ğŸ‰</p>`
          }
        </div>

        <div class="card border-r-8 border-slate-300">
          <h4 class="font-extrabold text-slate-700 mb-4 text-lg">×›×œ×œ ×”××©×™××•×ª</h4>
          <div class="divide-y">
            ${filtered.map(t=>{
              const th = managerTheme(t.×× ×”×œ);
              const d = t.×ª××¨×™×š || '';
              return `
                <button class="w-full text-right p-4 text-sm flex flex-col gap-2 hover:bg-slate-50"
                  data-open="task" data-id="${t.id}">
                  <div class="flex items-center justify-between">
                    <span class="font-extrabold text-slate-900 flex items-center gap-2">
                      <span class="w-2.5 h-2.5 rounded-full" style="background:${th.base}"></span>
                      ${escapeHtml(t.××©×™××”)}
                    </span>
                    <span class="text-xs font-extrabold px-2 py-1 rounded-full" style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                      ${escapeHtml(t.×× ×”×œ)}
                    </span>
                  </div>

                  <div class="flex items-center gap-2 text-xs text-slate-600 flex-wrap">
                    <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-calendar-day"></i> ${escapeHtml(d||'â€”')}</span>
                    <span class="chip bg-emerald-50 text-emerald-700"><i class="fas fa-chart-line"></i> ${Number(t.××—×•×–||0)}%</span>
                    <span class="chip bg-purple-50 text-purple-700"><i class="fas fa-stopwatch"></i> ${Number(t.×©×¢×•×ª||0)}h</span>
                    <span class="chip bg-amber-50 text-amber-700"><i class="fas fa-layer-group"></i> ××•×¨×›×‘×•×ª ${escapeHtml(t.××•×¨×›×‘×•×ª)}</span>
                    ${t.×™×¢×“ ? `<span class="chip bg-red-50 text-red-700"><i class="fas fa-flag-checkered"></i> ×™×¢×“ ${escapeHtml(t.×™×¢×“)}</span>` : ``}
                  </div>
                </button>
              `;
            }).join('')}
          </div>
          <div class="pt-4 text-xs text-slate-400">* ×›×œ ××©×™××” ×œ×—×™×¦×” = ×¢×¨×™×›×” ××œ××” + ×™×•××Ÿ ×¢×“×›×•× ×™×</div>
        </div>
      </div>
    `;

    // calendar handlers
    $('#cal-prev').onclick = () => { calendarCursor = new Date(calendarCursor.getFullYear(), calendarCursor.getMonth()-1, 1); render(); };
    $('#cal-next').onclick = () => { calendarCursor = new Date(calendarCursor.getFullYear(), calendarCursor.getMonth()+1, 1); render(); };
    $('#cal-today').onclick = () => { calendarCursor = new Date(); render(); };
  }

  function renderIdeas(container){
    const total = store.ideas.length;
    const byStatus = (s)=>store.ideas.filter(x=>x.×¡×˜×˜×•×¡===s).length;

    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card border-b-4 border-amber-500 text-right">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×¨×¢×™×•× ×•×ª</div>
          <div class="text-3xl font-extrabold mt-1">${total}</div>
        </div>
        <div class="card border-b-4 border-slate-400 text-right">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×—×“×©×™×</div>
          <div class="text-3xl font-extrabold mt-1">${byStatus('×—×“×©')}</div>
        </div>
        <div class="card border-b-4 border-blue-500 text-right">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×‘×‘×“×™×§×”</div>
          <div class="text-3xl font-extrabold mt-1">${byStatus('×‘×‘×“×™×§×”')}</div>
        </div>
        <div class="card border-b-4 border-emerald-500 text-right">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">××•×©×¨</div>
          <div class="text-3xl font-extrabold mt-1">${byStatus('××•×©×¨')}</div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <h4 class="font-extrabold text-lg"><i class="fas fa-lightbulb ml-2 text-amber-500"></i> ×¨×¢×™×•× ×•×ª ×•××™×–××™×</h4>
          <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-mouse-pointer"></i> ×”×›×œ ×œ×—×™×¥</span>
        </div>

        <div class="space-y-3">
          ${
            store.ideas.map(idea=>{
              const th = managerTheme(idea.××’×™×©);
              const badge =
                idea.×¡×˜×˜×•×¡==='×—×“×©' ? 'bg-slate-100 text-slate-700' :
                idea.×¡×˜×˜×•×¡==='×‘×‘×“×™×§×”' ? 'bg-blue-100 text-blue-700' :
                idea.×¡×˜×˜×•×¡==='××•×©×¨' ? 'bg-emerald-100 text-emerald-700' :
                'bg-red-100 text-red-700';

              const prio =
                idea.×¢×“×™×¤×•×ª==='×§×¨×™×˜×™×ª' ? 'bg-red-100 text-red-700' :
                idea.×¢×“×™×¤×•×ª==='×’×‘×•×”×”' ? 'bg-amber-100 text-amber-700' :
                'bg-slate-100 text-slate-700';

              return `
                <div class="p-4 rounded-2xl border hover:shadow transition" style="border-color:${th.base}; background:${th.soft}">
                  <div class="flex items-start justify-between gap-3">
                    <button class="text-right" data-open="idea" data-id="${idea.id}">
                      <div class="text-lg font-extrabold" style="color:${th.text}">${escapeHtml(idea.×›×•×ª×¨×ª)}</div>
                      <div class="text-xs mt-1 text-slate-700">${escapeHtml(idea.×ª×™××•×¨||'')}</div>

                      <div class="mt-3 flex flex-wrap gap-2 text-xs">
                        <span class="chip ${badge}">${escapeHtml(idea.×¡×˜×˜×•×¡||'')}</span>
                        <span class="chip ${prio}"><i class="fas fa-bolt"></i> ${escapeHtml(idea.×¢×“×™×¤×•×ª||'')}</span>
                        <span class="chip bg-purple-50 text-purple-700"><i class="fas fa-tags"></i> ${escapeHtml(idea.×§×˜×’×•×¨×™×”||'')}</span>
                        <span class="chip bg-emerald-50 text-emerald-700"><i class="fas fa-arrow-up-right-dots"></i> ×”×©×¤×¢×” ${escapeHtml(idea.×”×©×¤×¢×”||'')}</span>
                        <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-dumbbell"></i> ××××¥ ${escapeHtml(idea.××××¥||'')}</span>
                      </div>

                      <div class="text-[10px] mt-3 text-slate-600">
                        ××’×™×©: <b>${escapeHtml(idea.××’×™×©||'â€”')}</b> â€¢ ×ª××¨×™×š: ${escapeHtml(idea.×ª××¨×™×š||'')}
                        ${idea.×ª×’×™×•×ª ? ` â€¢ ×ª×’×™×•×ª: ${escapeHtml(idea.×ª×’×™×•×ª)}` : ``}
                      </div>
                      ${idea.×¦×¢×“_×”×‘× ? `<div class="mt-2 text-xs text-slate-700"><b>×¦×¢×“ ×”×‘×:</b> ${escapeHtml(idea.×¦×¢×“_×”×‘×)}</div>` : ``}
                    </button>

                    <div class="flex flex-col items-end gap-2">
                      <button class="btn btn-emerald text-xs"
                        data-idea-to-task="${idea.id}">
                        <i class="fas fa-list-check"></i> ×”×¤×•×š ×œ××©×™××”
                      </button>
                    </div>
                  </div>
                </div>
              `;
            }).join('')
          }
        </div>

        <div class="pt-4 text-xs text-slate-400">* â€œ×”×¤×•×š ×œ××©×™××”â€ ×™×™×¦×•×¨ ××©×™××” ×—×“×©×” ×¢× ××•×ª×• ××’×™×© ×›××—×¨××™.</div>
      </div>
    `;
  }

  function renderStaff(container){
    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        ${store.staff.map(s=>{
          const th = managerTheme(s.×©×);
          const c = taskCountFor(s.×©×);
          return `
            <button class="card border-b-4 hover:shadow-lg transition text-right"
              data-open="staff" data-id="${s.id}"
              style="border-bottom-color:${th.base}">
              <div class="flex items-center space-x-3 space-x-reverse mb-4">
                <div class="p-3 rounded-full" style="background:${th.soft}; color:${th.text}">
                  <i class="fas fa-user-tie"></i>
                </div>
                <div>
                  <div class="font-extrabold text-lg">${escapeHtml(s.×©×)}</div>
                  <div class="text-xs text-slate-500 font-extrabold uppercase">${escapeHtml(s.×ª×¤×§×™×“)}</div>
                </div>
                <div class="mr-auto flex items-center gap-2">
                  <span class="chip" style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                    <i class="fas fa-list-check"></i> ${c} ××©×™××•×ª
                  </span>
                  <span class="chip bg-slate-100 text-slate-600"><i class="fas fa-mouse-pointer"></i> ×œ×—×¥</span>
                </div>
              </div>

              <div class="text-xs space-y-1 text-slate-600">
                <div><i class="fas fa-phone ml-2" style="color:${th.text}"></i> ${escapeHtml(s.×˜×œ×¤×•×Ÿ||'')}</div>
                <div><i class="fas fa-envelope ml-2" style="color:${th.text}"></i> ${escapeHtml(s.××™××™×™×œ||'')}</div>
              </div>

              <div class="mt-4">
                <button type="button"
                  class="w-full px-4 py-2 rounded-2xl text-sm font-extrabold transition"
                  style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}"
                  data-filter-tasks="${escapeHtml(s.×©×)}">
                  <i class="fas fa-eye ml-2"></i> ×”×¦×’ â€œ×”××©×™××•×ª ×©×œ×™â€
                </button>
              </div>
            </button>
          `;
        }).join('')}
      </div>
    `;
  }

  function renderBooks(container, lang){
    const list = store.books[lang];
    container.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-sm text-slate-500">
          <span class="chip bg-blue-50 text-blue-700"><i class="fas fa-info-circle"></i> ×œ×—×¥ ×¢×œ ×¡×¤×¨ ×œ×¤×ª×™×—×ª ×¢××•×“ ××œ×</span>
        </div>
        <div class="text-xs text-slate-400">×¡×”×´×›: ${list.length} ×¡×¤×¨×™×</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        ${list.map(b=>{
          const gap = Math.max(0, Number(b.target||0) - Number(b.raised||0));
          return `
            <button class="card border-t-4 border-blue-600 hover:shadow-xl transition text-right"
              data-open-book="${lang}|${b.id}">
              <div class="flex items-start justify-between gap-3">
                <h4 class="font-extrabold text-lg mb-1">${escapeHtml(b.name)}</h4>
                <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-arrow-left"></i> ×¢××•×“</span>
              </div>
              <div class="text-[10px] text-slate-400 mb-4 font-extrabold uppercase">××¦×‘ ×’×™×•×¡</div>

              <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden mb-3">
                <div class="h-full progress-bar" style="width:${b.progress}%; background:linear-gradient(135deg,#34d399,#10b981)"></div>
              </div>

              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-extrabold text-emerald-600">${money(b.raised)}</span>
                <span class="text-xs text-slate-400">×™×¢×“: ${money(b.target)}</span>
              </div>
              <div class="flex justify-between items-center mb-4">
                <span class="text-xs text-red-600 font-extrabold">×—×¡×¨: ${money(gap)}</span>
                <span class="text-xs text-slate-500">×¢×œ×•×ª ×¦×¤×•×™×”: ${money((b.cost?.expected)||0)}</span>
              </div>

              <div class="flex items-center justify-between text-xs text-slate-500">
                <span><i class="fas fa-users ml-1"></i> ${b.donorsCount ?? (b.donors?.length || 0)} ×ª×•×¨××™×</span>
                <span class="chip bg-purple-50 text-purple-700"><i class="fas fa-print"></i> ×”×“×¤×¡×•×ª: ${(b.printRuns||[]).length}</span>
              </div>
            </button>
          `;
        }).join('')}
      </div>
    `;
  }

  // =========================
  // FUNDRAISING (campaigns)
  // =========================
  function renderDonors(container){
    const totalGlobal = store.donors.reduce((sum,d)=>sum + parseInt(d.××ª× ×”||0),0);
    const campTotal = store.campaigns.reduce((s,c)=>s + Number(c.× ×’×‘×”||0), 0);

    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="card border-b-4 border-emerald-500">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×’×™×•×¡ ×‘××™×–××™×</div>
          <div class="text-4xl font-extrabold mt-1">${money(campTotal)}</div>
          <div class="text-xs text-slate-500 mt-2">×¡×›×•× ××ª×•×š ×”-Campaigns</div>
        </div>
        <div class="card border-b-4 border-blue-500">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×ª×¨×•××•×ª ×›×œ×œ×™×•×ª</div>
          <div class="text-4xl font-extrabold mt-1">${money(totalGlobal)}</div>
          <div class="text-xs text-slate-500 mt-2">×¨×©×™××ª ×ª×•×¨××™× ×›×œ×œ×™×ª</div>
        </div>
        <div class="card border-b-4 border-purple-500">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">××¡×³ ××™×–××™×</div>
          <div class="text-4xl font-extrabold mt-1">${store.campaigns.length}</div>
          <div class="text-xs text-slate-500 mt-2">×—×œ×•×§×” ×œ××“×•×¨×™× ×‘×ª×•×š ×”×¢××•×“</div>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between">
          <h4 class="font-extrabold text-lg"><i class="fas fa-hand-holding-heart ml-2 text-emerald-600"></i> ××™×–××™ ×’×™×•×¡ (Campaigns)</h4>
          <button class="btn btn-emerald text-sm" id="btn-add-camp">
            <i class="fas fa-plus"></i> ×”×•×¡×£ ××™×–×
          </button>
        </div>

        <div class="mt-5 space-y-4">
          ${store.campaigns.map(c=>{
            const gap = Math.max(0, Number(c.×™×¢×“||0) - Number(c.× ×’×‘×”||0));
            const pct = Number(c.×™×¢×“||0) ? Math.round((Number(c.× ×’×‘×”||0)/Number(c.×™×¢×“||0))*100) : 0;
            return `
              <div class="p-5 rounded-2xl border bg-white">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-xl font-extrabold text-slate-900">${escapeHtml(c.×©×)}</div>
                    <div class="text-xs text-slate-500 mt-1">${escapeHtml(c.×ª×™××•×¨||'')}</div>
                    <div class="mt-3 flex flex-wrap gap-2 text-xs">
                      <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-user"></i> ××™×© ×§×©×¨: ${escapeHtml(c.××™×©_×§×©×¨||'â€”')}</span>
                      ${c.×˜×œ×¤×•×Ÿ ? `<span class="chip bg-slate-100 text-slate-700"><i class="fas fa-phone"></i> ${escapeHtml(c.×˜×œ×¤×•×Ÿ)}</span>` : ``}
                      ${c.××™××™×™×œ ? `<span class="chip bg-slate-100 text-slate-700"><i class="fas fa-envelope"></i> ${escapeHtml(c.××™××™×™×œ)}</span>` : ``}
                    </div>
                  </div>
                  <button class="btn btn-ghost text-sm" data-edit-camp="${c.id}">
                    <i class="fas fa-pen"></i> ×¢×¨×•×š
                  </button>
                </div>

                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="p-4 rounded-2xl bg-slate-50 border">
                    <div class="text-[10px] text-slate-400 font-extrabold uppercase">×™×¢×“</div>
                    <div class="text-2xl font-extrabold mt-1">${money(c.×™×¢×“)}</div>
                  </div>
                  <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-100">
                    <div class="text-[10px] text-emerald-700 font-extrabold uppercase">× ×’×‘×”</div>
                    <div class="text-2xl font-extrabold mt-1 text-emerald-700">${money(c.× ×’×‘×”)}</div>
                  </div>
                  <div class="p-4 rounded-2xl bg-red-50 border border-red-100">
                    <div class="text-[10px] text-red-700 font-extrabold uppercase">×—×¡×¨</div>
                    <div class="text-2xl font-extrabold mt-1 text-red-700">${money(gap)}</div>
                  </div>
                </div>

                <div class="mt-4 w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                  <div class="h-full progress-bar" style="width:${pct}%; background:linear-gradient(135deg,#34d399,#10b981)"></div>
                </div>
                <div class="mt-2 text-xs text-slate-500">×”×ª×§×“××•×ª: <b>${pct}%</b></div>

                <div class="mt-5 grid grid-cols-1 lg:grid-cols-2 gap-5">
                  <div class="p-4 rounded-2xl bg-slate-50 border">
                    <div class="flex items-center justify-between">
                      <div class="font-extrabold text-slate-800"><i class="fas fa-users ml-2"></i> ×ª×•×¨××™× ×‘××™×–×</div>
                      <button class="btn btn-emerald text-xs" data-add-camp-donor="${c.id}">
                        <i class="fas fa-plus"></i> ×”×•×¡×£
                      </button>
                    </div>
                    <div class="mt-3 space-y-2">
                      ${(c.×ª×•×¨××™×||[]).length ? (c.×ª×•×¨××™×||[]).map((d,idx)=>`
                        <div class="p-3 rounded-xl bg-white border flex items-start justify-between">
                          <div>
                            <div class="font-extrabold text-slate-900">${escapeHtml(d.name||'')}</div>
                            <div class="text-xs text-slate-500">${escapeHtml(d.date||'')} â€¢ ${escapeHtml(d.note||'')}</div>
                          </div>
                          <div class="text-right">
                            <div class="font-extrabold text-emerald-700">${money(d.amount||0)}</div>
                            <button class="text-red-600 text-xs font-extrabold hover:underline mt-1" data-del-camp-donor="${c.id}|${idx}">
                              ××—×§
                            </button>
                          </div>
                        </div>
                      `).join('') : `<div class="text-sm text-slate-400 text-center py-4">××™×Ÿ ×ª×•×¨××™× ×‘××™×–× ×¢×“×™×™×Ÿ.</div>`}
                    </div>
                  </div>

                  <div class="p-4 rounded-2xl bg-slate-50 border">
                    <div class="flex items-center justify-between">
                      <div class="font-extrabold text-slate-800"><i class="fas fa-list-check ml-2"></i> ××©×™××•×ª ×‘××™×–×</div>
                      <button class="btn btn-purple text-xs" data-add-camp-task="${c.id}">
                        <i class="fas fa-plus"></i> ×”×•×¡×£
                      </button>
                    </div>
                    <div class="mt-3 space-y-2">
                      ${(c.××©×™××•×ª||[]).length ? (c.××©×™××•×ª||[]).map((t,idx)=>`
                        <div class="p-3 rounded-xl bg-white border flex items-start justify-between">
                          <div>
                            <div class="font-extrabold text-slate-900">${escapeHtml(t.title||'')}</div>
                            <div class="text-xs text-slate-500">××—×¨××™: <b>${escapeHtml(t.owner||'')}</b> â€¢ ×™×¢×“: ${escapeHtml(t.due||'â€”')} â€¢ ×¡×˜×˜×•×¡: ${escapeHtml(t.status||'×¤×ª×•×—')}</div>
                          </div>
                          <button class="text-red-600 text-xs font-extrabold hover:underline" data-del-camp-task="${c.id}|${idx}">××—×§</button>
                        </div>
                      `).join('') : `<div class="text-sm text-slate-400 text-center py-4">××™×Ÿ ××©×™××•×ª ×‘××™×–× ×¢×“×™×™×Ÿ.</div>`}
                    </div>
                  </div>
                </div>

              </div>
            `;
          }).join('')}
        </div>
      </div>

      <div class="card mt-6">
        <h4 class="font-extrabold mb-4 text-lg">×ª×•×¨××™× ×›×œ×œ×™×™× (×œ×—×™×¥ ×œ×¢×¨×™×›×”)</h4>
        <table class="w-full text-right text-sm">
          <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
            <tr><th class="p-3">×©× ×ª×•×¨×</th><th class="p-3">×¤×¨×•×™×§×˜</th><th class="p-3">×ª××¨×™×š</th><th class="p-3">×¡×›×•×</th></tr>
          </thead>
          <tbody>
            ${store.donors.map(d=>`
              <tr class="border-b hover:bg-slate-50 cursor-pointer" data-open="donor" data-id="${d.id}">
                <td class="p-3 font-extrabold text-slate-900">${escapeHtml(d.×©×)}</td>
                <td class="p-3 text-slate-600 text-xs">${escapeHtml(d.×¤×¨×•×™×§×˜)}</td>
                <td class="p-3 text-slate-400 text-xs">${escapeHtml(d.×ª××¨×™×š)}</td>
                <td class="p-3 font-extrabold text-emerald-600">${money(parseInt(d.××ª× ×”||0))}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div class="pt-3 text-xs text-slate-400">* ×›×œ ×©×•×¨×” ×œ×—×™×¦×” = ×¢×¨×™×›×” ××”×™×¨×”</div>
      </div>
    `;

    $('#btn-add-camp').onclick = () => {
      store.campaigns.unshift({
        id: 'camp-'+uid(),
        ×©×: '××™×–× ×—×“×©',
        ××™×©_×§×©×¨: '',
        ×˜×œ×¤×•×Ÿ: '',
        ××™××™×™×œ: '',
        ×™×¢×“: 0,
        × ×’×‘×”: 0,
        ×ª×™××•×¨: '',
        ×ª×•×¨××™×: [],
        ××©×™××•×ª: []
      });
      saveStore();
      render();
      notify('××™×–× × ×•×¡×£ âœ…');
    };
  }

  function renderExpenses(container){
    const total = store.expenses.reduce((sum,e)=>sum + Number(e.×™×ª×¨×”||0),0);
    const totalAll = store.expenses.reduce((sum,e)=>sum + Number(e.×¡×›×•×||0),0);
    const paidAll = store.expenses.reduce((sum,e)=>sum + Number(e.×©×•×œ×||0),0);

    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="card border-b-4 border-red-500">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×™×ª×¨×•×ª ×œ×ª×©×œ×•×</div>
          <div class="text-4xl font-extrabold mt-1 text-red-600">${money(total)}</div>
          <div class="text-xs text-slate-500 mt-2">×›××” ×—×•×‘×•×ª × ×©××¨×•</div>
        </div>
        <div class="card border-b-4 border-slate-700">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×—×•×‘×•×ª ×”×™×¡×˜×•×¨×™×™×</div>
          <div class="text-4xl font-extrabold mt-1">${money(totalAll)}</div>
          <div class="text-xs text-slate-500 mt-2">×›×•×œ×œ ××” ×©×›×‘×¨ ×©×•×œ×</div>
        </div>
        <div class="card border-b-4 border-emerald-500">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×¡×”×´×› ×©×•×œ×</div>
          <div class="text-4xl font-extrabold mt-1 text-emerald-700">${money(paidAll)}</div>
          <div class="text-xs text-slate-500 mt-2">×ª×©×œ×•××™× ×©×‘×•×¦×¢×•</div>
        </div>
      </div>

      <div class="card">
        <h4 class="font-extrabold mb-4 text-lg">×—×•×‘×•×ª ×œ×¡×¤×§×™× ×•×’××´×—×™× (×œ×—×™×¥ ×œ×¢×¨×™×›×”)</h4>
        <div class="overflow-x-auto">
          <table class="w-full text-right text-sm">
            <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
              <tr>
                <th class="p-3">×¡×•×’</th>
                <th class="p-3">×¡×¤×§/×’×"×—</th>
                <th class="p-3">×ª×™××•×¨</th>
                <th class="p-3">×ª××¨×™×š</th>
                <th class="p-3">×“×“×œ×™×™×Ÿ</th>
                <th class="p-3">×¡×›×•×</th>
                <th class="p-3">×©×•×œ×</th>
                <th class="p-3">×™×ª×¨×”</th>
                <th class="p-3">×¡×˜×˜×•×¡</th>
              </tr>
            </thead>
            <tbody>
              ${store.expenses.map(e=>`
                <tr class="border-b hover:bg-slate-50 cursor-pointer" data-open="expense" data-id="${e.id}">
                  <td class="p-3"><span class="chip ${e.×¡×•×’==='×’×"×—'?'bg-purple-50 text-purple-700':'bg-blue-50 text-blue-700'}">${escapeHtml(e.×¡×•×’||'')}</span></td>
                  <td class="p-3 font-extrabold text-slate-900">${escapeHtml(e.×¡×¤×§||'')}</td>
                  <td class="p-3 text-xs text-slate-600">${escapeHtml(e.×ª×™××•×¨||'')}</td>
                  <td class="p-3 text-xs text-slate-500">${escapeHtml(e.×ª××¨×™×š||'')}</td>
                  <td class="p-3 text-xs text-slate-500">${escapeHtml(e.×™×¢×“||'')}</td>
                  <td class="p-3 font-extrabold">${money(Number(e.×¡×›×•×||0))}</td>
                  <td class="p-3 font-extrabold text-emerald-700">${money(Number(e.×©×•×œ×||0))}</td>
                  <td class="p-3 font-extrabold text-red-700">${money(Number(e.×™×ª×¨×”||0))}</td>
                  <td class="p-3"><span class="chip bg-slate-100 text-slate-700">${escapeHtml(e.×¡×˜×˜×•×¡||'')}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="pt-3 text-xs text-slate-400">* ×›×œ ×©×•×¨×” ×œ×—×™×¦×” = ×¢×¨×™×›×” ××œ××”</div>
      </div>
    `;
  }

  function renderLogistics(container){
    const israel = store.logistics.israel;
    const international = store.logistics.international;
    const wh = store.logistics.warehouse || [];

    const totalIsrael = israel.reduce((s,x)=>s+Number(x.books||0),0);
    const totalIntl = international.reduce((s,x)=>s+Number(x.books||0),0);
    const lastWh = wh[0];

    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="card border-b-4 border-slate-800">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">××—×¡×Ÿ</div>
          <div class="text-4xl font-extrabold mt-1">${Number(lastWh?.totalBooks||0).toLocaleString()}</div>
          <div class="text-xs text-slate-500 mt-2">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: <b>${escapeHtml(lastWh?.date||'â€”')}</b> â€¢ ×¤×’×•××™×: <b>${Number(lastWh?.damaged||0)}</b></div>
        </div>

        <div class="card border-b-4 border-blue-600">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×”×¤×¦×” ×‘××¨×¥</div>
          <div class="text-4xl font-extrabold mt-1">${Number(totalIsrael).toLocaleString()}</div>
          <div class="text-xs text-slate-500 mt-2">×¡×”×´×› ×¡×¤×¨×™× ×‘×›×œ ×”×¢×¨×™×</div>
        </div>

        <div class="card border-b-4 border-emerald-600">
          <div class="text-[10px] text-slate-400 font-extrabold uppercase">×”×¤×¦×” ×‘×—×•×´×œ</div>
          <div class="text-4xl font-extrabold mt-1">${Number(totalIntl).toLocaleString()}</div>
          <div class="text-xs text-slate-500 mt-2">×¡×”×´×› ×¡×¤×¨×™× ×‘×›×œ ×”××“×™× ×•×ª</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card lg:col-span-1 border-r-4 border-slate-800">
          <div class="flex items-center justify-between">
            <h4 class="font-extrabold text-lg"><i class="fas fa-warehouse ml-2 text-slate-700"></i> ××—×¡×Ÿ</h4>
            <button class="btn btn-ghost text-sm" id="btn-add-wh">
              <i class="fas fa-plus"></i> ×¢×“×›×•×Ÿ ×¡×¤×™×¨×”
            </button>
          </div>

          <div class="mt-4 space-y-2">
            ${wh.length ? wh.map((x,idx)=>`
              <div class="p-4 rounded-2xl bg-slate-50 border">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-slate-500 font-extrabold">${escapeHtml(x.date||'')}</div>
                  <button class="text-red-600 text-xs font-extrabold hover:underline" data-delwh="${idx}">××—×§</button>
                </div>
                <div class="mt-2 flex justify-between text-sm">
                  <span class="text-slate-600">×¡×”×´×› ×¡×¤×¨×™×</span>
                  <span class="font-extrabold">${Number(x.totalBooks||0).toLocaleString()}</span>
                </div>
                <div class="mt-1 flex justify-between text-sm">
                  <span class="text-slate-600">×¤×’×•××™×</span>
                  <span class="font-extrabold text-red-700">${Number(x.damaged||0).toLocaleString()}</span>
                </div>
                ${x.note ? `<div class="mt-2 text-xs text-slate-600">${escapeHtml(x.note)}</div>` : ``}
              </div>
            `).join('') : `<div class="text-sm text-slate-400 text-center py-8">××™×Ÿ ×¢×“×›×•× ×™ ××—×¡×Ÿ ×¢×“×™×™×Ÿ.</div>`}
          </div>

          <div class="pt-3 text-xs text-slate-400">* ××•××œ×¥ ×œ×”×•×¡×™×£ ×¢×“×›×•×Ÿ ×¡×¤×™×¨×” ×¤×¢× ×‘×©×‘×•×¢/×—×•×“×©.</div>
        </div>

        <div class="card lg:col-span-1 border-r-4 border-blue-600">
          <div class="flex items-center justify-between">
            <h4 class="font-extrabold text-lg"><i class="fas fa-map-marker-alt ml-2 text-blue-600"></i> ×”×¤×¦×” ×‘××¨×¥</h4>
            <button class="btn btn-primary text-sm" id="btn-add-il">
              <i class="fas fa-plus"></i> ×”×•×¡×£ ×¢×™×¨
            </button>
          </div>

          <div class="mt-4 space-y-2">
            ${israel.length ? israel.map(x=>`
              <div class="p-4 rounded-2xl bg-white border hover:shadow-sm transition cursor-pointer"
                   data-open="logistics_israel" data-id="${x.id}">
                <div class="flex items-center justify-between">
                  <div class="font-extrabold text-slate-900">${escapeHtml(x.city)}</div>
                  <span class="chip ${x.status==='×¤×¢×™×œ'?'bg-emerald-50 text-emerald-700':'bg-slate-100 text-slate-700'}">
                    ${escapeHtml(x.status||'')}
                  </span>
                </div>
                <div class="mt-2 text-xs text-slate-600 flex justify-between">
                  <span><i class="fas fa-book ml-1"></i> ${Number(x.books||0).toLocaleString()} ×¡×¤×¨×™×</span>
                  <span class="text-slate-400">${escapeHtml(x.date||'')}</span>
                </div>
                ${x.note ? `<div class="mt-2 text-xs text-slate-500">${escapeHtml(x.note)}</div>` : ``}
              </div>
            `).join('') : `<div class="text-sm text-slate-400 text-center py-8">××™×Ÿ × ×ª×•× ×™ ×”×¤×¦×” ×‘××¨×¥ ×¢×“×™×™×Ÿ.</div>`}
          </div>
        </div>

        <div class="card lg:col-span-1 border-r-4 border-emerald-600">
          <div class="flex items-center justify-between">
            <h4 class="font-extrabold text-lg"><i class="fas fa-plane-departure ml-2 text-emerald-600"></i> ×”×¤×¦×” ×‘×—×•×´×œ</h4>
            <button class="btn btn-emerald text-sm" id="btn-add-intl">
              <i class="fas fa-plus"></i> ×”×•×¡×£ ××“×™× ×”
            </button>
          </div>

          <div class="mt-4 space-y-2">
            ${international.length ? international.map(x=>`
              <div class="p-4 rounded-2xl bg-white border hover:shadow-sm transition cursor-pointer"
                   data-open="logistics_intl" data-id="${x.id}">
                <div class="flex items-center justify-between">
                  <div class="font-extrabold text-slate-900">${escapeHtml(x.country)}</div>
                  <span class="chip ${
                    x.status==='×¤×¢×™×œ' ? 'bg-emerald-50 text-emerald-700' :
                    x.status==='×‘×©×œ×™×—×”' ? 'bg-amber-50 text-amber-700' :
                    'bg-slate-100 text-slate-700'
                  }">${escapeHtml(x.status||'')}</span>
                </div>
                <div class="mt-2 text-xs text-slate-600 flex justify-between">
                  <span><i class="fas fa-book ml-1"></i> ${Number(x.books||0).toLocaleString()} ×¡×¤×¨×™×</span>
                  <span class="text-slate-400">${escapeHtml(x.date||'')}</span>
                </div>
                ${x.note ? `<div class="mt-2 text-xs text-slate-500">${escapeHtml(x.note)}</div>` : ``}
              </div>
            `).join('') : `<div class="text-sm text-slate-400 text-center py-8">××™×Ÿ × ×ª×•× ×™ ×”×¤×¦×” ×‘×—×•×´×œ ×¢×“×™×™×Ÿ.</div>`}
          </div>
        </div>
      </div>
    `;

    // warehouse add
    $('#btn-add-wh').onclick = () => {
      modal.show('×¢×“×›×•×Ÿ ×¡×¤×™×¨×ª ××—×¡×Ÿ', `
        <div class="grid grid-cols-1 gap-4">
          ${formField({k:'wh_date',label:'×ª××¨×™×š',type:'date',req:true}, todayISO())}
          ${formField({k:'wh_total',label:'×¡×”×´×› ×¡×¤×¨×™× ×‘××—×¡×Ÿ',type:'number',req:true}, 0)}
          ${formField({k:'wh_damaged',label:'×¤×’×•××™×',type:'number',req:true}, 0)}
          ${formField({k:'wh_note',label:'×”×¢×¨×”',type:'textarea',rows:3}, '')}
        </div>
      `, () => {
        const date = $('#f_wh_date').value;
        const totalBooks = Number($('#f_wh_total').value||0);
        const damaged = Number($('#f_wh_damaged').value||0);
        const note = $('#f_wh_note').value || '';
        if(!date) return alert('× × ×œ××œ× ×ª××¨×™×š');
        store.logistics.warehouse.unshift({ id: uid(), date, note, totalBooks, damaged });
        saveStore();
        modal.hide();
        render();
        notify('×¢×•×“×›×Ÿ ××—×¡×Ÿ âœ…');
      }, '×©××•×¨');
    };

    // add israel / intl
    $('#btn-add-il').onclick = () => addEntity('logistics_israel');
    $('#btn-add-intl').onclick = () => addEntity('logistics_intl');

    // delete warehouse row
    container.onclick = (e) => {
      const dw = e.target.closest('[data-delwh]')?.dataset?.delwh;
      if(dw !== undefined){
        if(!confirm('×œ××—×•×§ ×¢×“×›×•×Ÿ ××—×¡×Ÿ?')) return;
        store.logistics.warehouse.splice(Number(dw),1);
        saveStore();
        render();
        notify('× ××—×§');
      }
    };
  }

  // =========================
  // ADD ENTITY
  // =========================
  function addEntity(schemaKey){
    const schema = SCHEMAS[schemaKey];
    if(!schema) return;

    // create blank entity with defaults
    const blank = { id: uid() };
    for(const f of schema.fields){
      if(f.k in blank) continue;
      if(f.type==='date') blank[f.k] = todayISO();
      else if(f.type==='number') blank[f.k] = 0;
      else if(f.type==='select'){
        const opts = f.options?.() || [];
        blank[f.k] = opts[0] ?? '';
      } else blank[f.k] = '';
    }

    const body = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${schema.fields.map(f => formField(f, blank[f.k] ?? '')).join('')}
      </div>
    `;

    modal.show(`×”×•×¡×¤×”: ${schemaKey}`, body, () => {
      // validate
      for(const f of schema.fields){
        const v = $(`#f_${f.k}`).value;
        if(f.req && !String(v).trim()) return alert('× × ×œ××œ× ×©×“×•×ª ×—×•×‘×”');
      }
      // collect
      for(const f of schema.fields){
        let v = $(`#f_${f.k}`).value;
        if(f.type==='number') v = parseInt(v||0);
        blank[f.k] = v;
      }

      // special for expense
      if(schemaKey==='expense'){
        blank.×¡×›×•× = Number(blank.×¡×›×•×||0);
        blank.×©×•×œ× = Number(blank.×©×•×œ×||0);
        blank.×™×ª×¨×” = Math.max(0, Number(blank.×™×ª×¨×”||0) || (blank.×¡×›×•× - blank.×©×•×œ×));
      }

      schema.list().unshift(blank);
      saveStore();
      modal.hide();
      render();
      notify('× ×•×¡×£ âœ…');
    }, '×”×•×¡×£');
  }

  // =========================
  // CAMPAIGN EDIT (inline modal)
  // =========================
  function openEditCampaign(id){
    const c = store.campaigns.find(x=>x.id===id);
    if(!c) return;

    modal.show(`×¢×¨×™×›×ª ××™×–×: ${c.×©×}`, `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${formField({k:'c_name',label:'×©× ××™×–×',type:'text',req:true}, c.×©×)}
        ${formField({k:'c_contact',label:'××™×© ×§×©×¨',type:'text'}, c.××™×©_×§×©×¨)}
        ${formField({k:'c_phone',label:'×˜×œ×¤×•×Ÿ',type:'text'}, c.×˜×œ×¤×•×Ÿ)}
        ${formField({k:'c_mail',label:'××™××™×™×œ',type:'email'}, c.××™××™×™×œ)}
        ${formField({k:'c_target',label:'×™×¢×“',type:'number',req:true}, c.×™×¢×“)}
        ${formField({k:'c_raised',label:'× ×’×‘×”',type:'number',req:true}, c.× ×’×‘×”)}
        <div class="md:col-span-2">
          ${formField({k:'c_desc',label:'×ª×™××•×¨',type:'textarea',rows:4}, c.×ª×™××•×¨)}
        </div>
      </div>
    `, () => {
      const name = $('#f_c_name').value.trim();
      if(!name) return alert('× × ×œ××œ× ×©× ××™×–×');
      c.×©× = name;
      c.××™×©_×§×©×¨ = $('#f_c_contact').value;
      c.×˜×œ×¤×•×Ÿ = $('#f_c_phone').value;
      c.××™××™×™×œ = $('#f_c_mail').value;
      c.×™×¢×“ = Number($('#f_c_target').value||0);
      c.× ×’×‘×” = Number($('#f_c_raised').value||0);
      c.×ª×™××•×¨ = $('#f_c_desc').value;
      saveStore();
      modal.hide();
      render();
      notify('××™×–× ×¢×•×“×›×Ÿ âœ…');
    }, '×©××•×¨');
  }

  function addCampaignDonor(campId){
    const c = store.campaigns.find(x=>x.id===campId);
    if(!c) return;
    modal.show('×”×•×¡×£ ×ª×•×¨× ×œ××™×–×', `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${formField({k:'cd_name',label:'×©×',type:'text',req:true}, '')}
        ${formField({k:'cd_amount',label:'×¡×›×•×',type:'number',req:true}, 0)}
        ${formField({k:'cd_date',label:'×ª××¨×™×š',type:'date',req:true}, todayISO())}
        <div class="md:col-span-2">${formField({k:'cd_note',label:'×”×¢×¨×”',type:'textarea',rows:3}, '')}</div>
      </div>
    `, () => {
      const name = $('#f_cd_name').value.trim();
      const amount = Number($('#f_cd_amount').value||0);
      const date = $('#f_cd_date').value;
      const note = $('#f_cd_note').value || '';
      if(!name || !date) return alert('× × ×œ××œ× ×©×“×•×ª ×—×•×‘×”');
      c.×ª×•×¨××™×.unshift({ id: uid(), name, amount, date, note });
      c.× ×’×‘×” = Number(c.× ×’×‘×”||0) + amount;
      saveStore();
      modal.hide();
      render();
      notify('×ª×•×¨× × ×•×¡×£ âœ…');
    }, '×”×•×¡×£');
  }

  function addCampaignTask(campId){
    const c = store.campaigns.find(x=>x.id===campId);
    if(!c) return;
    modal.show('×”×•×¡×£ ××©×™××” ×œ××™×–×', `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${formField({k:'ct_title',label:'×›×•×ª×¨×ª ××©×™××”',type:'text',req:true}, '')}
        ${formField({k:'ct_owner',label:'××—×¨××™',type:'select',req:true, options: ()=>store.staff.map(s=>s.×©×)}, store.staff[0]?.×©×||'')}
        ${formField({k:'ct_due',label:'×™×¢×“',type:'date'}, '')}
        ${formField({k:'ct_status',label:'×¡×˜×˜×•×¡',type:'select', options: ()=>['×¤×ª×•×—','×‘×ª×”×œ×™×š','×”×•×©×œ×']}, '×¤×ª×•×—')}
      </div>
      <div class="text-xs text-slate-400 mt-2">* ××¤×©×¨ ×’× ×œ×”×¤×•×š ×¨×¢×™×•×Ÿ ×œ××©×™××” ×‘×¢××•×“ ×”×¨×¢×™×•× ×•×ª.</div>
    `, () => {
      const title = $('#f_ct_title').value.trim();
      const owner = $('#f_ct_owner').value;
      const due = $('#f_ct_due').value;
      const status = $('#f_ct_status').value;
      if(!title) return alert('× × ×œ××œ× ×›×•×ª×¨×ª');
      c.××©×™××•×ª.unshift({ id: uid(), title, owner, due, status });
      saveStore();
      modal.hide();
      render();
      notify('××©×™××” × ×•×¡×¤×” âœ…');
    }, '×”×•×¡×£');
  }

  // =========================
  // RENDER ROUTER
  // =========================
  function render(){
    const container = $('#tab-content');
    container.innerHTML = '';

    // update button texts
    setAddButtonText();

    if(currentTab === 'tasks') return renderTasks(container);
    if(currentTab === 'ideas') return renderIdeas(container);
    if(currentTab === 'staff') return renderStaff(container);
    if(currentTab === 'donors') return renderDonors(container);
    if(currentTab === 'expenses') return renderExpenses(container);
    if(currentTab === 'logistics') return renderLogistics(container);

    if(currentTab === 'books-he') return renderBooks(container, 'he');
    if(currentTab === 'books-en') return renderBooks(container, 'en');

    if(currentTab === 'book-detail' && currentBookContext){
      return renderBookDetail(container, currentBookContext.lang, currentBookContext.id);
    }
  }

  // =========================
  // GLOBAL CLICK HANDLERS
  // =========================
  function bindGlobalHandlers(){
    // nav clicks
    $$('.nav-item').forEach(el=>{
      el.onclick = () => switchTab(el.dataset.tab);
    });

    // back
    $('#btn-back').onclick = goBack;

    // refresh
    $('#btn-refresh').onclick = () => {
      const ic = $('#refresh-icon');
      ic.classList.add('fa-spin');
      setTimeout(()=>ic.classList.remove('fa-spin'), 400);
      render();
      notify('×¨×¢× ×•×Ÿ âœ…');
    };

    // reset local storage
    $('#btn-reset').onclick = () => {
      if(!confirm('×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×©××•×¨×™× ×‘×“×¤×“×¤×Ÿ?')) return;
      localStorage.removeItem(STORAGE_KEY);
      store = migrateStore(null);
      saveStore();
      historyStack = [];
      currentTab = 'tasks';
      selectedTaskOwner = 'ALL';
      currentBookContext = null;
      render();
      notify('× ××—×§ ×•×”×•×—×–×¨ ×œ×‘×¨×™×¨×ª ××—×“×œ âœ…');
    };

    // add button (contextual)
    $('#btn-add').onclick = () => {
      if(currentTab === 'tasks') return addEntity('task');
      if(currentTab === 'ideas') return addEntity('idea');
      if(currentTab === 'staff') return addEntity('staff');
      if(currentTab === 'donors') return addEntity('donor');
      if(currentTab === 'expenses') return addEntity('expense');
      if(currentTab === 'logistics') return addEntity('logistics_israel');
      if(currentTab === 'books-he'){
        store.books.he.unshift({
          id: 'he-'+uid(),
          name:'×¡×¤×¨ ×—×“×©',
          progress:0, target:0, raised:0, donorsCount:0,
          cost:{ expected:0, actual:0 },
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×›×¨×™×›×” ×§×©×”", notes:"" },
          printRuns:[],
          donors:[]
        });
        saveStore(); render(); notify('×¡×¤×¨ × ×•×¡×£ âœ…');
        return;
      }
      if(currentTab === 'books-en'){
        store.books.en.unshift({
          id: 'en-'+uid(),
          name:'New Book',
          progress:0, target:0, raised:0, donorsCount:0,
          cost:{ expected:0, actual:0 },
          identity:{ subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Hardcover", notes:"" },
          printRuns:[],
          donors:[]
        });
        saveStore(); render(); notify('Book added âœ…');
        return;
      }
    };

    // edit data shortcut: opens "what makes sense" per tab
    $('#btn-edit-data').onclick = () => {
      if(currentTab === 'tasks'){
        // quick: choose first task or open filter help
        modal.show('×¢×¨×™×›×ª × ×ª×•× ×™×', `
          <div class="text-sm text-slate-600">
            ×˜×™×¤: ×›×“×™ ×œ×¢×¨×•×š ××©×™××”â€”×¤×©×•×˜ ×œ×—×¥ ×¢×œ ×”××©×™××” ×‘×¨×©×™××” / ×‘×œ×•×— ×©× ×”.
          </div>
          <div class="mt-4">
            <button class="btn btn-primary" id="go-first-task"><i class="fas fa-pen"></i> ×¢×¨×•×š ××©×™××” ×¨××©×•× ×”</button>
          </div>
        `, null, '×¡×’×•×¨', false);
        $('#go-first-task').onclick = () => {
          modal.hide();
          if(store.tasks[0]) openEditEntity('task', store.tasks[0].id);
        };
        return;
      }
      if(currentTab === 'ideas'){
        if(store.ideas[0]) return openEditEntity('idea', store.ideas[0].id);
        return notify('××™×Ÿ ×¨×¢×™×•× ×•×ª ×œ×¢×¨×™×›×”');
      }
      if(currentTab === 'staff'){
        if(store.staff[0]) return openEditEntity('staff', store.staff[0].id);
        return notify('××™×Ÿ ×¢×•×‘×“×™× ×œ×¢×¨×™×›×”');
      }
      if(currentTab === 'donors'){
        modal.show('×¢×¨×™×›×ª × ×ª×•× ×™× - ×’×™×•×¡', `
          <div class="text-sm text-slate-600">
            ××¤×©×¨ ×œ×¢×¨×•×š ××™×–× (Campaign) ×“×¨×š ×›×¤×ª×•×¨ "×¢×¨×•×š", ×•×ª×•×¨××™× ×›×œ×œ×™×™× ×‘×œ×—×™×¦×” ×¢×œ ×©×•×¨×” ×‘×˜×‘×œ×”.
          </div>
        `, null, '×¡×’×•×¨', false);
        return;
      }
      if(currentTab === 'expenses'){
        if(store.expenses[0]) return openEditEntity('expense', store.expenses[0].id);
        return notify('××™×Ÿ ×—×•×‘×•×ª ×œ×¢×¨×™×›×”');
      }
      if(currentTab === 'logistics'){
        modal.show('×¢×¨×™×›×ª × ×ª×•× ×™× - ×œ×•×’×™×¡×˜×™×§×”', `
          <div class="text-sm text-slate-600">
            ×œ×—×¥ ×¢×œ ×¢×™×¨/××“×™× ×” ×›×“×™ ×œ×¢×¨×•×š. ×œ××—×¡×Ÿâ€”×”×•×¡×£ "×¢×“×›×•×Ÿ ×¡×¤×™×¨×”".
          </div>
        `, null, '×¡×’×•×¨', false);
        return;
      }
      if(currentTab === 'books-he' || currentTab === 'books-en'){
        modal.show('×¢×¨×™×›×ª × ×ª×•× ×™× - ×¡×¤×¨×™×', `
          <div class="text-sm text-slate-600">
            ×œ×—×¥ ×¢×œ ×¡×¤×¨ ×›×“×™ ×œ×¤×ª×•×— ×¢××•×“ ××œ× ×œ×¢×¨×™×›×” (×ª×¢×•×“×ª ×–×”×•×ª, ×”×“×¤×¡×•×ª, ×ª×•×¨××™×).
          </div>
        `, null, '×¡×’×•×¨', false);
        return;
      }
    };

    // delegate clicks in main content
    $('#tab-content').onclick = (e) => {
      // open entity editor
      const open = e.target.closest('[data-open]'); 
      if(open){
        const schemaKey = open.dataset.open;
        const id = open.dataset.id;
        if(schemaKey && id) return openEditEntity(schemaKey, id);
      }

      // open book detail
      const ob = e.target.closest('[data-open-book]')?.dataset?.openBook;
      if(ob){
        const [lang,id] = ob.split('|');
        currentBookContext = {lang, id};
        switchTab('book-detail');
        return;
      }

      // filter tasks by staff from staff cards
      const ft = e.target.closest('[data-filter-tasks]')?.dataset?.filterTasks;
      if(ft){
        selectedTaskOwner = ft;
        saveStore();
        switchTab('tasks');
        return;
      }

      // tasks calendar day
      const day = e.target.closest('[data-day]')?.dataset?.day;
      if(day){
        return openDayTasks(day);
      }

      // in day modal: open task
      const ot = e.target.closest('[data-open="task"]');
      if(ot){
        const id = ot.dataset.id;
        modal.hide();
        openEditEntity('task', id);
        return;
      }

      // select owner chips
      const so = e.target.closest('[data-set-owner]')?.dataset?.setOwner;
      if(so !== undefined){
        selectedTaskOwner = so;
        saveStore();
        render();
        notify('×¡×•× ×Ÿ âœ…');
        return;
      }

      // idea -> task quick button
      const itt = e.target.closest('[data-idea-to-task]')?.dataset?.ideaToTask;
      if(itt){
        const idea = store.ideas.find(x=>x.id===itt);
        if(!idea) return;
        store.tasks.unshift({
          id: uid(),
          ××©×™××”: idea.×›×•×ª×¨×ª,
          ×× ×”×œ: idea.××’×™×© || (store.staff[0]?.×©× || ''),
          ×“×—×™×¤×•×ª: idea.×¢×“×™×¤×•×ª==='×§×¨×™×˜×™×ª' ? '×’×‘×•×”×”' : '×¨×’×™×œ×”',
          ×˜×•×•×—: '××¨×•×š',
          ×ª××¨×™×š: todayISO(),
          ×™×¢×“: "",
          ××—×•×–: 0,
          ×©×¢×•×ª: 0,
          ××•×¨×›×‘×•×ª: Number(idea.××××¥||3),
          ×˜×™×¤×•×œ: idea.×¦×¢×“_×”×‘× ? `×¦×¢×“ ×”×‘×: ${idea.×¦×¢×“_×”×‘×}` : "",
          ×¢×“×›×•× ×™×:[]
        });
        idea.×¡×˜×˜×•×¡ = '××•×©×¨';
        saveStore();
        switchTab('tasks');
        notify('×”×•××¨ ×œ××©×™××” ğŸ¯');
        return;
      }

      // campaigns edit / add donor / add task / delete donor / delete task
      const ec = e.target.closest('[data-edit-camp]')?.dataset?.editCamp;
      if(ec) return openEditCampaign(ec);

      const acd = e.target.closest('[data-add-camp-donor]')?.dataset?.addCampDonor;
      if(acd) return addCampaignDonor(acd);

      const act = e.target.closest('[data-add-camp-task]')?.dataset?.addCampTask;
      if(act) return addCampaignTask(act);

      const dcd = e.target.closest('[data-del-camp-donor]')?.dataset?.delCampDonor;
      if(dcd){
        const [campId, idxStr] = dcd.split('|');
        const c = store.campaigns.find(x=>x.id===campId);
        if(!c) return;
        const idx = Number(idxStr);
        if(!confirm('×œ××—×•×§ ×ª×•×¨× ××”××™×–×?')) return;
        const removed = c.×ª×•×¨××™×.splice(idx,1)[0];
        c.× ×’×‘×” = Math.max(0, Number(c.× ×’×‘×”||0) - Number(removed?.amount||0));
        saveStore();
        render();
        notify('× ××—×§');
        return;
      }

      const dct = e.target.closest('[data-del-camp-task]')?.dataset?.delCampTask;
      if(dct){
        const [campId, idxStr] = dct.split('|');
        const c = store.campaigns.find(x=>x.id===campId);
        if(!c) return;
        const idx = Number(idxStr);
        if(!confirm('×œ××—×•×§ ××©×™××” ××”××™×–×?')) return;
        c.××©×™××•×ª.splice(idx,1);
        saveStore();
        render();
        notify('× ××—×§');
        return;
      }
    };

    // owner select change (tasks)
    $('#tab-content').onchange = (e) => {
      const sel = e.target.closest('[data-owner-select]');
      if(sel){
        selectedTaskOwner = sel.value || 'ALL';
        saveStore();
        render();
        notify('×¡×•× ×Ÿ âœ…');
      }
    };
  }

  // expose setBookField to inline oninput
  window.setBookField = setBookField;

  // =========================
  // INIT
  // =========================
  bindGlobalHandlers();
  render();

})();
</script>

</body>
</html>



