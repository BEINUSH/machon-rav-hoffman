<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>××¢×¨×›×ª × ×™×”×•×œ - ××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap');
    body { font-family: 'Assistant', sans-serif; background-color:#f8fafc; color:#1e293b; }
    .sidebar-link{transition:all .2s;border-radius:.5rem;margin-bottom:.25rem;display:flex;align-items:center;padding:.75rem 1rem;cursor:pointer}
    .sidebar-link:hover{background-color:#334155;color:#fff}
    .sidebar-link.active{background-color:#3b82f6;color:#fff}
    .card{background:#fff;border-radius:1rem;box-shadow:0 4px 6px -1px rgb(0 0 0 / .1);padding:1.5rem}
    .fade-in{animation:fadeIn .4s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .progress-bar{transition:width .6s ease-out}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .55rem;border-radius:999px;font-size:.75rem;font-weight:700}
  </style>
</head>

<body class="flex h-screen overflow-hidden">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-slate-800 text-slate-300 flex flex-col shadow-2xl z-20 overflow-y-auto shrink-0">
    <div class="p-6 border-b border-slate-700">
      <h1 class="text-white text-xl font-bold tracking-tight">××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ</h1>
      <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest">× ×™×”×•×œ ×•×”×•×¦××” ×œ××•×¨</p>
    </div>

    <nav class="flex-1 p-4 space-y-1 text-sm">
      <div class="text-[10px] font-bold text-slate-500 px-4 mb-2 uppercase">× ×™×”×•×œ ×©×•×˜×£</div>
      <div onclick="switchTab('tasks')" class="nav-item sidebar-link active" id="btn-tasks">
        <i class="fas fa-list-ul ml-3"></i> ××©×™××•×ª ×•×œ×•"×–
      </div>
      <div onclick="switchTab('staff')" class="nav-item sidebar-link" id="btn-staff">
        <i class="fas fa-users-cog ml-3"></i> ×¢×•×‘×“×™ ×”××›×•×Ÿ
      </div>

      <div class="text-[10px] font-bold text-slate-500 px-4 mt-6 mb-2 uppercase">××¢×¨×š ×”×¡×¤×¨×™×</div>
      <div onclick="switchTab('books-he')" class="nav-item sidebar-link" id="btn-books-he">
        <i class="fas fa-book ml-3"></i> ×¡×¤×¨×™× - ×¢×‘×¨×™×ª
      </div>
      <div onclick="switchTab('books-en')" class="nav-item sidebar-link" id="btn-books-en">
        <i class="fas fa-language ml-3"></i> ××“×•×¨ ×× ×’×œ×™×ª
      </div>

      <div class="text-[10px] font-bold text-slate-500 px-4 mt-6 mb-2 uppercase">×›×¡×¤×™× ×•×œ×•×’×™×¡×˜×™×§×”</div>
      <div onclick="switchTab('donors')" class="nav-item sidebar-link" id="btn-donors">
        <i class="fas fa-hand-holding-heart ml-3"></i> ×’×™×•×¡ ×›×¡×¤×™×
      </div>
      <div onclick="switchTab('logistics')" class="nav-item sidebar-link" id="btn-logistics">
        <i class="fas fa-shipping-fast ml-3"></i> ×”×¤×¦×” ×•×—×•"×œ
      </div>
      <div onclick="switchTab('expenses')" class="nav-item sidebar-link" id="btn-expenses">
        <i class="fas fa-file-invoice-dollar ml-3"></i> ×—×•×‘×•×ª ×œ×¡×¤×§×™×
      </div>
    </nav>

    <div class="p-4 bg-slate-900 border-t border-slate-700 space-y-3">
      <div>
        <p class="text-[10px] text-slate-500 mb-1 font-bold">×‘×¢×œ×•×ª ×”×¢××•×ª×”:</p>
        <p class="text-xs font-bold text-white">×××™×¨ ×©××—×” ×©×˜×™×™×Ÿ</p>
      </div>

      <!-- âœ… ×ª×•×¡×¤×ª: ×›×¤×ª×•×¨ × ×™×§×•×™ × ×ª×•× ×™× (×œ× ××•×—×§ ×§×•×“, ×¨×§ LocalStorage) -->
      <button onclick="resetLocalData()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-200 px-3 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center">
        <i class="fas fa-eraser ml-2"></i> × ×™×§×•×™ × ×ª×•× ×™× ×©××•×¨×™×
      </button>
      <p class="text-[10px] text-slate-500 leading-snug">* ×× ×©××¨×ª × ×ª×•× ×™× ×‘×“×¤×“×¤×Ÿ ×•×–×” ×”×ª×‘×œ×’×Ÿ â€“ ×œ×—×¥ ×›××Ÿ.</p>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 flex flex-col min-w-0">
    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm">
      <div class="flex items-center gap-3">
        <button id="btn-back" onclick="goBackFromDetail()" class="hidden bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-sm font-bold transition">
          <i class="fas fa-arrow-right ml-2"></i> ×—×–×¨×”
        </button>
        <h2 id="current-tab-title" class="text-lg font-bold text-slate-800">××©×™××•×ª ×•×œ×•"×– ×‘×™×¦×•×¢</h2>
      </div>

      <div class="flex space-x-3 space-x-reverse">
        <button onclick="showAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transform active:scale-95 transition flex items-center">
          <i class="fas fa-plus ml-2"></i>
          <span id="add-btn-text">×”×•×¡×£ ×—×“×©</span>
        </button>

        <button onclick="showEditDataModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md transform active:scale-95 transition">
          <i class="fas fa-edit ml-2"></i> ×¢×¨×•×š × ×ª×•× ×™×
        </button>

        <button onclick="refreshData()" class="bg-slate-100 p-2 rounded-lg text-slate-500 hover:bg-slate-200 transition">
          <i class="fas fa-sync-alt" id="refresh-icon"></i>
        </button>
      </div>
    </header>

    <div id="main-area" class="p-8 overflow-y-auto h-full bg-slate-50">
      <div id="tab-content" class="space-y-6"></div>
    </div>
  </main>

  <!-- MODAL -->
  <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[90vh] flex flex-col">
      <div class="p-6 border-b bg-slate-50 flex items-center justify-between">
        <h3 id="modal-title" class="text-xl font-bold text-slate-800">×”×•×¡×¤×” ×œ××¢×¨×›×ª</h3>
        <button onclick="hideModal()" class="text-slate-400 hover:text-slate-700 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6 space-y-4 overflow-y-auto flex-1" id="modal-body"></div>
      <div class="p-6 bg-white border-t flex justify-end space-x-3 space-x-reverse">
        <button onclick="hideModal()" class="px-6 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg transition">×‘×™×˜×•×œ</button>
        <button onclick="processSubmit()" id="btn-submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-lg hover:bg-blue-700 transition">
          <i class="fas fa-check ml-2"></i> ×©××•×¨ ×‘××¢×¨×›×ª
        </button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // âœ… PERSISTENCE (LocalStorage)
    // =========================
    const STORAGE_KEY = 'hoffman_admin_store_v1';

    function saveStore(){
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); } catch(e){}
    }
    function loadStore(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      } catch(e){ return null; }
    }
    function resetLocalData(){
      if(confirm('×œ××—×•×§ × ×ª×•× ×™× ×©××•×¨×™× ×‘×“×¤×“×¤×Ÿ ×•×œ×—×–×•×¨ ×œ×‘×¨×™×¨×ª ××—×“×œ?')){
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    // =========================
    // DATA STORE (×”×•×¨×—×‘)
    // =========================
    const uid = () => Math.random().toString(36).slice(2, 10);

    let store = {
      tasks: [
        { ××©×™××”: "×”×›× ×ª ×—×©×‘×•× ×•×ª ×œ×ª×•×¨××™× ×—×•×“×© ×–×”", ×× ×”×œ: "××©×” ×›×”×Ÿ", ×“×—×™×¤×•×ª: "×’×‘×•×”×”", ×˜×•×•×—: "×—×•×“×©×™" },
        { ××©×™××”: "×©×œ×™×—×ª ×¢×“×›×•×Ÿ ×œ×× ×•×™×™ ×”× ×™×•×–×œ×˜×¨", ×× ×”×œ: "×™×•×¡×™ ×œ×•×™", ×“×—×™×¤×•×ª: "×’×‘×•×”×”", ×˜×•×•×—: "×—×•×“×©×™" },
        { ××©×™××”: "×‘×™×§×•×¨ ××¦×œ ××•×´×œ ×‘× ×™ ×‘×¨×§", ×× ×”×œ: "×“×•×“ ×’×•×œ×“", ×“×—×™×¤×•×ª: "×’×‘×•×”×”", ×˜×•×•×—: "×—×•×“×©×™" },
        { ××©×™××”: "×ª×™××•× ×¤×’×™×©×ª ×ª×›× ×•×Ÿ ×©× ×” ×”×‘××”", ×× ×”×œ: "××©×” ×›×”×Ÿ", ×“×—×™×¤×•×ª: "×¨×’×™×œ×”", ×˜×•×•×—: "××¨×•×š" },
        { ××©×™××”: "×¢×“×›×•×Ÿ ××ª×¨ ×”××™× ×˜×¨× ×˜", ×× ×”×œ: "×™×•×¡×™ ×œ×•×™", ×“×—×™×¤×•×ª: "×¨×’×™×œ×”", ×˜×•×•×—: "××¨×•×š" }
      ],

      staff: [
        { ×©×: "××©×” ×›×”×Ÿ", ×ª×¤×§×™×“: "×× ×”×œ ×›×œ×œ×™", ×˜×œ×¤×•×Ÿ: "050-1234567", ××™××™×™×œ: "moshe@hoffman.org" },
        { ×©×: "×™×•×¡×™ ×œ×•×™", ×ª×¤×§×™×“: "×× ×”×œ ×©×™×•×•×§", ×˜×œ×¤×•×Ÿ: "052-7654321", ××™××™×™×œ: "yossi@hoffman.org" },
        { ×©×: "×“×•×“ ×’×•×œ×“", ×ª×¤×§×™×“: "×œ×•×’×™×¡×˜×™×§×”", ×˜×œ×¤×•×Ÿ: "054-9876543", ××™××™×™×œ: "david@hoffman.org" },
        { ×©×: "×©×¨×” ×’×¨×™×Ÿ", ×ª×¤×§×™×“: "×¢×•×¨×›×ª ×¨××©×™×ª", ×˜×œ×¤×•×Ÿ: "050-5555555", ××™××™×™×œ: "sara@hoffman.org" }
      ],

      books: {
        he: [
          {
            id: "he-mechunach",
            name: "×”××—×•× ×š",
            progress: 90, target: 25000, raised: 22500, donorsCount: 15,
            identity: { subtitle: "××”×“×•×¨×” ××ª×•×§× ×ª ×•××•×¨×—×‘×ª", author: "", editor: "", series: "", isbn: "", pages: 0, trim: "17Ã—24", binding: "×›×¨×™×›×” ×§×©×”", notes: "" },
            printRuns: [
              { year: 2018, qty: 4000, printer: "", notes: "×”×“×¤×¡×” ×¨××©×•× ×”" },
              { year: 2020, qty: 7000, printer: "", notes: "" }
            ],
            donors: [{ id: uid(), name: "××‘×¨×”× ×›×”×Ÿ", amount: 5000, date: "2025-02-01", note: "×ª××™×›×” ×›×œ×œ×™×ª" }]
          },
          { id: "he-yesodot", name: "×™×¡×•×“×•×ª ×”×—×™× ×•×š", progress: 65, target: 50000, raised: 32500, donorsCount: 12,
            identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
            printRuns: [{ year: 2021, qty: 4000, printer:"", notes:"" }],
            donors: []
          },
          { id: "he-modaot", name: "××•×“×¢×•×ª", progress: 82, target: 40000, raised: 32800, donorsCount: 18,
            identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
            printRuns: [{ year: 2022, qty: 5000, printer:"", notes:"" }],
            donors: []
          },
          { id: "he-shidduchim", name: "×©×™×“×•×›×™×", progress: 45, target: 35000, raised: 15750, donorsCount: 8,
            identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
            printRuns: [],
            donors: []
          },
          { id: "he-al-hapachad", name: "×¢×œ ×”×¤×—×“", progress: 28, target: 30000, raised: 8400, donorsCount: 5,
            identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
            printRuns: [],
            donors: []
          },
          { id: "he-kmayim", name: "×›××™×", progress: 55, target: 45000, raised: 24750, donorsCount: 11,
            identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"17Ã—24", binding:"×¨×›×”", notes:"" },
            printRuns: [],
            donors: []
          }
        ],
        en: [
          { id: "en-awareness", name: "Awareness (××•×“×¢×•×ª)", progress: 70, target: 60000, raised: 42000, donorsCount: 22,
            identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Hardcover", notes:"" },
            printRuns: [],
            donors: []
          },
          { id: "en-shidduchim", name: "Shidduchim (×©×™×“×•×›×™×)", progress: 40, target: 50000, raised: 20000, donorsCount: 10,
            identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Paperback", notes:"" },
            printRuns: [],
            donors: []
          },
          { id: "en-foundations", name: "Foundations of Education", progress: 55, target: 55000, raised: 30250, donorsCount: 14,
            identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Paperback", notes:"" },
            printRuns: [],
            donors: []
          },
          { id: "en-like-water", name: "Like Water (×›××™×)", progress: 35, target: 40000, raised: 14000, donorsCount: 7,
            identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim:"6Ã—9", binding:"Paperback", notes:"" },
            printRuns: [],
            donors: []
          }
        ]
      },

      donors: [
        { ×©×: "××‘×¨×”× ×›×”×Ÿ", ×¤×¨×•×™×§×˜: "×™×¡×•×“×•×ª ×”×—×™× ×•×š", ××ª× ×”: "5000", ×ª××¨×™×š: "2025-02-01" },
        { ×©×: "×©×¨×” ×œ×•×™", ×¤×¨×•×™×§×˜: "×©×™×“×•×›×™×", ××ª× ×”: "3500", ×ª××¨×™×š: "2025-02-05" },
        { ×©×: "×™×¢×§×‘ ×’×¨×™× ×‘×¨×’", ×¤×¨×•×™×§×˜: "××•×“×¢×•×ª", ××ª× ×”: "7200", ×ª××¨×™×š: "2025-01-10" },
        { ×©×: "×¨×—×œ ×©×•×•×¨×¥", ×¤×¨×•×™×§×˜: "×›××™×", ××ª× ×”: "2800", ×ª××¨×™×š: "2025-02-05" }
      ],

      expenses: [
        { ×¡×¤×§: "×“×¤×•×¡ ××¨×›×–", ×¡×›×•×: "12500", ×¡×˜×˜×•×¡: "×××ª×™×Ÿ" },
        { ×¡×¤×§: "××©×¨×“ - ×©×›×™×¨×•×ª ×—×•×“×©×™×ª", ×¡×›×•×: "1000", ×¡×˜×˜×•×¡: "×××ª×™×Ÿ" },
        { ×¡×¤×§: "×’××´×— ×”×¡×¤×¨×™×", ×¡×›×•×: "8300", ×¡×˜×˜×•×¡: "×××ª×™×Ÿ" },
        { ×¡×¤×§: "×©×œ×™×—×•×™×•×ª ×‘×™× ×´×œ", ×¡×›×•×: "4200", ×¡×˜×˜×•×¡: "×××ª×™×Ÿ" }
      ],

      logistics: {
        israel: [
          { city: "×™×¨×•×©×œ×™×", books: 350, status: "×¤×¢×™×œ" },
          { city: "×‘× ×™ ×‘×¨×§", books: 280, status: "×¤×¢×™×œ" },
          { city: "×¦×¤×ª", books: 120, status: "×¤×¢×™×œ" },
          { city: "×‘××¨ ×©×‘×¢", books: 95, status: "×‘×”××ª× ×”" }
        ],
        international: [
          { country: "××¨×”×´×‘", books: 500, status: "×‘×©×œ×™×—×”" },
          { country: "×× ×’×œ×™×”", books: 180, status: "×¤×¢×™×œ" },
          { country: "×¦×¨×¤×ª", books: 95, status: "×¤×¢×™×œ" },
          { country: "××•×¡×˜×¨×œ×™×”", books: 65, status: "×‘×ª×›× ×•×Ÿ" }
        ]
      }
    };

    // âœ… ×× ×™×© × ×ª×•× ×™× ×©××•×¨×™× â€“ × ×˜×¢×Ÿ ××•×ª× (×‘×œ×™ ×œ×©×‘×•×¨ ×›×œ×•×)
    const loaded = loadStore();
    if(loaded && typeof loaded === 'object'){
      store = loaded;
    }

    // =========================
    // STATE
    // =========================
    let currentActiveTab = 'tasks';
    let currentModalMode = 'add'; // 'add' or 'edit' or 'view'
    let currentBookContext = null; // { lang:'he'|'en', id:'...' }
    let historyStack = [];         // × ×™×•×•×˜ ×¤× ×™××™ (×—×–×¨×”)

    // âœ… ×ª×•×¡×¤×ª: ×¡×™× ×•×Ÿ â€œ×”××©×™××•×ª ×©×œ×™â€
    let selectedTaskOwner = 'ALL'; // 'ALL' | staffName

    // =========================
    // HELPERS
    // =========================
    const money = n => `â‚ª${Number(n || 0).toLocaleString()}`;
    const todayISO = () => new Date().toISOString().split('T')[0];

    function findBook(lang, id){
      return store.books[lang].find(b => b.id === id);
    }

    function setBackButton(visible){
      const btn = document.getElementById('btn-back');
      btn.classList.toggle('hidden', !visible);
    }

    function setAddButtonText(){
      const el = document.getElementById('add-btn-text');
      const map = {
        'tasks': '×”×•×¡×£ ××©×™××”',
        'staff': '×”×•×¡×£ ×¢×•×‘×“',
        'donors': '×”×•×¡×£ ×ª×¨×•××”',
        'expenses': '×”×•×¡×£ ×”×•×¦××”',
        'logistics': '×”×•×¡×£ ×™×¢×“',
        'books-he': '×”×•×¡×£ ×¡×¤×¨',
        'books-en': '×”×•×¡×£ ×¡×¤×¨',
        'book-detail': '×”×•×¡×£ × ×ª×•×Ÿ'
      };
      el.innerText = map[currentActiveTab] || '×”×•×¡×£ ×—×“×©';
    }

    function refreshData() {
      const icon = document.getElementById('refresh-icon');
      icon.classList.add('animate-spin');
      setTimeout(() => {
        icon.classList.remove('animate-spin');
        if(currentActiveTab === 'book-detail' && currentBookContext){
          renderBookDetail(document.getElementById('tab-content'), currentBookContext.lang, currentBookContext.id);
        } else {
          switchTab(currentActiveTab, { pushHistory:false });
        }
        showNotification('×”× ×ª×•× ×™× ×¨×•×¢× × ×• ×‘×”×¦×œ×—×”');
      }, 600);
    }

    // =========================
    // âœ… COLOR BY MANAGER (×”×¢×•×‘×“ ×¨×•××” ××” ×©×œ×•)
    // =========================
    const PALETTE = [
      { base:'#2563eb', soft:'#eff6ff', text:'#1d4ed8' }, // blue
      { base:'#16a34a', soft:'#ecfdf5', text:'#15803d' }, // green
      { base:'#7c3aed', soft:'#f5f3ff', text:'#6d28d9' }, // purple
      { base:'#f59e0b', soft:'#fffbeb', text:'#b45309' }, // amber
      { base:'#ef4444', soft:'#fef2f2', text:'#b91c1c' }, // red
      { base:'#0ea5e9', soft:'#f0f9ff', text:'#0284c7' }, // sky
      { base:'#14b8a6', soft:'#f0fdfa', text:'#0f766e' }, // teal
      { base:'#64748b', soft:'#f1f5f9', text:'#334155' }, // slate
    ];

    function managerIndex(name){
      const idx = store.staff.findIndex(s => s.×©× === name);
      if(idx >= 0) return idx % PALETTE.length;
      // ×× ×”××©×™××” ×¢×œ ×©× ×©×œ× ×§×™×™× ×‘×¦×•×•×ª â€“ ×¢×“×™×™×Ÿ ×œ×ª×ª ×¦×‘×¢ ×¢×§×‘×™
      let hash = 0;
      for(const ch of String(name||'')) hash = (hash*31 + ch.charCodeAt(0)) >>> 0;
      return hash % PALETTE.length;
    }
    function managerTheme(name){
      return PALETTE[managerIndex(name)];
    }
    function taskCountFor(name){
      return store.tasks.filter(t => t.×× ×”×œ === name).length;
    }

    // =========================
    // NAVIGATION
    // =========================
    function switchTab(tabId, opts = { pushHistory:true }) {
      if(tabId !== 'book-detail') currentBookContext = null;

      if(opts.pushHistory){
        historyStack.push(currentActiveTab);
      }

      currentActiveTab = tabId;
      setAddButtonText();

      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const btn = document.getElementById('btn-' + tabId);
      if(btn) btn.classList.add('active');

      const content = document.getElementById('tab-content');
      const title = document.getElementById('current-tab-title');

      content.classList.remove('fade-in');
      void content.offsetWidth;
      content.classList.add('fade-in');

      const titles = {
        'tasks': '××©×™××•×ª ×•×œ×•"×– ×‘×™×¦×•×¢',
        'staff': '×¢×•×‘×“×™ ×”××›×•×Ÿ ×•×¦×•×•×ª ×”× ×™×”×•×œ',
        'books-he': '××¢×¨×š ×”×¡×¤×¨×™× - ×¢×‘×¨×™×ª (×œ×—×™×¦×” ×¢×œ ×¡×¤×¨ = ×¢××•×“ ××œ×)',
        'books-en': 'International Division - English (Click a book)',
        'donors': '×’×™×•×¡ ×›×¡×¤×™× ×•×ª×•×¨××™× ××§×˜×•××œ×™×™×',
        'logistics': '×”×¤×¦×” ×‘××¨×¥ ×•×‘×—×•×´×œ',
        'expenses': '×—×•×‘×•×ª ×œ×¡×¤×§×™× ×•×¢×œ×•×™×•×ª ×©×•×˜×¤×•×ª',
        'book-detail': '×ª×¢×•×“×ª ×–×”×•×ª ×©×œ ×¡×¤×¨'
      };
      title.innerText = titles[tabId] || '××›×•×Ÿ ×¨×‘ ×”×•×¤××Ÿ';

      setBackButton(tabId === 'book-detail');

      if(tabId === 'tasks') renderTasks(content);
      else if(tabId === 'staff') renderStaff(content);
      else if(tabId === 'donors') renderDonors(content);
      else if(tabId === 'expenses') renderExpenses(content);
      else if(tabId === 'logistics') renderLogistics(content);
      else if(tabId === 'books-he') renderBooks(content, 'he');
      else if(tabId === 'books-en') renderBooks(content, 'en');
      else if(tabId === 'book-detail' && currentBookContext) {
        renderBookDetail(content, currentBookContext.lang, currentBookContext.id);
      }
    }

    function openBookDetail(lang, bookId){
      currentBookContext = { lang, id: bookId };
      switchTab('book-detail');
    }

    function goBackFromDetail(){
      const prev = historyStack.pop();
      if(!prev) return switchTab('tasks', { pushHistory:false });
      switchTab(prev, { pushHistory:false });
    }

    // =========================
    // RENDER FUNCTIONS
    // =========================
    function renderTasks(el) {
      const highAll = store.tasks.filter(t => t.×“×—×™×¤×•×ª === '×’×‘×•×”×”');
      const allManagers = [...new Set(store.tasks.map(t => t.×× ×”×œ).filter(Boolean))];

      const filtered = selectedTaskOwner === 'ALL'
        ? store.tasks
        : store.tasks.filter(t => t.×× ×”×œ === selectedTaskOwner);

      const high = selectedTaskOwner === 'ALL'
        ? highAll
        : filtered.filter(t => t.×“×—×™×¤×•×ª === '×’×‘×•×”×”');

      // âœ… ××§×¨× ×¦×‘×¢×™× ×œ×¢×•×‘×“×™×
      const legend = store.staff.map(s => {
        const th = managerTheme(s.×©×);
        const c = taskCountFor(s.×©×);
        return `
          <button onclick="setTasksOwner('${escapeHtml(s.×©×)}')" class="px-3 py-2 rounded-xl text-xs font-bold border hover:shadow-sm transition flex items-center gap-2"
            style="border-color:${th.base}; background:${th.soft}; color:${th.text}">
            <span class="w-3 h-3 rounded-full" style="background:${th.base}"></span>
            <span>${escapeHtml(s.×©×)}</span>
            <span class="mr-1 px-2 py-0.5 rounded-full text-[10px]" style="background:#ffffffa6;border:1px solid ${th.base};color:${th.text}">
              ${c} ××©×™××•×ª
            </span>
          </button>
        `;
      }).join('');

      el.innerHTML = `
        <div class="card border-r-4 border-slate-300">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="flex items-center gap-3">
              <div class="text-slate-800 font-bold text-lg"><i class="fas fa-filter ml-2 text-slate-400"></i> ×¡×™× ×•×Ÿ â€œ×”××©×™××•×ª ×©×œ×™â€</div>
              <span class="text-xs text-slate-400">×‘×—×¨ ×¢×•×‘×“ ×›×“×™ ×œ×¨××•×ª ×¨×§ ××ª ×”××©×™××•×ª ×©×œ×•</span>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="setTasksOwner('ALL')" class="px-4 py-2 rounded-xl text-sm font-bold border bg-white hover:bg-slate-50 transition">
                <i class="fas fa-layer-group ml-2"></i> ×›×œ ×”××©×™××•×ª
              </button>
              <select onchange="setTasksOwner(this.value)" class="px-4 py-2 rounded-xl text-sm font-bold border bg-white">
                <option value="ALL">×‘×—×¨ ×¢×•×‘×“â€¦</option>
                ${store.staff.map(s => `<option value="${escapeHtml(s.×©×)}" ${selectedTaskOwner===s.×©×?'selected':''}>${escapeHtml(s.×©×)}</option>`).join('')}
              </select>
            </div>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            ${legend}
          </div>

          <div class="mt-3 text-xs text-slate-500">
            ××¦×‘ × ×•×›×—×™: <span class="font-bold">${selectedTaskOwner === 'ALL' ? '×›×œ ×”×¢×•×‘×“×™×' : escapeHtml(selectedTaskOwner)}</span>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card border-r-8 border-red-500">
            <h4 class="font-bold text-red-600 mb-4 text-lg flex items-center">
              <i class="fas fa-fire ml-2"></i> ×“×—×•×£ ×œ×‘×™×¦×•×¢ ××™×“×™
              <span class="mr-auto bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs">${high.length}</span>
            </h4>
            ${
              high.length
              ? high.map(t => {
                  const th = managerTheme(t.×× ×”×œ);
                  const idx = store.tasks.indexOf(t);
                  return `
                    <button onclick="openEntity('task','${idx}')" class="w-full text-right p-4 rounded-xl mb-3 border transition"
                      style="background:${th.soft}; border-color:${th.base}">
                      <div class="font-bold" style="color:${th.text}">${escapeHtml(t.××©×™××”)}</div>
                      <div class="text-[10px] mt-1" style="color:${th.text}99">××—×¨××™: ${escapeHtml(t.×× ×”×œ)} â€¢ ×˜×•×•×—: ${escapeHtml(t.×˜×•×•×—)}</div>
                      <div class="mt-2 text-xs font-bold" style="color:${th.text}">
                        <i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥ ×œ×¤×ª×™×—×ª ×›×¨×˜×™×¡
                      </div>
                    </button>
                  `;
                }).join('')
              : '<p class="text-slate-400 text-center py-8">××™×Ÿ ××©×™××•×ª ×“×—×•×¤×•×ª ğŸ‰</p>'
            }
          </div>

          <div class="card border-r-8 border-slate-300">
            <h4 class="font-bold text-slate-600 mb-4 text-lg">×›×œ×œ ×”××©×™××•×ª</h4>
            <div class="divide-y">
              ${filtered.map((t) => {
                const idx = store.tasks.indexOf(t);
                const th = managerTheme(t.×× ×”×œ);
                return `
                  <button onclick="openEntity('task','${idx}')" class="w-full text-right p-3 text-sm flex justify-between items-center hover:bg-slate-50">
                    <span class="font-bold text-slate-800 flex items-center gap-2">
                      <span class="w-2.5 h-2.5 rounded-full" style="background:${th.base}"></span>
                      ${escapeHtml(t.××©×™××”)}
                    </span>
                    <span class="text-xs font-bold px-2 py-1 rounded-full" style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                      ${escapeHtml(t.×× ×”×œ)}
                    </span>
                  </button>
                `;
              }).join('')}
            </div>
            <div class="pt-4 text-xs text-slate-400">* ×›×œ ××©×™××” × ×™×ª× ×ª ×œ×œ×—×™×¦×” (×›×¨×˜×™×¡ ××”×™×¨ ×‘××•×“×œ)</div>
          </div>
        </div>
      `;
    }

    function setTasksOwner(val){
      selectedTaskOwner = val || 'ALL';
      renderTasks(document.getElementById('tab-content'));
    }

    function renderStaff(el) {
      el.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          ${store.staff.map((s, idx) => {
            const th = managerTheme(s.×©×);
            const c = taskCountFor(s.×©×);
            return `
              <button onclick="openEntity('staff','${idx}')" class="card border-b-4 hover:shadow-lg transition text-right"
                style="border-bottom-color:${th.base}">
                <div class="flex items-center space-x-3 space-x-reverse mb-4">
                  <div class="p-3 rounded-full" style="background:${th.soft}; color:${th.text}">
                    <i class="fas fa-user-tie"></i>
                  </div>
                  <div>
                    <div class="font-bold text-lg">${escapeHtml(s.×©×)}</div>
                    <div class="text-xs text-slate-400 font-bold uppercase">${escapeHtml(s.×ª×¤×§×™×“)}</div>
                  </div>

                  <!-- âœ… ×ª×•×¡×¤×ª: ×›××” ××©×™××•×ª ×™×© ×œ×¢×•×‘×“ + ××•×ª×• ×¦×‘×¢ -->
                  <div class="mr-auto flex items-center gap-2">
                    <span class="chip" style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                      <i class="fas fa-list-check"></i> ${c} ××©×™××•×ª
                    </span>
                    <span class="chip bg-slate-100 text-slate-600"><i class="fas fa-mouse-pointer"></i> ×œ×—×¥</span>
                  </div>
                </div>

                <div class="text-xs space-y-1 text-slate-600">
                  <div><i class="fas fa-phone ml-2" style="color:${th.text}"></i> ${escapeHtml(s.×˜×œ×¤×•×Ÿ)}</div>
                  <div><i class="fas fa-envelope ml-2" style="color:${th.text}"></i> ${escapeHtml(s.××™××™×™×œ)}</div>
                </div>

                <div class="mt-4">
                  <button type="button" onclick="event.stopPropagation(); selectedTaskOwner='${escapeHtml(s.×©×)}'; switchTab('tasks', {pushHistory:true});"
                    class="w-full px-4 py-2 rounded-xl text-sm font-bold transition"
                    style="background:${th.soft}; color:${th.text}; border:1px solid ${th.base}">
                    <i class="fas fa-eye ml-2"></i> ×”×¦×’ â€œ×”××©×™××•×ª ×©×œ×™â€
                  </button>
                </div>
              </button>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderBooks(el, lang) {
      const list = store.books[lang];
      el.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-500">
            <span class="chip bg-blue-50 text-blue-700"><i class="fas fa-info-circle"></i> ×œ×—×¥ ×¢×œ ×¡×¤×¨ ×œ×¤×ª×™×—×ª ×¢××•×“ ××œ×</span>
          </div>
          <div class="text-xs text-slate-400">×¡×”×´×›: ${list.length} ×¡×¤×¨×™×</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          ${list.map(b => `
            <button onclick="openBookDetail('${lang}','${b.id}')" class="card border-t-4 border-blue-600 hover:shadow-xl transition text-right">
              <div class="flex items-start justify-between gap-3">
                <h4 class="font-bold text-lg mb-1">${escapeHtml(b.name)}</h4>
                <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-arrow-left"></i> ×¢××•×“</span>
              </div>
              <div class="text-[10px] text-slate-400 mb-4 font-bold uppercase">××¦×‘ ×’×™×•×¡ ×›×¡×¤×™×</div>

              <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden mb-3">
                <div class="bg-gradient-to-l from-emerald-400 to-emerald-600 h-full progress-bar" style="width:${b.progress}%"></div>
              </div>

              <div class="flex justify-between items-center mb-4">
                <span class="text-sm font-bold text-emerald-600">${money(b.raised)}</span>
                <span class="text-xs text-slate-400">×™×¢×“: ${money(b.target)}</span>
              </div>

              <div class="flex items-center justify-between text-xs text-slate-500">
                <span><i class="fas fa-users ml-1"></i> ${b.donorsCount ?? (b.donors?.length || 0)} ×ª×•×¨××™×</span>
                <span class="chip bg-purple-50 text-purple-700"><i class="fas fa-print"></i> ×”×“×¤×¡×•×ª: ${(b.printRuns || []).length}</span>
              </div>
            </button>
          `).join('')}
        </div>
      `;
    }

    // âœ… ×¢××•×“ ××œ× ×œ×›×œ ×¡×¤×¨: ×ª×¢×•×“×ª ×–×”×•×ª + ×”×“×¤×¡×•×ª + ×ª×•×¨××™× ×©×œ ×”×¡×¤×¨
    function renderBookDetail(el, lang, bookId){
      const b = findBook(lang, bookId);
      if(!b){
        el.innerHTML = `<div class="card">×œ× × ××¦× ×¡×¤×¨</div>`;
        return;
      }

      document.getElementById('current-tab-title').innerText = `×¡×¤×¨: ${b.name}`;

      const identity = b.identity || (b.identity = {});
      const pr = b.printRuns || (b.printRuns = []);
      const bd = b.donors || (b.donors = []);

      const sumPrint = pr.reduce((s, r) => s + (Number(r.qty)||0), 0);
      const sumDon = bd.reduce((s, d) => s + (Number(d.amount)||0), 0);

      el.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="card lg:col-span-1 border-r-4 border-blue-600">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-slate-400 font-bold uppercase">×ª×¢×•×“×ª ×–×”×•×ª â€¢ ${lang === 'he' ? '×¢×‘×¨×™×ª' : 'English'}</div>
                <div class="text-2xl font-bold mt-1">${escapeHtml(b.name)}</div>
                <div class="text-sm text-slate-500 mt-1">${escapeHtml(identity.subtitle || 'â€”')}</div>
              </div>
              <div class="text-blue-600 text-2xl"><i class="fas fa-book-open"></i></div>
            </div>

            <div class="mt-6 space-y-3 text-sm">
              <div class="flex justify-between"><span class="text-slate-500">×™×¢×“ ×’×™×•×¡</span><span class="font-bold">${money(b.target)}</span></div>
              <div class="flex justify-between"><span class="text-slate-500">× ×’×‘×”</span><span class="font-bold text-emerald-600">${money(b.raised)}</span></div>
              <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                <div class="bg-gradient-to-l from-emerald-400 to-emerald-600 h-full progress-bar" style="width:${b.progress}%"></div>
              </div>

              <div class="pt-3 border-t grid grid-cols-2 gap-3">
                <div class="p-3 rounded-xl bg-slate-50">
                  <div class="text-[10px] text-slate-400 font-bold uppercase">×¡×”×´×› ×”×“×¤×¡×•×ª</div>
                  <div class="text-xl font-bold mt-1">${pr.length}</div>
                </div>
                <div class="p-3 rounded-xl bg-slate-50">
                  <div class="text-[10px] text-slate-400 font-bold uppercase">×¡×”×´×› ×¢×•×ª×§×™×</div>
                  <div class="text-xl font-bold mt-1">${Number(sumPrint).toLocaleString()}</div>
                </div>
                <div class="p-3 rounded-xl bg-emerald-50 col-span-2">
                  <div class="text-[10px] text-emerald-600 font-bold uppercase">×ª×•×¨××™× ×‘×¨××ª ×”×¡×¤×¨</div>
                  <div class="text-xl font-bold mt-1">${money(sumDon)}</div>
                </div>
              </div>

              <button onclick="quickSaveBook('${lang}','${b.id}')" class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold transition">
                <i class="fas fa-save ml-2"></i> ×©××•×¨ (××§×•××™)
              </button>

              <div class="text-xs text-slate-400">* × ×©××¨ ×‘×“×¤×“×¤×Ÿ (LocalStorage) ××•×˜×•××˜×™×ª.</div>
            </div>
          </div>

          <div class="lg:col-span-2 space-y-6">
            <div class="card border-r-4 border-slate-300">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-id-card ml-2 text-slate-500"></i> ×¤×¨×˜×™ ×”×¡×¤×¨ (×©×“×•×ª ×œ×”×–× ×”)</h3>
                <span class="chip bg-slate-100 text-slate-700"><i class="fas fa-pen"></i> × ×™×ª×Ÿ ×œ×¢×¨×™×›×”</span>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                ${fieldInput('×›×•×ª×¨×ª ××©× ×”', identity.subtitle, v => `setBookField('${lang}','${b.id}','identity.subtitle', this.value)`, 'text')}
                ${fieldInput('××—×‘×¨', identity.author, v => `setBookField('${lang}','${b.id}','identity.author', this.value)`, 'text')}
                ${fieldInput('×¢×•×¨×š', identity.editor, v => `setBookField('${lang}','${b.id}','identity.editor', this.value)`, 'text')}
                ${fieldInput('×¡×“×¨×”', identity.series, v => `setBookField('${lang}','${b.id}','identity.series', this.value)`, 'text')}
                ${fieldInput('ISBN', identity.isbn, v => `setBookField('${lang}','${b.id}','identity.isbn', this.value)`, 'text')}
                ${fieldInput('××¡×³ ×¢××•×“×™×', identity.pages, v => `setBookField('${lang}','${b.id}','identity.pages', this.value)`, 'number')}
                ${fieldInput('×’×•×“×œ (Trim)', identity.trim, v => `setBookField('${lang}','${b.id}','identity.trim', this.value)`, 'text')}
                ${fieldInput('×›×¨×™×›×”', identity.binding, v => `setBookField('${lang}','${b.id}','identity.binding', this.value)`, 'text')}
              </div>

              <div class="mt-4">
                <label class="block text-xs font-bold text-slate-600 mb-1">×”×¢×¨×•×ª</label>
                <textarea
                  class="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 outline-none"
                  rows="3"
                  oninput="setBookField('${lang}','${b.id}','identity.notes', this.value)"
                  placeholder="×”×¢×¨×•×ª ×¤× ×™××™×•×ª...">${escapeHtml(identity.notes || '')}</textarea>
              </div>
            </div>

            <div class="card border-r-4 border-purple-500">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-print ml-2 text-purple-600"></i> ×”×™×¡×˜×•×¨×™×™×ª ×”×“×¤×¡×•×ª</h3>
                <button onclick="addPrintRun('${lang}','${b.id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-sm font-bold transition">
                  <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×”×“×¤×¡×”
                </button>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full text-right text-sm">
                  <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
                    <tr>
                      <th class="p-3">×©× ×”</th>
                      <th class="p-3">×›××•×ª</th>
                      <th class="p-3">×“×¤×•×¡</th>
                      <th class="p-3">×”×¢×¨×•×ª</th>
                      <th class="p-3 text-left">×¤×¢×•×œ×•×ª</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${
                      pr.length ? pr.map((r, idx) => `
                        <tr class="border-b hover:bg-slate-50">
                          <td class="p-3">
                            <input type="number" class="w-24 p-2 border rounded" value="${r.year ?? ''}"
                              oninput="updatePrintRun('${lang}','${b.id}',${idx},'year',this.value)" />
                          </td>
                          <td class="p-3">
                            <input type="number" class="w-28 p-2 border rounded" value="${r.qty ?? ''}"
                              oninput="updatePrintRun('${lang}','${b.id}',${idx},'qty',this.value)" />
                          </td>
                          <td class="p-3">
                            <input class="w-full p-2 border rounded" value="${escapeHtml(r.printer || '')}"
                              oninput="updatePrintRun('${lang}','${b.id}',${idx},'printer',this.value)" />
                          </td>
                          <td class="p-3">
                            <input class="w-full p-2 border rounded" value="${escapeHtml(r.notes || '')}"
                              oninput="updatePrintRun('${lang}','${b.id}',${idx},'notes',this.value)" />
                          </td>
                          <td class="p-3 text-left">
                            <button onclick="deletePrintRun('${lang}','${b.id}',${idx})" class="text-red-600 hover:underline text-xs font-bold">
                              <i class="fas fa-trash ml-1"></i> ××—×§
                            </button>
                          </td>
                        </tr>
                      `).join('') : `
                        <tr>
                          <td class="p-6 text-center text-slate-400" colspan="5">××™×Ÿ ×¢×“×™×™×Ÿ ×”×“×¤×¡×•×ª. ×œ×—×¥ "×”×•×¡×£ ×”×“×¤×¡×”".</td>
                        </tr>
                      `
                    }
                  </tbody>
                </table>
              </div>

              <div class="mt-3 text-xs text-slate-400">
                ×¡×”×´×› ×¢×•×ª×§×™× ××›×œ ×”×”×“×¤×¡×•×ª: <span class="font-bold text-slate-700">${Number(sumPrint).toLocaleString()}</span>
              </div>
            </div>

            <div class="card border-r-4 border-emerald-500">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-hand-holding-heart ml-2 text-emerald-600"></i> ×ª×•×¨××™× ×©×œ ×”×¡×¤×¨ (××™ ×ª×¨× â€¢ ××ª×™ â€¢ ×›××”)</h3>
                <button onclick="addBookDonor('${lang}','${b.id}')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg text-sm font-bold transition">
                  <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×ª×•×¨×
                </button>
              </div>

              <div class="overflow-x-auto">
                <table class="w-full text-right text-sm">
                  <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
                    <tr>
                      <th class="p-3">×©× ×ª×•×¨×</th>
                      <th class="p-3">×ª××¨×™×š</th>
                      <th class="p-3">×¡×›×•×</th>
                      <th class="p-3">×”×¢×¨×”</th>
                      <th class="p-3 text-left">×¤×¢×•×œ×•×ª</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${
                      bd.length ? bd.map((d, idx) => `
                        <tr class="border-b hover:bg-slate-50">
                          <td class="p-3">
                            <input class="w-full p-2 border rounded" value="${escapeHtml(d.name || '')}"
                              oninput="updateBookDonor('${lang}','${b.id}',${idx},'name',this.value)" />
                          </td>
                          <td class="p-3">
                            <input type="date" class="p-2 border rounded" value="${d.date || todayISO()}"
                              oninput="updateBookDonor('${lang}','${b.id}',${idx},'date',this.value)" />
                          </td>
                          <td class="p-3">
                            <input type="number" class="w-32 p-2 border rounded" value="${d.amount ?? ''}"
                              oninput="updateBookDonor('${lang}','${b.id}',${idx},'amount',this.value)" />
                          </td>
                          <td class="p-3">
                            <input class="w-full p-2 border rounded" value="${escapeHtml(d.note || '')}"
                              oninput="updateBookDonor('${lang}','${b.id}',${idx},'note',this.value)" />
                          </td>
                          <td class="p-3 text-left">
                            <button onclick="deleteBookDonor('${lang}','${b.id}',${idx})" class="text-red-600 hover:underline text-xs font-bold">
                              <i class="fas fa-trash ml-1"></i> ××—×§
                            </button>
                          </td>
                        </tr>
                      `).join('') : `
                        <tr>
                          <td class="p-6 text-center text-slate-400" colspan="5">××™×Ÿ ×ª×•×¨××™× ×‘×¨××ª ×”×¡×¤×¨ ×¢×“×™×™×Ÿ. ×œ×—×¥ "×”×•×¡×£ ×ª×•×¨×".</td>
                        </tr>
                      `
                    }
                  </tbody>
                </table>
              </div>

              <div class="mt-3 text-xs text-slate-400">
                ×¡×”×´×› ×ª×¨×•××•×ª ×œ×¡×¤×¨: <span class="font-bold text-emerald-700">${money(sumDon)}</span>
              </div>
            </div>

          </div>
        </div>
      `;
    }

    function fieldInput(label, value, oninputExpr, type){
      return `
        <div>
          <label class="block text-xs font-bold text-slate-600 mb-1">${label}</label>
          <input
            type="${type}"
            value="${escapeHtml(String(value ?? ''))}"
            oninput="${oninputExpr(null)}"
            class="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 outline-none"
            placeholder="${label}" />
        </div>
      `;
    }

    function renderDonors(el) {
      const total = store.donors.reduce((sum, d) => sum + parseInt(d.××ª× ×” || 0), 0);
      el.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <button onclick="openEntity('donorsSummary','0')" class="card bg-emerald-500 text-white border-none shadow-emerald-200 shadow-xl text-right">
            <div class="text-xs font-bold opacity-80 uppercase mb-1">×¡×”×´×› ×’×™×•×¡ ×”×—×•×“×©</div>
            <div class="text-4xl font-bold">${money(total)}</div>
            <div class="mt-2 text-xs opacity-90"><i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥</div>
          </button>
          <button onclick="openEntity('donorsSummary','1')" class="card bg-blue-500 text-white border-none text-right">
            <div class="text-xs font-bold opacity-80 uppercase mb-1">×ª×•×¨××™× ×¤×¢×™×œ×™×</div>
            <div class="text-4xl font-bold">${store.donors.length}</div>
            <div class="mt-2 text-xs opacity-90"><i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥</div>
          </button>
          <button onclick="openEntity('donorsSummary','2')" class="card bg-purple-500 text-white border-none text-right">
            <div class="text-xs font-bold opacity-80 uppercase mb-1">×××•×¦×¢ ×ª×¨×•××”</div>
            <div class="text-4xl font-bold">${money(Math.round(total / Math.max(1, store.donors.length)))}</div>
            <div class="mt-2 text-xs opacity-90"><i class="fas fa-mouse-pointer ml-1"></i> ×œ×—×¥</div>
          </button>
        </div>

        <div class="card">
          <h4 class="font-bold mb-4 text-lg">×¨×©×™××ª ×ª×•×¨××™×</h4>
          <table class="w-full text-right text-sm">
            <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
              <tr><th class="p-3">×©× ×ª×•×¨×</th><th class="p-3">×¤×¨×•×™×§×˜</th><th class="p-3">×ª××¨×™×š</th><th class="p-3">×¡×›×•×</th></tr>
            </thead>
            <tbody>
              ${store.donors.map((d, idx) => `
                <tr class="border-b hover:bg-slate-50 cursor-pointer" onclick="openEntity('donor','${idx}')">
                  <td class="p-3 font-bold text-slate-800">${escapeHtml(d.×©×)}</td>
                  <td class="p-3 text-slate-500 text-xs">${escapeHtml(d.×¤×¨×•×™×§×˜)}</td>
                  <td class="p-3 text-slate-400 text-xs">${escapeHtml(d.×ª××¨×™×š)}</td>
                  <td class="p-3 font-bold text-emerald-600">${money(parseInt(d.××ª× ×” || 0))}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <div class="pt-3 text-xs text-slate-400">* ×›×œ ×©×•×¨×” × ×™×ª× ×ª ×œ×œ×—×™×¦×” (×¢×¨×™×›×” ××”×™×¨×” ×‘××•×“×œ)</div>
        </div>
      `;
    }

    function renderExpenses(el) {
      const total = store.expenses.reduce((sum, e) => sum + parseInt(e.×¡×›×•× || 0), 0);
      el.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 text-center">
          <div class="card border-b-4 border-blue-500">
            <p class="text-[10px] text-slate-400 font-bold uppercase">××©×¨×“</p>
            <h2 class="text-2xl font-bold mt-1">â‚ª1,000</h2>
          </div>
          <div class="card border-b-4 border-slate-800">
            <p class="text-[10px] text-slate-400 font-bold uppercase">×—× ×™×”</p>
            <h2 class="text-2xl font-bold mt-1">â‚ª450</h2>
          </div>
          <div class="card border-b-4 border-slate-800">
            <p class="text-[10px] text-slate-400 font-bold uppercase">×¨×›×‘</p>
            <h2 class="text-2xl font-bold mt-1">â‚ª1,500</h2>
          </div>
          <div class="card border-b-4 border-emerald-500">
            <p class="text-[10px] text-slate-400 font-bold uppercase">×“×™×’×™×˜×œ</p>
            <h2 class="text-2xl font-bold mt-1">$100</h2>
          </div>
          <div class="card border-b-4 border-red-500">
            <p class="text-[10px] text-red-400 font-bold uppercase">×—×•×‘×•×ª</p>
            <h2 class="text-2xl font-bold mt-1 text-red-600">${money(total)}</h2>
          </div>
        </div>

        <div class="card">
          <h4 class="font-bold mb-4 text-lg">×—×•×‘×•×ª ×œ×¡×¤×§×™× ×•×’××´×—×™×</h4>
          <table class="w-full text-right text-sm">
            <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
              <tr><th class="p-3">×¡×¤×§</th><th class="p-3 text-left">×¡×›×•×</th><th class="p-3 text-left">×¤×¢×•×œ×•×ª</th></tr>
            </thead>
            <tbody>
              ${store.expenses.map((e, idx) => `
                <tr class="border-b hover:bg-slate-50">
                  <td class="p-3 font-bold text-slate-800">
                    <button class="text-right hover:underline" onclick="openEntity('expense','${idx}')">${escapeHtml(e.×¡×¤×§)}</button>
                  </td>
                  <td class="p-3 text-left">
                    <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold">${money(parseInt(e.×¡×›×•× || 0))}</span>
                  </td>
                  <td class="p-3 text-left">
                    <button onclick="markAsPaid(${idx})" class="text-green-600 hover:underline text-xs font-bold">
                      <i class="fas fa-check ml-1"></i> ×©×•×œ×
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderLogistics(el) {
      const israel = store.logistics.israel;
      const international = store.logistics.international;

      el.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card border-r-4 border-blue-500">
            <h4 class="font-bold text-blue-600 mb-4 text-lg">
              <i class="fas fa-map-marker-alt ml-2"></i> ×”×¤×¦×” ×‘××¨×¥
            </h4>
            <div class="space-y-3">
              ${israel.map((loc, idx) => `
                <button onclick="openEntity('logistics-israel','${idx}')" class="w-full text-right p-3 bg-blue-50 rounded-lg flex justify-between items-center hover:bg-blue-100 transition">
                  <div>
                    <div class="font-bold">${escapeHtml(loc.city)}</div>
                    <div class="text-xs text-slate-500 mt-1">
                      <span class="px-2 py-0.5 rounded ${loc.status === '×¤×¢×™×œ' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                        ${escapeHtml(loc.status)}
                      </span>
                    </div>
                  </div>
                  <span class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full font-bold">${loc.books} ×¡×¤×¨×™×</span>
                </button>
              `).join('')}
            </div>
          </div>

          <div class="card border-r-4 border-purple-500">
            <h4 class="font-bold text-purple-600 mb-4 text-lg">
              <i class="fas fa-globe ml-2"></i> ×”×¤×¦×” ×‘×—×•×´×œ
            </h4>
            <div class="space-y-3">
              ${international.map((loc, idx) => `
                <button onclick="openEntity('logistics-intl','${idx}')" class="w-full text-right p-3 bg-purple-50 rounded-lg flex justify-between items-center hover:bg-purple-100 transition">
                  <div>
                    <div class="font-bold">${escapeHtml(loc.country)}</div>
                    <div class="text-xs text-slate-500 mt-1">
                      <span class="px-2 py-0.5 rounded ${
                        loc.status === '×¤×¢×™×œ' ? 'bg-green-100 text-green-700'
                        : loc.status === '×‘×©×œ×™×—×”' ? 'bg-blue-100 text-blue-700'
                        : 'bg-gray-100 text-gray-700'
                      }">
                        ${escapeHtml(loc.status)}
                      </span>
                    </div>
                  </div>
                  <span class="text-xs bg-purple-600 text-white px-3 py-1 rounded-full font-bold">${loc.books} ×¡×¤×¨×™×</span>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // =========================
    // CLICK-TO-OPEN CARDS (××•×“×œ ××”×™×¨ ×œ×›×œ "×§×•×‘×™×”")
    // =========================
    function openEntity(type, id){
      currentModalMode = 'view';
      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('btn-submit').style.display = 'none';

      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      title.innerText = '×›×¨×˜×™×¡ ××™×“×¢';

      if(type === 'task'){
        const t = store.tasks[Number(id)];
        const th = managerTheme(t.×× ×”×œ);
        title.innerText = `××©×™××”: ${t.××©×™××”}`;
        body.innerHTML = `
          <div class="p-4 rounded-xl border mb-4" style="background:${th.soft}; border-color:${th.base}">
            <div class="text-xs font-bold" style="color:${th.text}">××—×¨××™: ${escapeHtml(t.×× ×”×œ)}</div>
            <div class="text-[10px]" style="color:${th.text}99">×“×—×™×¤×•×ª: ${escapeHtml(t.×“×—×™×¤×•×ª)} â€¢ ×˜×•×•×—: ${escapeHtml(t.×˜×•×•×—)}</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div class="p-4 bg-slate-50 rounded-xl"><div class="text-xs text-slate-400 font-bold">××—×¨××™</div><div class="font-bold">${escapeHtml(t.×× ×”×œ)}</div></div>
            <div class="p-4 bg-slate-50 rounded-xl"><div class="text-xs text-slate-400 font-bold">×“×—×™×¤×•×ª</div><div class="font-bold">${escapeHtml(t.×“×—×™×¤×•×ª)}</div></div>
            <div class="p-4 bg-slate-50 rounded-xl md:col-span-2"><div class="text-xs text-slate-400 font-bold">×˜×•×•×—</div><div class="font-bold">${escapeHtml(t.×˜×•×•×—)}</div></div>
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button onclick="completeTask(${Number(id)})" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
              <i class="fas fa-check ml-2"></i> ×¡××Ÿ ×›×‘×™×¦×•×¢
            </button>
          </div>
        `;
      }
      else if(type === 'staff'){
        const s = store.staff[Number(id)];
        const th = managerTheme(s.×©×);
        const myTasks = store.tasks.filter(t => t.×× ×”×œ === s.×©×);
        title.innerText = `×¢×•×‘×“: ${s.×©×}`;
        body.innerHTML = `
          <div class="space-y-2 text-sm">
            <div class="p-4 bg-slate-50 rounded-xl"><span class="text-slate-500">×ª×¤×§×™×“:</span> <span class="font-bold">${escapeHtml(s.×ª×¤×§×™×“)}</span></div>
            <div class="p-4 bg-slate-50 rounded-xl"><span class="text-slate-500">×˜×œ×¤×•×Ÿ:</span> <span class="font-bold">${escapeHtml(s.×˜×œ×¤×•×Ÿ)}</span></div>
            <div class="p-4 bg-slate-50 rounded-xl"><span class="text-slate-500">××™××™×™×œ:</span> <span class="font-bold">${escapeHtml(s.××™××™×™×œ)}</span></div>
          </div>

          <div class="mt-5 p-4 rounded-xl border" style="background:${th.soft}; border-color:${th.base}">
            <div class="font-bold mb-3" style="color:${th.text}">
              <i class="fas fa-list-check ml-2"></i> ×”××©×™××•×ª ×©×œ ${escapeHtml(s.×©×)} (${myTasks.length})
            </div>
            ${
              myTasks.length
                ? `<div class="space-y-2">
                    ${myTasks.map(t => `
                      <div class="p-3 rounded-lg bg-white/70 border" style="border-color:${th.base}">
                        <div class="font-bold" style="color:${th.text}">${escapeHtml(t.××©×™××”)}</div>
                        <div class="text-[10px] text-slate-500">×“×—×™×¤×•×ª: ${escapeHtml(t.×“×—×™×¤×•×ª)} â€¢ ×˜×•×•×—: ${escapeHtml(t.×˜×•×•×—)}</div>
                      </div>
                    `).join('')}
                   </div>`
                : `<div class="text-sm text-slate-500">××™×Ÿ ×›×¨×’×¢ ××©×™××•×ª ×œ×¢×•×‘×“ ×”×–×”.</div>`
            }
            <div class="mt-4 flex justify-end">
              <button onclick="selectedTaskOwner='${escapeHtml(s.×©×)}'; hideModal(); switchTab('tasks', {pushHistory:true});"
                class="px-4 py-2 rounded-lg font-bold text-sm"
                style="background:${th.base}; color:#fff">
                <i class="fas fa-eye ml-2"></i> ×¤×ª×— ×˜××‘ ××©×™××•×ª (×¡×™× ×•×Ÿ)
              </button>
            </div>
          </div>
        `;
      }
      else if(type === 'donor'){
        const d = store.donors[Number(id)];
        title.innerText = `×ª×•×¨×: ${d.×©×}`;
        body.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div class="p-4 bg-slate-50 rounded-xl"><div class="text-xs text-slate-400 font-bold">×¤×¨×•×™×§×˜</div><div class="font-bold">${escapeHtml(d.×¤×¨×•×™×§×˜)}</div></div>
            <div class="p-4 bg-slate-50 rounded-xl"><div class="text-xs text-slate-400 font-bold">×ª××¨×™×š</div><div class="font-bold">${escapeHtml(d.×ª××¨×™×š)}</div></div>
            <div class="p-4 bg-emerald-50 rounded-xl md:col-span-2"><div class="text-xs text-emerald-600 font-bold">×¡×›×•×</div><div class="font-bold text-emerald-700">${money(parseInt(d.××ª× ×”||0))}</div></div>
          </div>
        `;
      }
      else if(type === 'donorsSummary'){
        const total = store.donors.reduce((sum, d) => sum + parseInt(d.××ª× ×” || 0), 0);
        const avg = Math.round(total / Math.max(1, store.donors.length));
        const map = {
          '0': { title:'×¡×”×´×› ×’×™×•×¡ ×”×—×•×“×©', body:`${money(total)}` },
          '1': { title:'×ª×•×¨××™× ×¤×¢×™×œ×™×', body:`${store.donors.length}` },
          '2': { title:'×××•×¦×¢ ×ª×¨×•××”', body:`${money(avg)}` },
        };
        title.innerText = map[id]?.title || '×¡×™×›×•×';
        body.innerHTML = `<div class="card bg-slate-50 border text-center">
          <div class="text-4xl font-bold text-slate-800">${map[id]?.body || ''}</div>
        </div>`;
      }
      else if(type === 'expense'){
        const e = store.expenses[Number(id)];
        title.innerText = `×—×•×‘: ${e.×¡×¤×§}`;
        body.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div class="p-4 bg-slate-50 rounded-xl"><div class="text-xs text-slate-400 font-bold">×¡×¤×§</div><div class="font-bold">${escapeHtml(e.×¡×¤×§)}</div></div>
            <div class="p-4 bg-red-50 rounded-xl"><div class="text-xs text-red-500 font-bold">×¡×›×•×</div><div class="font-bold text-red-700">${money(parseInt(e.×¡×›×•×||0))}</div></div>
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button onclick="markAsPaid(${Number(id)})" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
              <i class="fas fa-check ml-2"></i> ×¡××Ÿ ×›×©×•×œ×
            </button>
          </div>
        `;
      }
      else if(type === 'logistics-israel'){
        const loc = store.logistics.israel[Number(id)];
        title.innerText = `×”×¤×¦×” ×‘××¨×¥: ${loc.city}`;
        body.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div class="p-4 bg-slate-50 rounded-xl"><div class="text-xs text-slate-400 font-bold">×¢×™×¨</div><div class="font-bold">${escapeHtml(loc.city)}</div></div>
            <div class="p-4 bg-slate-50 rounded-xl"><div class="text-xs text-slate-400 font-bold">×¡×˜×˜×•×¡</div><div class="font-bold">${escapeHtml(loc.status)}</div></div>
            <div class="p-4 bg-blue-50 rounded-xl md:col-span-2"><div class="text-xs text-blue-600 font-bold">×›××•×ª ×¡×¤×¨×™×</div><div class="font-bold text-blue-700">${loc.books}</div></div>
          </div>
        `;
      }
      else if(type === 'logistics-intl'){
        const loc = store.logistics.international[Number(id)];
        title.innerText = `×”×¤×¦×” ×‘×—×•×´×œ: ${loc.country}`;
        body.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
            <div class="p-4 bg-slate-50 rounded-xl"><div class="text-xs text-slate-400 font-bold">××“×™× ×”</div><div class="font-bold">${escapeHtml(loc.country)}</div></div>
            <div class="p-4 bg-slate-50 rounded-xl"><div class="text-xs text-slate-400 font-bold">×¡×˜×˜×•×¡</div><div class="font-bold">${escapeHtml(loc.status)}</div></div>
            <div class="p-4 bg-purple-50 rounded-xl md:col-span-2"><div class="text-xs text-purple-600 font-bold">×›××•×ª ×¡×¤×¨×™×</div><div class="font-bold text-purple-700">${loc.books}</div></div>
          </div>
        `;
      }
      else{
        title.innerText = '××™×“×¢';
        body.innerHTML = `<div class="text-sm text-slate-500">×›×¨×˜×™×¡ ×›×œ×œ×™</div>`;
      }
    }

    // =========================
    // ACTIONS
    // =========================
    function completeTask(idx) {
      if(confirm('×”×× ×œ×¡××Ÿ ××©×™××” ×–×• ×›×‘×•×¦×¢×”?')) {
        store.tasks.splice(idx, 1);
        saveStore();
        hideModal();
        switchTab('tasks', { pushHistory:false });
        showNotification('×”××©×™××” ×¡×•×× ×” ×›×‘×•×¦×¢×”! ğŸ‰');
      }
    }

    function markAsPaid(idx) {
      if(confirm('×”×× ×œ×¡××Ÿ ×—×•×‘ ×–×” ×›×©×•×œ×?')) {
        store.expenses.splice(idx, 1);
        saveStore();
        hideModal();
        switchTab('expenses', { pushHistory:false });
        showNotification('×”×—×•×‘ ×¡×•××Ÿ ×›×©×•×œ×! âœ…');
      }
    }

    // =========================
    // BOOK DETAIL MUTATIONS
    // =========================
    function setBookField(lang, id, path, value){
      const b = findBook(lang, id);
      if(!b) return;
      const [root, key] = path.split('.');
      if(root === 'identity'){
        b.identity = b.identity || {};
        if(key === 'pages'){
          b.identity[key] = parseInt(value || 0);
        } else {
          b.identity[key] = value;
        }
      }
      saveStore();
    }

    function addPrintRun(lang, id){
      const b = findBook(lang, id);
      if(!b) return;
      b.printRuns = b.printRuns || [];
      b.printRuns.unshift({ year: new Date().getFullYear(), qty: 0, printer: "", notes: "" });
      saveStore();
      renderBookDetail(document.getElementById('tab-content'), lang, id);
      showNotification('× ×•×¡×¤×” ×©×•×¨×ª ×”×“×¤×¡×”');
    }

    function updatePrintRun(lang, id, idx, field, value){
      const b = findBook(lang, id);
      if(!b) return;
      const r = b.printRuns[idx];
      if(!r) return;
      if(field === 'year' || field === 'qty') r[field] = parseInt(value || 0);
      else r[field] = value;
      saveStore();
    }

    function deletePrintRun(lang, id, idx){
      const b = findBook(lang, id);
      if(!b) return;
      if(confirm('×œ××—×•×§ ×©×•×¨×ª ×”×“×¤×¡×”?')){
        b.printRuns.splice(idx, 1);
        saveStore();
        renderBookDetail(document.getElementById('tab-content'), lang, id);
        showNotification('×©×•×¨×ª ×”×“×¤×¡×” × ××—×§×”');
      }
    }

    function addBookDonor(lang, id){
      const b = findBook(lang, id);
      if(!b) return;
      b.donors = b.donors || [];
      b.donors.unshift({ id: uid(), name: "×ª×•×¨× ×—×“×©", amount: 0, date: todayISO(), note: "" });
      saveStore();
      renderBookDetail(document.getElementById('tab-content'), lang, id);
      showNotification('× ×•×¡×£ ×ª×•×¨× ×‘×¨××ª ×”×¡×¤×¨');
    }

    function updateBookDonor(lang, id, idx, field, value){
      const b = findBook(lang, id);
      if(!b) return;
      const d = b.donors[idx];
      if(!d) return;
      if(field === 'amount') d[field] = parseInt(value || 0);
      else d[field] = value;
      saveStore();
    }

    function deleteBookDonor(lang, id, idx){
      const b = findBook(lang, id);
      if(!b) return;
      if(confirm('×œ××—×•×§ ×ª×•×¨× ××”×¡×¤×¨?')){
        b.donors.splice(idx, 1);
        saveStore();
        renderBookDetail(document.getElementById('tab-content'), lang, id);
        showNotification('×ª×•×¨× × ××—×§');
      }
    }

    function quickSaveBook(lang, id){
      saveStore();
      showNotification('× ×©××¨ ×‘×“×¤×“×¤×Ÿ âœ…');
    }

    // =========================
    // MODAL: ADD + EDIT
    // =========================
    function showAddModal() {
      currentModalMode = 'add';
      const body = document.getElementById('modal-body');
      const title = document.getElementById('modal-title');
      document.getElementById('modal').classList.remove('hidden');
      document.getElementById('btn-submit').style.display = 'inline-block';

      if(currentActiveTab === 'book-detail' && currentBookContext){
        const { lang, id } = currentBookContext;
        title.innerText = '×”×•×¡×¤×” ×œ×¡×¤×¨';
        body.innerHTML = `
          <button onclick="addPrintRun('${lang}','${id}'); hideModal();" class="w-full p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-right font-bold text-purple-700 transition flex items-center justify-between">
            <span><i class="fas fa-print ml-2"></i> ×”×•×¡×£ ×©×•×¨×ª ×”×“×¤×¡×”</span>
            <i class="fas fa-chevron-left"></i>
          </button>
          <button onclick="addBookDonor('${lang}','${id}'); hideModal();" class="w-full p-4 bg-emerald-50 hover:bg-emerald-100 rounded-lg text-right font-bold text-emerald-700 transition flex items-center justify-between">
            <span><i class="fas fa-hand-holding-heart ml-2"></i> ×”×•×¡×£ ×ª×•×¨× ×œ×¡×¤×¨</span>
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="text-xs text-slate-400">* ×‘×¢××•×“ ×¡×¤×¨, ×”×›×¤×ª×•×¨ "×”×•×¡×£" ××ª×™×™×—×¡ ×œ× ×ª×•× ×™× ×©×œ ×”×¡×¤×¨.</div>
        `;
        document.getElementById('btn-submit').style.display = 'none';
        return;
      }

      if(currentActiveTab === 'tasks') {
        title.innerText = '×”×•×¡×¤×ª ××©×™××” ×—×“×©×”';
        body.innerHTML = `
          <input id="in-name" class="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 outline-none" placeholder="×ª×™××•×¨ ×”××©×™××”">
          <select id="in-manager" class="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 outline-none mt-3">
            <option value="">×‘×—×¨ ×× ×”×œ ×‘×™×¦×•×¢...</option>
            ${store.staff.map(s => `<option value="${escapeHtml(s.×©×)}">${escapeHtml(s.×©×)}</option>`).join('')}
          </select>
          <select id="in-urgency" class="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 outline-none mt-3">
            <option value="×¨×’×™×œ×”">×“×—×™×¤×•×ª ×¨×’×™×œ×”</option>
            <option value="×’×‘×•×”×”">×“×—×™×¤×•×ª ×’×‘×•×”×” ğŸ”¥</option>
          </select>
          <select id="in-timeframe" class="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-blue-500 outline-none mt-3">
            <option value="×—×•×“×©×™">×—×•×“×©×™</option>
            <option value="××¨×•×š">×˜×•×•×— ××¨×•×š</option>
          </select>
        `;
      }
      else if(currentActiveTab === 'staff') {
        title.innerText = '×”×•×¡×¤×ª ×¢×•×‘×“ ×—×“×©';
        body.innerHTML = `
          <input id="in-staff-name" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3" placeholder="×©× ×”×¢×•×‘×“">
          <input id="in-staff-role" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3" placeholder="×ª×¤×§×™×“">
          <input id="in-staff-phone" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3" placeholder="×˜×œ×¤×•×Ÿ">
          <input id="in-staff-email" class="w-full p-3 border-2 border-slate-200 rounded-lg" placeholder="××™××™×™×œ">
        `;
      }
      else if(currentActiveTab === 'donors') {
        const allBooks = [...store.books.he, ...store.books.en];
        title.innerText = '×”×•×¡×¤×ª ×ª×¨×•××” ×—×“×©×”';
        body.innerHTML = `
          <input id="in-donor-name" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3" placeholder="×©× ×”×ª×•×¨×">
          <select id="in-donor-project" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3">
            <option value="">×‘×—×¨ ×¤×¨×•×™×§×˜/×¡×¤×¨...</option>
            ${allBooks.map(b => `<option value="${escapeHtml(b.name)}">${escapeHtml(b.name)}</option>`).join('')}
          </select>
          <input id="in-donor-amount" type="number" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3" placeholder="×¡×›×•× ×”×ª×¨×•××” (â‚ª)">
          <input id="in-donor-date" type="date" class="w-full p-3 border-2 border-slate-200 rounded-lg" value="${todayISO()}">
        `;
      }
      else if(currentActiveTab === 'expenses') {
        title.innerText = '×”×•×¡×¤×ª ×”×•×¦××” ×—×“×©×”';
        body.innerHTML = `
          <input id="in-expense-name" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3" placeholder="×©× ×”×¡×¤×§">
          <input id="in-expense-amount" type="number" class="w-full p-3 border-2 border-slate-200 rounded-lg" placeholder="×¡×›×•× ×”×—×•×‘ (â‚ª)">
        `;
      }
      else if(currentActiveTab === 'books-he' || currentActiveTab === 'books-en'){
        const lang = currentActiveTab === 'books-he' ? 'he' : 'en';
        title.innerText = `×”×•×¡×¤×ª ×¡×¤×¨ ×—×“×© (${lang === 'he' ? '×¢×‘×¨×™×ª' : '×× ×’×œ×™×ª'})`;
        body.innerHTML = `
          <input id="in-book-name" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3" placeholder="×©× ×”×¡×¤×¨">
          <input id="in-book-target" type="number" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3" placeholder="×™×¢×“ ×’×™×•×¡ (â‚ª)" value="50000">
          <input id="in-book-raised" type="number" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-3" placeholder="× ×’×‘×” ×¢×“ ×›×” (â‚ª)" value="0">
          <input id="in-book-subtitle" class="w-full p-3 border-2 border-slate-200 rounded-lg" placeholder="×›×•×ª×¨×ª ××©× ×” (××•×¤×¦×™×•× ×œ×™)">
          <input type="hidden" id="in-book-lang" value="${lang}">
        `;
      }
    }

    function showEditDataModal() {
      currentModalMode = 'edit';
      document.getElementById('modal').classList.remove('hidden');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');

      title.innerText = "×¢×¨×™×›×ª × ×ª×•× ×™× ×‘××¢×¨×›×ª";
      body.innerHTML = `
        <div class="space-y-3">
          <button onclick="editStaff()" class="w-full p-4 bg-blue-50 hover:bg-blue-100 rounded-lg text-right font-bold text-blue-700 transition flex items-center justify-between">
            <span><i class="fas fa-users ml-2"></i> ×¢×¨×™×›×ª ×¦×•×•×ª ×”×¢×•×‘×“×™×</span>
            <i class="fas fa-chevron-left"></i>
          </button>

          <button onclick="editBooks('he')" class="w-full p-4 bg-emerald-50 hover:bg-emerald-100 rounded-lg text-right font-bold text-emerald-700 transition flex items-center justify-between">
            <span><i class="fas fa-book ml-2"></i> ×¢×¨×™×›×ª ×¡×¤×¨×™× ×¢×‘×¨×™×ª</span>
            <i class="fas fa-chevron-left"></i>
          </button>

          <button onclick="editBooks('en')" class="w-full p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-right font-bold text-purple-700 transition flex items-center justify-between">
            <span><i class="fas fa-language ml-2"></i> ×¢×¨×™×›×ª ×¡×¤×¨×™× ×× ×’×œ×™×ª</span>
            <i class="fas fa-chevron-left"></i>
          </button>

          <button onclick="editDonors()" class="w-full p-4 bg-pink-50 hover:bg-pink-100 rounded-lg text-right font-bold text-pink-700 transition flex items-center justify-between">
            <span><i class="fas fa-heart ml-2"></i> ×¢×¨×™×›×ª ×ª×•×¨××™× (×›×œ×œ×™)</span>
            <i class="fas fa-chevron-left"></i>
          </button>

          <button onclick="editExpenses()" class="w-full p-4 bg-red-50 hover:bg-red-100 rounded-lg text-right font-bold text-red-700 transition flex items-center justify-between">
            <span><i class="fas fa-file-invoice ml-2"></i> ×¢×¨×™×›×ª ×”×•×¦××•×ª</span>
            <i class="fas fa-chevron-left"></i>
          </button>

          <button onclick="editLogistics()" class="w-full p-4 bg-slate-50 hover:bg-slate-100 rounded-lg text-right font-bold text-slate-700 transition flex items-center justify-between">
            <span><i class="fas fa-shipping-fast ml-2"></i> ×¢×¨×™×›×ª ×”×¤×¦×”</span>
            <i class="fas fa-chevron-left"></i>
          </button>
        </div>
      `;

      document.getElementById('btn-submit').style.display = 'none';
    }

    function editStaff() {
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      document.getElementById('btn-submit').style.display = 'inline-block';

      title.innerText = "×¢×¨×™×›×ª ×¦×•×•×ª ×”×¢×•×‘×“×™×";
      body.innerHTML = `
        <div class="space-y-4">
          ${store.staff.map((member, idx) => `
            <div class="p-4 border-2 border-slate-200 rounded-lg">
              <div class="font-bold mb-3 text-slate-700">×¢×•×‘×“ ××¡' ${idx + 1}</div>
              <input value="${escapeHtml(member.×©×)}" onchange="store.staff[${idx}].×©× = this.value; saveStore();" class="w-full p-2 border rounded mb-2" placeholder="×©× ××œ×">
              <input value="${escapeHtml(member.×ª×¤×§×™×“)}" onchange="store.staff[${idx}].×ª×¤×§×™×“ = this.value; saveStore();" class="w-full p-2 border rounded mb-2" placeholder="×ª×¤×§×™×“">
              <input value="${escapeHtml(member.×˜×œ×¤×•×Ÿ)}" onchange="store.staff[${idx}].×˜×œ×¤×•×Ÿ = this.value; saveStore();" class="w-full p-2 border rounded mb-2" placeholder="×˜×œ×¤×•×Ÿ">
              <input value="${escapeHtml(member.××™××™×™×œ)}" onchange="store.staff[${idx}].××™××™×™×œ = this.value; saveStore();" class="w-full p-2 border rounded mb-2" placeholder="××™××™×™×œ">
              <button onclick="deleteStaff(${idx})" class="text-red-600 text-sm font-bold hover:underline">
                <i class="fas fa-trash ml-1"></i> ××—×§ ×¢×•×‘×“
              </button>
            </div>
          `).join('')}
          <button onclick="addNewStaff()" class="w-full p-3 border-2 border-dashed border-blue-300 rounded-lg text-blue-600 font-bold hover:bg-blue-50">
            <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×¢×•×‘×“ ×—×“×©
          </button>
        </div>
      `;

      document.getElementById('btn-submit').onclick = () => {
        saveStore();
        hideModal();
        switchTab('staff', { pushHistory:false });
        showNotification('× ×ª×•× ×™ ×”×¦×•×•×ª ×¢×•×“×›× ×•!');
      };
    }

    function addNewStaff() {
      store.staff.push({ ×©×: "×¢×•×‘×“ ×—×“×©", ×ª×¤×§×™×“: "×ª×¤×§×™×“", ×˜×œ×¤×•×Ÿ: "050-0000000", ××™××™×™×œ: "email@hoffman.org" });
      saveStore();
      editStaff();
    }

    function deleteStaff(idx) {
      if(confirm('×”×× ×œ××—×•×§ ×¢×•×‘×“ ×–×”?')) {
        store.staff.splice(idx, 1);
        saveStore();
        editStaff();
      }
    }

    function editBooks(lang) {
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      document.getElementById('btn-submit').style.display = 'inline-block';

      const langName = lang === 'he' ? '×¢×‘×¨×™×ª' : '×× ×’×œ×™×ª';
      title.innerText = `×¢×¨×™×›×ª ×¡×¤×¨×™× - ${langName}`;

      body.innerHTML = `
        <div class="space-y-4">
          ${store.books[lang].map((book, idx) => `
            <div class="p-4 border-2 border-slate-200 rounded-lg">
              <div class="font-bold mb-3 text-slate-700">${escapeHtml(book.name)}</div>

              <label class="block text-xs font-bold text-slate-600 mb-1">×©× ×”×¡×¤×¨</label>
              <input value="${escapeHtml(book.name)}" onchange="store.books['${lang}'][${idx}].name = this.value; saveStore();" class="w-full p-2 border rounded mb-2">

              <label class="block text-xs font-bold text-slate-600 mb-1">×™×¢×“ ×’×™×•×¡ (â‚ª)</label>
              <input type="number" value="${book.target}" onchange="store.books['${lang}'][${idx}].target = parseInt(this.value||0); recalcBookProgress('${lang}',${idx}); saveStore();" class="w-full p-2 border rounded mb-2">

              <label class="block text-xs font-bold text-slate-600 mb-1">×›×‘×¨ × ×’×‘×” (â‚ª)</label>
              <input type="number" value="${book.raised}" onchange="store.books['${lang}'][${idx}].raised = parseInt(this.value||0); recalcBookProgress('${lang}',${idx}); saveStore();" class="w-full p-2 border rounded mb-2">

              <label class="block text-xs font-bold text-slate-600 mb-1">××¡×³ ×ª×•×¨××™× (×›×œ×œ×™)</label>
              <input type="number" value="${book.donorsCount ?? 0}" onchange="store.books['${lang}'][${idx}].donorsCount = parseInt(this.value||0); saveStore();" class="w-full p-2 border rounded mb-2">

              <button onclick="openBookDetail('${lang}','${book.id}'); hideModal();" class="text-blue-600 text-sm font-bold hover:underline">
                <i class="fas fa-arrow-left ml-1"></i> ×¤×ª×— ×¢××•×“ ××œ×
              </button>
              <span class="mx-2 text-slate-300">|</span>
              <button onclick="deleteBook('${lang}', ${idx})" class="text-red-600 text-sm font-bold hover:underline">
                <i class="fas fa-trash ml-1"></i> ××—×§ ×¡×¤×¨
              </button>
            </div>
          `).join('')}

          <button onclick="addNewBook('${lang}')" class="w-full p-3 border-2 border-dashed border-blue-300 rounded-lg text-blue-600 font-bold hover:bg-blue-50">
            <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×¡×¤×¨ ×—×“×©
          </button>
        </div>
      `;

      document.getElementById('btn-submit').onclick = () => {
        saveStore();
        hideModal();
        switchTab(lang === 'he' ? 'books-he' : 'books-en', { pushHistory:false });
        showNotification('× ×ª×•× ×™ ×”×¡×¤×¨×™× ×¢×•×“×›× ×•!');
      };
    }

    function recalcBookProgress(lang, idx){
      const b = store.books[lang][idx];
      b.progress = Math.max(0, Math.min(100, Math.round((Number(b.raised||0) / Math.max(1, Number(b.target||0))) * 100)));
    }

    function addNewBook(lang) {
      store.books[lang].push({
        id: `${lang}-${uid()}`,
        name: "×¡×¤×¨ ×—×“×©",
        progress: 0, target: 50000, raised: 0, donorsCount: 0,
        identity: { subtitle:"", author:"", editor:"", series:"", isbn:"", pages:0, trim: lang==='he'?'17Ã—24':'6Ã—9', binding:"", notes:"" },
        printRuns: [],
        donors: []
      });
      saveStore();
      editBooks(lang);
    }

    function deleteBook(lang, idx) {
      if(confirm('×”×× ×œ××—×•×§ ×¡×¤×¨ ×–×”?')) {
        store.books[lang].splice(idx, 1);
        saveStore();
        editBooks(lang);
      }
    }

    function editDonors() {
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      document.getElementById('btn-submit').style.display = 'inline-block';

      title.innerText = "×¢×¨×™×›×ª ×ª×•×¨××™× (×›×œ×œ×™)";
      body.innerHTML = `
        <div class="space-y-4">
          ${store.donors.map((donor, idx) => `
            <div class="p-4 border-2 border-slate-200 rounded-lg">
              <div class="grid grid-cols-2 gap-2">
                <input value="${escapeHtml(donor.×©×)}" onchange="store.donors[${idx}].×©× = this.value; saveStore();" class="p-2 border rounded" placeholder="×©×">
                <input value="${escapeHtml(donor.×¤×¨×•×™×§×˜)}" onchange="store.donors[${idx}].×¤×¨×•×™×§×˜ = this.value; saveStore();" class="p-2 border rounded" placeholder="×¤×¨×•×™×§×˜">
                <input type="number" value="${donor.××ª× ×”}" onchange="store.donors[${idx}].××ª× ×” = this.value; saveStore();" class="p-2 border rounded" placeholder="×¡×›×•×">
                <input type="date" value="${donor.×ª××¨×™×š}" onchange="store.donors[${idx}].×ª××¨×™×š = this.value; saveStore();" class="p-2 border rounded">
              </div>
              <button onclick="deleteDonor(${idx})" class="text-red-600 text-sm font-bold hover:underline mt-2">
                <i class="fas fa-trash ml-1"></i> ××—×§
              </button>
            </div>
          `).join('')}
          <button onclick="addNewDonor()" class="w-full p-3 border-2 border-dashed border-blue-300 rounded-lg text-blue-600 font-bold hover:bg-blue-50">
            <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×ª×•×¨×
          </button>
        </div>
      `;

      document.getElementById('btn-submit').onclick = () => {
        saveStore();
        hideModal();
        switchTab('donors', { pushHistory:false });
        showNotification('× ×ª×•× ×™ ×”×ª×•×¨××™× ×¢×•×“×›× ×•!');
      };
    }

    function addNewDonor() {
      store.donors.push({ ×©×: "×ª×•×¨× ×—×“×©", ×¤×¨×•×™×§×˜: "×¤×¨×•×™×§×˜", ××ª× ×”: "1000", ×ª××¨×™×š: todayISO() });
      saveStore();
      editDonors();
    }

    function deleteDonor(idx) {
      if(confirm('×”×× ×œ××—×•×§ ×ª×•×¨× ×–×”?')) {
        store.donors.splice(idx, 1);
        saveStore();
        editDonors();
      }
    }

    function editExpenses() {
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      document.getElementById('btn-submit').style.display = 'inline-block';

      title.innerText = "×¢×¨×™×›×ª ×”×•×¦××•×ª";
      body.innerHTML = `
        <div class="space-y-4">
          ${store.expenses.map((expense, idx) => `
            <div class="p-4 border-2 border-slate-200 rounded-lg">
              <input value="${escapeHtml(expense.×¡×¤×§)}" onchange="store.expenses[${idx}].×¡×¤×§ = this.value; saveStore();" class="w-full p-2 border rounded mb-2" placeholder="×©× ×¡×¤×§">
              <input type="number" value="${expense.×¡×›×•×}" onchange="store.expenses[${idx}].×¡×›×•× = this.value; saveStore();" class="w-full p-2 border rounded mb-2" placeholder="×¡×›×•×">
              <button onclick="deleteExpense(${idx})" class="text-red-600 text-sm font-bold hover:underline">
                <i class="fas fa-trash ml-1"></i> ××—×§
              </button>
            </div>
          `).join('')}
          <button onclick="addNewExpense()" class="w-full p-3 border-2 border-dashed border-blue-300 rounded-lg text-blue-600 font-bold hover:bg-blue-50">
            <i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×”×•×¦××”
          </button>
        </div>
      `;

      document.getElementById('btn-submit').onclick = () => {
        saveStore();
        hideModal();
        switchTab('expenses', { pushHistory:false });
        showNotification('× ×ª×•× ×™ ×”×”×•×¦××•×ª ×¢×•×“×›× ×•!');
      };
    }

    function addNewExpense() {
      store.expenses.push({ ×¡×¤×§: "×¡×¤×§ ×—×“×©", ×¡×›×•×: "1000", ×¡×˜×˜×•×¡: "×××ª×™×Ÿ" });
      saveStore();
      editExpenses();
    }

    function deleteExpense(idx) {
      if(confirm('×”×× ×œ××—×•×§ ×”×•×¦××” ×–×•?')) {
        store.expenses.splice(idx, 1);
        saveStore();
        editExpenses();
      }
    }

    function editLogistics() {
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      document.getElementById('btn-submit').style.display = 'inline-block';

      title.innerText = "×¢×¨×™×›×ª ×”×¤×¦×”";
      body.innerHTML = `
        <div class="space-y-4">
          <h4 class="font-bold text-blue-600">×”×¤×¦×” ×‘××¨×¥</h4>
          ${store.logistics.israel.map((loc, idx) => `
            <div class="p-4 border-2 border-slate-200 rounded-lg">
              <input value="${escapeHtml(loc.city)}" onchange="store.logistics.israel[${idx}].city = this.value; saveStore();" class="w-full p-2 border rounded mb-2" placeholder="×¢×™×¨">
              <input type="number" value="${loc.books}" onchange="store.logistics.israel[${idx}].books = parseInt(this.value||0); saveStore();" class="w-full p-2 border rounded mb-2" placeholder="××¡×¤×¨ ×¡×¤×¨×™×">
              <select onchange="store.logistics.israel[${idx}].status = this.value; saveStore();" class="w-full p-2 border rounded">
                <option value="×¤×¢×™×œ" ${loc.status === '×¤×¢×™×œ' ? 'selected' : ''}>×¤×¢×™×œ</option>
                <option value="×‘×”××ª× ×”" ${loc.status === '×‘×”××ª× ×”' ? 'selected' : ''}>×‘×”××ª× ×”</option>
              </select>
            </div>
          `).join('')}

          <h4 class="font-bold text-purple-600 mt-6">×”×¤×¦×” ×‘×—×•×´×œ</h4>
          ${store.logistics.international.map((loc, idx) => `
            <div class="p-4 border-2 border-slate-200 rounded-lg">
              <input value="${escapeHtml(loc.country)}" onchange="store.logistics.international[${idx}].country = this.value; saveStore();" class="w-full p-2 border rounded mb-2" placeholder="××“×™× ×”">
              <input type="number" value="${loc.books}" onchange="store.logistics.international[${idx}].books = parseInt(this.value||0); saveStore();" class="w-full p-2 border rounded mb-2" placeholder="××¡×¤×¨ ×¡×¤×¨×™×">
              <select onchange="store.logistics.international[${idx}].status = this.value; saveStore();" class="w-full p-2 border rounded">
                <option value="×¤×¢×™×œ" ${loc.status === '×¤×¢×™×œ' ? 'selected' : ''}>×¤×¢×™×œ</option>
                <option value="×‘×©×œ×™×—×”" ${loc.status === '×‘×©×œ×™×—×”' ? 'selected' : ''}>×‘×©×œ×™×—×”</option>
                <option value="×‘×ª×›× ×•×Ÿ" ${loc.status === '×‘×ª×›× ×•×Ÿ' ? 'selected' : ''}>×‘×ª×›× ×•×Ÿ</option>
              </select>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('btn-submit').onclick = () => {
        saveStore();
        hideModal();
        switchTab('logistics', { pushHistory:false });
        showNotification('× ×ª×•× ×™ ×”×”×¤×¦×” ×¢×•×“×›× ×•!');
      };
    }

    function processSubmit() {
      if(currentActiveTab === 'tasks') {
        const name = document.getElementById('in-name').value;
        const manager = document.getElementById('in-manager').value;
        const urgency = document.getElementById('in-urgency').value;
        const timeframe = document.getElementById('in-timeframe').value;
        if(!name || !manager) return alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");
        store.tasks.push({ ××©×™××”: name, ×× ×”×œ: manager, ×“×—×™×¤×•×ª: urgency, ×˜×•×•×—: timeframe });
      }
      else if(currentActiveTab === 'staff') {
        const name = document.getElementById('in-staff-name').value;
        const role = document.getElementById('in-staff-role').value;
        const phone = document.getElementById('in-staff-phone').value;
        const email = document.getElementById('in-staff-email').value;
        if(!name || !role) return alert("× × ×œ××œ× ×œ×¤×—×•×ª ×©× ×•×ª×¤×§×™×“");
        store.staff.push({ ×©×: name, ×ª×¤×§×™×“: role, ×˜×œ×¤×•×Ÿ: phone, ××™××™×™×œ: email });
      }
      else if(currentActiveTab === 'donors') {
        const name = document.getElementById('in-donor-name').value;
        const project = document.getElementById('in-donor-project').value;
        const amount = document.getElementById('in-donor-amount').value;
        const date = document.getElementById('in-donor-date').value;
        if(!name || !project || !amount) return alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");
        store.donors.push({ ×©×: name, ×¤×¨×•×™×§×˜: project, ××ª× ×”: amount, ×ª××¨×™×š: date });
      }
      else if(currentActiveTab === 'expenses') {
        const name = document.getElementById('in-expense-name').value;
        const amount = document.getElementById('in-expense-amount').value;
        if(!name || !amount) return alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");
        store.expenses.push({ ×¡×¤×§: name, ×¡×›×•×: amount, ×¡×˜×˜×•×¡: "×××ª×™×Ÿ" });
      }
      else if(currentActiveTab === 'books-he' || currentActiveTab === 'books-en'){
        const lang = document.getElementById('in-book-lang').value;
        const name = document.getElementById('in-book-name').value.trim();
        const target = parseInt(document.getElementById('in-book-target').value || 0);
        const raised = parseInt(document.getElementById('in-book-raised').value || 0);
        const subtitle = document.getElementById('in-book-subtitle').value || "";
        if(!name) return alert("× × ×œ×”×–×™×Ÿ ×©× ×¡×¤×¨");

        const newBook = {
          id: `${lang}-${uid()}`,
          name,
          target,
          raised,
          progress: Math.round((raised / Math.max(1, target)) * 100),
          donorsCount: 0,
          identity: { subtitle, author:"", editor:"", series:"", isbn:"", pages:0, trim: lang==='he'?'17Ã—24':'6Ã—9', binding:"", notes:"" },
          printRuns: [],
          donors: []
        };
        store.books[lang].unshift(newBook);
      }

      saveStore();
      hideModal();
      switchTab(currentActiveTab, { pushHistory:false });
      showNotification('×”× ×ª×•× ×™× × ×©××¨×• ×‘××¢×¨×›×ª! âœ¨');
    }

    function hideModal() {
      document.getElementById('modal').classList.add('hidden');
      document.getElementById('btn-submit').style.display = 'inline-block';
      document.getElementById('btn-submit').onclick = processSubmit;
    }

    // =========================
    // UI: NOTIFICATION
    // =========================
    function showNotification(msg) {
      const n = document.createElement('div');
      n.className = 'fixed top-10 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-8 py-3 rounded-lg shadow-2xl z-50 font-bold';
      n.innerHTML = `<i class="fas fa-check-circle ml-2"></i> ${msg}`;
      document.body.appendChild(n);
      setTimeout(() => {
        n.style.opacity = '0';
        n.style.transition = 'opacity 0.3s';
        setTimeout(() => n.remove(), 300);
      }, 2500);
    }

    // =========================
    // SAFETY: ESCAPE HTML in inputs
    // =========================
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // INIT
    window.onload = () => {
      setAddButtonText();
      switchTab('tasks', { pushHistory:false });
      saveStore(); // ×œ×©××•×¨ ×’× ×‘×¨×™×¦×” ×¨××©×•× ×” ×›×“×™ ×œ×™×™×¦×‘
    };
  </script>
</body>
</html>
